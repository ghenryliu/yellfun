function ArrayList(){this.count=0,this.head=new ArrayListNode(null),this.tail=new ArrayListNode(null),this.head.next=this.tail,this.tail.prev=this.head}function ArrayListNode(t){this.next=null,this.prev=null,this.value=t}function ArrayListIter(t,e){this.head=t,this.tail=e,this.cursor=t}function IndexMinPQ(t){this.size=t,this.count=0,this.pq=new Array(t+1),this.qp=new Array(t+1),this.keys=new Array(t+1);for(var e=0;e<=this.size;e++)this.qp[e]=-1,this.keys[e]=Number.MAX_VALUE}function Region(t,e,i,r){this.id=t,this.matRegion=YFM.Math.Matrix.mat(),this.glCanvas=e,this.gl=YFM.WebGL.setupWebGL(e),this.gl.viewport(0,0,e.width,e.height),this.gl.clearColor(.9,.9,.9,1),YFM.gGL=this.gl,this.hh=e.height/2,this.hw=e.width/2,this.tqct=new TextBlockQuickCheckTree(i.width,i.height),this.txtCanvas=i,this.ctx2d=i.getContext("2d"),this.ctx2d.font="24px Microsoft YaHei",this.ctx2d.fillStyle="#FF0000",this.ctx2d.textAlign="center",this.ctx2d.textBaseline="middle",this.fontHeight=this._determineFontHeight("font: "+this.ctx2d.font+";"),this.camera=new DeviceOrientationCamera,this.camera.setPerspective(60,e.width/e.height,60,2e4),this.camera.setLookOffset(0,0,-400),this.orthMat=YFM.Math.Matrix.orthographic(-e.width/2,e.width/2,-e.height/2,e.height/2,-1,1),this.renderParam={projMat:null,viewMat:null,vrMat:null,bivrMat:null,pvrMat:null},this.listener=r,this.floors=[],this.baseColorShader=new BaseColorProgram(this.gl),this.basePhongShader=new BasePhongProgram(this.gl),this.selectColorShader=new SelectColorProgram(this.gl),this.regionPhongShader=new RegionPhongProgram(this.gl),this.billboardIconShader=new BillboardIconProgram(this.gl),this.marker2DShader=new Marker2DProgram(this.gl),this.color2DShader=new Color2DProgram(this.gl),this.pointSpiritShader=new PointSpiritProgram(this.gl),this.panoramaShader=new RawPanoramaProgram(this.gl),this.modelPhongShader=new ModelPhongProgram(this.gl),this.maxSize=0,this.vPitch=0,this.displayFloorIndex=-1;var s=this;this.touchMgr=new RegionTouchMgr(this.camera,i,this.ctx2d,this,{onClick:function(t,e){s.listener&&s.listener.onClick&&s.listener.onClick(t,e)},onDClick:function(t,e){s.listener&&s.listener.onDClick&&s.listener.onDClick(t,e)},on2FClick:function(t,e){s.listener&&s.listener.on2FClick&&s.listener.on2FClick(t,e)},onLongPressUp:function(t,e){s.listener&&s.listener.onLongPressUp&&s.listener.onLongPressUp(t,e)},onScroll:function(t,e){s.listener&&s.listener.onScroll&&s.listener.onScroll(t,e)}}),this.animMgr=new AnimationMgr(this,this.camera,this.touchMgr,{onAnimStart:function(t){s.listener&&s.listener.onAnimStart(t)},onAnimFinish:function(t){s.listener&&s.listener.onAnimFinish(t)},onAnimCancle:function(t){s.listener&&s.listener.onAnimCancel(t)}}),this.panorama=new RawPanorama(this.gl,this),this.locMarker=new RegionLocMarker(this.gl,20,2152900137,3992977408,this),this.route=new RegionRoute(this.gl,5,4278237951,4278237951,this),this.frustum=new FrustumWorldSpace,this.texturePool=new TexturePool(this.gl),this.extrudeLightNormal=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(.5,.5,1)),this.extrudeLightOver=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(0,1,1)),this.extrudeLight=this.extrudeLightNormal,this.overlook=!1,this.drawUnitTextAlways=!1,this.status=YFM.Map.STATUS_TOUCH,this.listener&&this.listener.onStatusChange(this.status)}function RegionLocMarker(t,e,i,r,s){var o=YFM.Math.Vector,h=YFM.WebGL.Color;this.gl=t,this.size=e,this.faceColor=o.vec(h.hexColorRed(i),h.hexColorGreen(i),h.hexColorBlue(i),h.hexColorAlpha(i)),this.lineColor=o.vec(h.hexColorRed(r),h.hexColorGreen(r),h.hexColorBlue(r),h.hexColorAlpha(r)),this.region=s,this.waveRadius=o.vec(12,12),this.waveMax=48,this.waveMin=12,this.waveStep=(this.waveMax-this.waveMin)/56,this.locMarkerTexName=null,this.locMarker=null,this.angle=0,this.regionLoc=YFM.Math.Vector.pos(0,0,0),this.floorLoc={floor:-1,x:0,y:0},this.anim={floor:0,dist:.1,flag:!1,mover:new Mover(0,0,0),target:null},this._init(t,e)}function RegionTouchMgr(t,e,i,r,s){function o(t){if(a.enable)switch(t.preventDefault(),a._updateEventLayerPos(t),t.type){case"touchstart":a.strategy.touchDown(t);break;case"touchmove":a.strategy.touchMove(t);break;case"touchend":a.strategy.touchUp(t);break;case"touchcancel":a.strategy.touchCancel(t)}}function h(t){if(a.enable)switch(t.preventDefault(),t.type){case"mousedown":a._updateEventLayerPos(t),a.strategy_desktop.mouseDown(t);break;case"mouseup":a._updateEventLayerPos(t),a.strategy_desktop.mouseUp(t);break;case"mouseleave":a._updateEventLayerPos(t),a.strategy_desktop.mouseLeave(t);case"mousemove":a._updateEventLayerPos(t),a.strategy_desktop.mouseMove(t);break;case"mousewheel":a._updateEventLayerPos(t),a.strategy_desktop.mouseWheel(t);break;case"keypress":a.strategy_desktop.keyPress(t)}}this.hangUp=!1,this.camera=t,this.canvas=e,this.ctx2d=i,this.region=r,this.listener=s,this.touchFloorIndex=-1,this.focusFloorDirty=!0,this.enable=!0,this.isMobile=this._isMobileBrowser(),this.uiScaleRate=1,this.overlook=!1,this.longPressFlag=!1,this.touchRec={savedmat:YFM.Math.Matrix.matClone(r._getRegionMat()),pitchCnt:0,degree:0,screenSpacing:0,viewSpacing:0,radius0x:0,radius0y:0,layer0x:0,layer0y:0,layer1x:0,layer1y:0,dy0:0,dy1:0,start0x:0,start0y:0,start1x:0,start1y:0,pre0y:0,pre1y:0,midX:0,midY:0},this.planeRec={planeHeight:0,midpos:null,start0:null,start1:null,prev:null,translateX:0,translateY:0,firstAngle:0},this.viewZoom={max:3e3,min:150};var a=this;this.strategy_desktop={timeStampPrev:0,timeStampCur:0,clickFlag:!1,pitchLock:!1,rotateLock:!1,zoomLock:!1,zoomTarget:null,deltaPitch:0,deltaAngle:0,mousePressed:!1,mouseDown:function(t){this.timeStampPrev=this.timeStampCur,this.timeStampCur=(new Date).getTime(),a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y),a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0,this.mousePressed=!0,this.rotateLock=!1,this.pitchLock=!1,this.zoomLock=!1},mouseUp:function(t){var e=(new Date).getTime(),i=a.planeRec.translateX,r=a.planeRec.translateY;if(!(this.rotateLock||this.pitchLock||this.zoomLock)){if(this.clickFlag){var s=e-this.timeStampPrev;i*i+r*r<100&&s<200&&a._onDClick(a.touchRec.layer0x,a.touchRec.layer0y),this.clickFlag=!1}else{var o=e-this.timeStampCur;if(i*i+r*r<100)if(o<100){this.clickFlag=!0;var h=this;setTimeout(function(){h.clickFlag&&(h.clickFlag=!1,a._onClick(a.touchRec.layer0x,a.touchRec.layer0y))},200)}else o>800&&a._onLongPressUp(a.touchRec.layer0x,a.touchRec.layer0y)}this.mousePressed=!1,this.deltaAngle=0,this.deltaPitch=0}},mouseLeave:function(t){this.mousePressed=!1,this.deltaAngle=0,this.deltaPitch=0},mouseMove:function(t){if(this.mousePressed&&!this.pitchLock&&!this.rotateLock&&!this.zoomLock&&YFM.Map.STATUS_TOUCH===a.region.getStatus()){var e=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y);a.planeRec.translateX=e[0]-a.planeRec.start0[0],a.planeRec.translateY=e[1]-a.planeRec.start0[1];var i=YFM.Math.Matrix.postTranslate(a.touchRec.savedmat,a.planeRec.translateX,a.planeRec.translateY,0);if(a.region.displayFloorIndex===a.touchFloorIndex&&a._mapConstraint(a.camera.getPVMat(),i))return;a.region._setRegionMat(i),a._onScroll(a.planeRec.translateX,a.planeRec.translateY),a.focusFloorDirty=!0}},mouseWheel:function(t){if(this.zoomLock||(this.zoomLock=!0),this.zoomLock){var e=-t.wheelDelta/2;a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y);var i=a._world_to_view(a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y)),r=YFM.Math.Vector.pos(0,0,0),s=YFM.Math.Vector.sub(r,i),o=YFM.Math.Vector.normalize(s),h=a.camera.getLookOffset();if(e>0){YFM.Math.Vector.norm3(h)>=a.viewZoom.max&&(e=0)}else if(e<0&&(0===a.touchFloorIndex||a.region.displayFloorIndex===a.touchFloorIndex)){var n=YFM.Math.Vector.norm3(s);n<=a.viewZoom.min&&(e=0)}YFM.Math.Vector.scaleTo(o,e),YFM.Math.Vector.subTo(h,o),a.camera.setLookOffset(h[0],h[1],h[2]),a.focusFloorDirty=!0}},keyPress:function(t){if(this.mousePressed){var e=!1,i=!1;if("a"===t.key?(this.deltaAngle+=1,e=!0):"d"===t.key?(this.deltaAngle-=1,e=!0):"w"==t.key?(this.deltaPitch=-1,i=!0):"s"==t.key&&(this.deltaPitch=1,i=!0),!this.rotateLock&&e&&(this.rotateLock=!0,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),this.deltaAngle=0),this.rotateLock){var r=YFM.Math.Matrix.postRotateXY(a.touchRec.savedmat,this.deltaAngle,a.planeRec.start0[0],a.planeRec.start0[1]);if(a._mapConstraint(a.camera.getPVMat(),r))return;a.region._setRegionMat(r),a.focusFloorDirty=!0}if(!this.pitchLock&&i){var s=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y);a.camera.resetLookOffsetTan(),a.region.lookAtWorldLoc(s[0],s[1],s[2]),this.pitchLock=!0}if(this.pitchLock){var o=a.camera.getPitch();o+=this.deltaPitch,o<=-45&&this.deltaPitch<0?o=-45:o>=0&&this.deltaPitch>0?(o=0,a.overlook||(a.region._onOverlook(!0),a.overlook=!0)):o<=0&&this.deltaPitch<0&&a.overlook&&(a.region._onOverlook(!1),a.overlook=!1),a.camera.setPitch(o),a.focusFloorDirty=!0}}}},this.strategy_none={name:"none",timeStampPrev:0,timeStampCur:0,clickFlag:!1,twoFingerClickFlag:!1,timeStampTwoFinger:0,mouseDown:function(t){a._onMouseDown(a.touchRec.layer0x,a.touchRec.layer0y)},touchDown:function(t){this.timeStampPrev=this.timeStampCur,this.timeStampCur=(new Date).getTime(),a.longPressFlag=!1,1==t.touches.length?(a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y),a.hangUp=!1,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.touchRec.radius0x=t.touches[0].radiusX,a.touchRec.radius0y=t.touches[0].radiusY,a.planeRec.prev=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0):t.touches.length>1&&(this.startTime=t.timeStamp,a.planeRec.planeHeight=a._touch_plane_height(a.touchRec.layer0x,a.touchRec.layer0y),a.hangUp=!1,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.touchRec.radius0x=t.touches[0].radiusX,a.touchRec.radius0y=t.touches[0].radiusY,a.planeRec.prev=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0,a.touchRec.start1x=a.touchRec.layer1x,a.touchRec.start1y=a.touchRec.layer1y,a.planeRec.start1=a._pos_in_world_space(a.touchRec.layer1x,a.touchRec.layer1y),a.touchRec.screenSpacing=a._spacingScreenSpace(a.touchRec.start0x,a.touchRec.start0y,a.touchRec.start1x,a.touchRec.start1y),a.touchRec.viewSpacing=a._spacingViewSpace(a.touchRec.start0x,a.touchRec.start0y,a.touchRec.start1x,a.touchRec.start1y).spacing,a.planeRec.midpos=a._midpoint(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),a.planeRec.firstAngle=a._calc_angle(t),a.strategy=a.strategy_multi)},touchMove:function(t){var e,i;e=a.touchRec.layer0x-a.touchRec.start0x,i=a.touchRec.layer0y-a.touchRec.start0y,1==t.touches.length&&e*e+i*i>100&&(a.strategy=a.strategy_scroll)},touchUp:function(t){var e=(new Date).getTime();if(this.clickFlag){e-this.timeStampPrev<300&&a._onDClick(a.touchRec.start0x,a.touchRec.start0y),this.clickFlag=!1}else{var i=e-this.timeStampCur;if(i<100){this.clickFlag=!0;var r=this;setTimeout(function(){r.clickFlag&&(r.clickFlag=!1,r.twoFingerClickFlag?r.twoFingerClickFlag=!1:a._onClick(a.touchRec.start0x,a.touchRec.start0y))},300)}else i>800&&(a.longPressFlag||a._onLongPressUp(a.touchRec.start0x,a.touchRec.start0y))}0==t.touches.length&&(a.hangUp=!1)},touchCancel:function(t){a.hangUp=!1}},this.strategy_multi={name:"multi",mouseDown:function(t){a._onMouseDown(a.touchRec.layer0x,a.touchRec.layer0y)},touchDown:function(t){},touchMove:function(t){a.touchRec.pitchCnt=0,a.strategy=a.strategy_rotate},touchUp:function(t){a.hangUp=!1,(new Date).getTime()-a.strategy_none.timeStampCur<100&&(a.touchRec.screenSpacing<300&&a._on2FClick(a.touchRec.start0x,a.touchRec.start0y),a.strategy_none.twoFingerClickFlag=!0),a.strategy=a.strategy_none},touchCancel:function(t){a.strategy=a.strategy_none,a.hangUp=!1}},this.strategy_scroll={name:"scroll",mouseDown:function(t){a._onMouseDown(a.touchRec.layer0x,a.touchRec.layer0y)},touchDown:function(t){t.touches.length>1&&(a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.touchRec.start1x=a.touchRec.layer1x,a.touchRec.start1y=a.touchRec.layer1y,a.touchRec.screenSpacing=a._spacingScreenSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),a.touchRec.viewSpacing=a._spacingViewSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y).spacing,a.planeRec.midpos=a._midpoint(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),a.planeRec.firstAngle=a._calc_angle(t),a.strategy=a.strategy_multi)},touchMove:function(t){if(YFM.Map.STATUS_TOUCH===a.region.getStatus()){var e=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y);a.planeRec.translateX=e[0]-a.planeRec.start0[0],a.planeRec.translateY=e[1]-a.planeRec.start0[1],a.planeRec.prev=e;var i=YFM.Math.Matrix.postTranslate(a.touchRec.savedmat,a.planeRec.translateX,a.planeRec.translateY,0);if(a.region.displayFloorIndex===a.touchFloorIndex){var r,s,o,h,n,u,l,c,M=YFM.Math.Matrix,g=YFM.Math.Vector;r=g.pos(0,0,-1),s=g.pos(0,0,1),n=M.mul(a.camera.getPVMat(),a.region.matRegion),u=M.invert(n),o=M.mulVec(u,r),h=M.mulVec(u,s),o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],h[0]/=h[3],h[1]/=h[3],h[2]/=h[3],h[3]/=h[3],l=YFM.Math.Line.linePP(o,h),n=M.mul(a.camera.getPVMat(),i),u=M.invert(n),o=M.mulVec(u,r),h=M.mulVec(u,s),o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],h[0]/=h[3],h[1]/=h[3],h[2]/=h[3],h[3]/=h[3],c=YFM.Math.Line.linePP(o,h);var d=a.region.floors[a.touchFloorIndex],f=d.intersectionLine(l);if(d.intersectionLine(c)<f)return}a.region._setRegionMat(i),a._onScroll(a.planeRec.translateX,a.planeRec.translateY),a.focusFloorDirty=!0}},touchUp:function(t){var e=(new Date).getTime();a.strategy_none.timeStampCur;a.hangUp=!1,a.strategy=a.strategy_none,t.touches.length},touchCancel:function(t){a.hangUp=!1,a.strategy=a.strategy_none}},this.strategy_rotate={name:"rotate",mouseDown:function(t){},touchDown:function(t){},touchMove:function(t){var e,i=a.camera.getPVMat();if(!(a.hangUp||t.touches.length<2)){if(YFM.Map.STATUS_TOUCH!==a.region.getStatus()){var r=a._spacingScreenSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),s=a.touchRec.screenSpacing-r,o=-a.camera.getLookOffsetNormal();return o+=s/20,o>a.viewZoom.max?o=a.viewZoom.max:o<a.viewZoom.min&&(o=a.viewZoom.min),void a.camera.setLookOffset(0,0,-o)}var h=a.touchRec.layer0y-a.touchRec.start0y;if(h*(a.touchRec.layer1y-a.touchRec.start1y)>0){var s=h/256,n=a.camera.getPitch();n+=s,n<=-45&&s<0?n=-45:n>=0&&s>0?(n=0,a.overlook||(a.region._onOverlook(!0),a.overlook=!0)):n<=0&&s<0&&a.overlook&&(a.region._onOverlook(!1),a.overlook=!1),e=a.camera.getPitch(),a.camera.setPitch(n)}var r=a._spacingScreenSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y);if(!(r<200)){var u=a._spacingViewSpace(a.touchRec.layer0x,a.touchRec.layer0y,a.touchRec.layer1x,a.touchRec.layer1y),l=a._calc_angle(t),c=l-a.planeRec.firstAngle,M=YFM.Math.Matrix.postRotateXY(a.touchRec.savedmat,c,a.planeRec.midpos[0],a.planeRec.midpos[1],!0),g=(a.touchRec.viewSpacing-u.spacing)/2;g<0&&u.z<0&&u.z>-20&&(g=-30);var d=a._world_to_view(a.planeRec.midpos),f=YFM.Math.Vector.pos(0,0,0),p=YFM.Math.Vector.sub(f,d),s=YFM.Math.Vector.normalize(p),m=a.camera.getLookOffset();if(g>0){YFM.Math.Vector.norm3(m)>=a.viewZoom.max&&(g=0)}else if(g<0&&(0===a.touchFloorIndex||a.region.displayFloorIndex===a.touchFloorIndex)){var v=YFM.Math.Vector.norm3(p);v<=a.viewZoom.min&&(g=0)}YFM.Math.Vector.scaleTo(s,g);var F=YFM.Math.Vector.sub(m,s);if(a.camera.setLookOffset(F[0],F[1],F[2]),a._mapConstraint(i,M))return a.camera.setLookOffset(m[0],m[1],m[2]),void(e&&a.camera.setPitch(e));a.region._setRegionMat(M),a.focusFloorDirty=!0}}},touchUp:function(t){if(t.touches.length>1)a.hangUp=!0;else if(t.touches.length>=0){a.hangUp=!1,a.strategy=a.strategy_none,a.longPressFlag=!0,a.touchRec.savedmat=YFM.Math.Matrix.matClone(a.region._getRegionMat()),a.touchRec.start0x=a.touchRec.layer0x,a.touchRec.start0y=a.touchRec.layer0y,a.planeRec.prev=a.planeRec.start0=a._pos_in_world_space(a.touchRec.layer0x,a.touchRec.layer0y),a.planeRec.translateX=0,a.planeRec.translateY=0;var e=(new Date).getTime(),i=e-a.strategy_none.timeStampCur;i<100&&(a.touchRec.screenSpacing<300&&a._on2FClick(a.touchRec.start0x,a.touchRec.start0y),a.strategy_none.twoFingerClickFlag=!0)}else a.strategy=a.strategy_none},touchCancel:function(t){a.hangUp=!1,a.strategy=a.strategy_none}},this.strategy=this.strategy_none,this.isMobile?(e.addEventListener("touchstart",o,!1),e.addEventListener("touchmove",o,!1),e.addEventListener("touchend",o,!1),e.addEventListener("touchcancel",o,!1)):(document.onkeypress=h,e.addEventListener("mousedown",h,!1),e.addEventListener("mouseup",h,!1),e.addEventListener("mousemove",h,!1),e.addEventListener("mouseleave",h,!1),e.addEventListener("mousewheel",h,!1))}function AnimationMgr(t,e,i,r){this.region=t,this.camera=e,this.touchMgr=i,this.listener=r,this.seq=new ArrayList,this.mover=new Mover,this.mover.setMaxForce(16),this.mover.setMaxSpeed(16),this.current=null}function Animation(t,e,i){this.tag=t,this.type=e,this.frame=i,this.step=0}function RegionRoute(t,e,i,r,s){this.gl=t,this.size=e,this.routeColor=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(i),YFM.WebGL.Color.hexColorGreen(i),YFM.WebGL.Color.hexColorBlue(i)),this.tailColor=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(r),YFM.WebGL.Color.hexColorGreen(r),YFM.WebGL.Color.hexColorBlue(r)),this.region=s,this.routeVBO=null,this.routeBufferSize=0,this.routeVarray=[],this.light=YFM.Math.Vector.vec(0,0,1),this.floorRouteList=null,this.obb=null,this._initTail(),this._initRouteShape(),this.tailSize=3.2,this.updateNSFlag=!0,this.naviStatus={startInstance:0,projection:null,validate:!1,projDist:0,goalDist:0,serialDist:0,nextSerialDist:0,azimuth:0,sug:YFM.Map.Navigate.Suggestion.NONE,nextSug:YFM.Map.Navigate.NextSuggestion.NONE}}function RouteSeg(t,e){this.start=t,this.end=e,this.segVec=YFM.Math.Vector.sub(this.end,this.start),this.lenSQ=YFM.Math.Vector.dot3(this.segVec,this.segVec),this.len=Math.sqrt(this.lenSQ),this.azimuth=this._makeAzimuth(),this.startInstance=0}function FloorRoute(t,e,i,r){this.size=t,this.floor=e,this.region=i,this.route=r,this.segList=[],this.lastSegVec=null,this.implicitRec={maxT:0,maxPos:null}}function Floor(t,e,i,r,s,o,h){this.loaded=!1,this.gl=t,this.id=e,this.deflection=null!=r?r:0,this.region=s,this.index=o,this.loadListener=h,this.mapWidth=0,this.mapHeight=0,this.regUnit=/^unit/,this.regIcon=/^icon/g,this.extrude=new FloorExtrude(t,YFM.Map.DEFAULT_EXTRUDE_HEIGHT),this.quickPolygon=new FloorQuickPolygon(t,YFM.Map.DEFAULT_QUICKPOLYGON_HEIGHT),this.quadTree=null,this.icons=null,this.models=null,this.markers=new FloorMarkers(this.gl,this.region,this),this.quickIcons=new FloorQuickIcons(this.gl,this.region,this),this.dummyUnitList=[],this.BBCheck=-1;var a=this;if(null===this.loadListener)a._load_svg(a,i);else{var n=new XMLHttpRequest;n.open("GET",i,!0),n.responseType="text",n.onload=function(t){200==this.status?(console.log("-ajax request ok"),a._load_svg(a,this.response),a.loadListener.onLoadFinish(a)):(a.loadListener.onLoadFailed(a,this.status),console.log("-ajax error:%d",this.status))},n.send()}}function FloorExtrude(t,e,i){this.gl=t,this.height=e||10,this.color=i,this.extrudeTopVBO=null,this.extrudeTopSize=0,this.extrudeTopVarray=[],this.extrudeSideVBO=null,this.extrudeSideSize=0,this.extrudeSideVarray=[],this.borderVBO=null,this.borderSize=0,this.borderVarray=[],this.borderNormal=YFM.Math.Vector.vec(0,0,1)}function FloorIcons(t,e,i){this.gl=t,this.region=e,this.floor=i,this.quadTree=new FloorQuadTree(i,100),this.iconTex=null;var r=[];r.push(YFM.Math.Vector.pos(-1,-1,0)),r.push(YFM.Math.Vector.pos(1,-1,0)),r.push(YFM.Math.Vector.pos(1,1,0)),r.push(YFM.Math.Vector.pos(-1,1,0));var s,o=[];for(s=0;s<16;s++)this._calcTexCoords(o,r,s);this.quadVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quadVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(o,3),this.gl.STATIC_DRAW),this.quadBufferSize=o.length/2}function FloorQuickPolygon(t,e){this.gl=t,this.height=e||12,this.quickPolygonVBO=null,this.quickPolygonSize=0,this.quickPolygonVarray=[],this.loaded=!1}function FloorQuickIcons(t,e,i,r){this.gl=t,this.region=e,this.floor=i,this.height=r||10,this.tex=null,this.texName=null,this.pointsVBO=null,this.pointsSize=0,this.pointsVarray=[]}function FloorMarkers(t,e,i){this.gl=t,this.region=e,this.floor=i,this.markerArray=[],this.markerIMinPQ=new IndexMinPQ(32),this.markerSorted=[],this.light=YFM.Math.Vector.vec(.5,.5,1),this.orgPos=YFM.Math.Vector.pos(0,0,0),null===FloorMarkers.prototype.quadVBO&&this._initQuad(t)}function FloorModels(t,e,i,r){this.gl=t,this.region=e,this.floor=i,this.vPitch=r,this.quadTree=new FloorQuadTree(i,r)}function Euler(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.order=r||Euler.DefaultOrder}function Quaternion(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==r?r:1}function FrustumWorldSpace(){this.near=YFM.Math.Vector.vec(),this.far=YFM.Math.Vector.vec(),this.left=YFM.Math.Vector.vec(),this.right=YFM.Math.Vector.vec(),this.top=YFM.Math.Vector.vec(),this.bottom=YFM.Math.Vector.vec()}function OBB(t){this.isOBB=!0;var e,i;e=YFM.Math.Matrix.covariance3x3(t),i=YFM.Math.Matrix.eig3x3(e),this.t=YFM.Math.Vector.vec(i.vec[0],i.vec[1],i.vec[2]),this.s=YFM.Math.Vector.vec(i.vec[3],i.vec[4],i.vec[5]),this.r=YFM.Math.Vector.vec(i.vec[6],i.vec[7],i.vec[8]),this._calc_bounding(t)}function TextBlockQuickCheckTree(t,e){this.root=new AABBNode(this,"0",0,0,t,e),this.blockPool=[],this.blockList=[]}function AABBNode(t,e,i,r,s,o){this.tree=t,this.mask=e,this.rect=[i,r,s,o],this.objList=[],this.level<2&&this._splite()}function FloorQuadTree(t,e){this.floor=t,this.root=new FloorQuadNode(null,t,0,t.mapWidth,0,t.mapHeight,e,"0",0),this.objMap={}}function FloorQuadNode(t,e,i,r,s,o,h,a,n){this.parentNode=t,this.floor=e,this.xmin=i,this.xmax=r,this.ymin=s,this.ymax=o,this.height=h,this.mask=a,this.level=n;var u,l,c,M,g=[];u=e.floorPos2Region(i,s),l=e.floorPos2Region(r,s),c=e.floorPos2Region(r,o),M=e.floorPos2Region(i,o),g.push(YFM.Math.Vector.pos(u[0],u[1],u[2]-100)),g.push(YFM.Math.Vector.pos(l[0],l[1],l[2]-100)),g.push(YFM.Math.Vector.pos(c[0],c[1],c[2]-100)),g.push(YFM.Math.Vector.pos(M[0],M[1],M[2]-100)),g.push(YFM.Math.Vector.pos(u[0],u[1],u[2]+h)),g.push(YFM.Math.Vector.pos(l[0],l[1],l[2]+h)),g.push(YFM.Math.Vector.pos(c[0],c[1],c[2]+h)),g.push(YFM.Math.Vector.pos(M[0],M[1],M[2]+h)),this.obb=new OBB(g),this.objectList=[],this.children=new Array(null,null,null,null),this.splited=!1}function TextBlockQuickCheckTree(t,e){this.root=new AABBNode(this,"0",0,0,t,e),this.blockPool=[],this.blockList=[]}function AABBNode(t,e,i,r,s,o){this.tree=t,this.mask=e,this.rect=[i,r,s,o],this.objList=[],this.level<2&&this._splite()}function PlanePolygon(t){this.barrier=[],this.plane=this._makePlanePts(t)}function Mover(t,e,i){this.mass=this.DEFAULT_MASS,this.maxForce=this.DEFAULT_MAX_FORCE,this.maxSpeed=this.DEFAULT_MAX_SPEED,this.location=YFM.Math.Vector.pos(t||0,e||0,i||0),this.velocity=YFM.Math.Vector.vec(0,0,0),this.acceleration=YFM.Math.Vector.vec(0,0,0)}function MeshBuffer(t){this.gl=t,this.attributes={}}function TetrahedronMesh(t,e){this._init(t,e)}function HexahedronMesh(t,e){this._init(t,e)}function OctahedronMesh(t,e){this._init(t,e)}function DodecahedronMesh(t,e){this._init(t,e)}function IcosahedronMesh(t,e){this._init(t,e)}function ObjModel(t){this.region=t,this.floor=null,this.obb=null,this.gl=t.gl,this.objects=[],this.texturePool=t.texturePool,this.modelMatrix=YFM.Math.Matrix.mat(),this.baseUrl=null,this.hasMaterials=!1,this.materials={}}function MtlItem(){this.Ns=32,this.Ka=YFM.Math.Vector.pos(),this.Kd=YFM.Math.Vector.pos(),this.Ks=YFM.Math.Vector.pos(),this.mapKd=null}function RawPanorama(t,e){this.gl=t,this.region=e,this.cubeVBO=null,this.cubeSize=0,this.cubeMap=null,this._initCube(),this.modelMat=YFM.Math.Matrix.rotate3d(90,1,0,0)}function BaseColorProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight")}function BasePhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aColor=t.getAttribLocation(this.program,"aColor"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uMapHeight=t.getUniformLocation(this.program,"uMapHeight"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos"),this.uLighting=t.getUniformLocation(this.program,"uLighting")}function RegionPhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos")}function SelectColorProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uColor=t.getUniformLocation(this.program,"uColor")}function BillboardIconProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uiViewMat=t.getUniformLocation(this.program,"uiViewMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function Marker2DProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function Color2DProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function PointSpiritProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat")}function RawPanoramaProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjectionMat"),this.uTexMap=t.getUniformLocation(this.program,"uTexMap")}function ModelPhongProgram(t){this.init=!1,this.gl=t,this.program=YFM.WebGL.makeShader(t,this.vshader,this.fshader),this.aPosition=t.getAttribLocation(this.program,"aPosition"),this.aNormal=t.getAttribLocation(this.program,"aNormal"),this.aTexCoord=t.getAttribLocation(this.program,"aTexCoord"),this.uNs=t.getUniformLocation(this.program,"uNs"),this.uKa=t.getUniformLocation(this.program,"uKa"),this.uKd=t.getUniformLocation(this.program,"uKd"),this.uKs=t.getUniformLocation(this.program,"uKs"),this.uTexFlag=t.getUniformLocation(this.program,"uTexFlag"),this.uTex=t.getUniformLocation(this.program,"uTex"),this.uColorFlag=t.getUniformLocation(this.program,"uColorFlag"),this.uColor=t.getUniformLocation(this.program,"uColor"),this.uModelMat=t.getUniformLocation(this.program,"uModelMat"),this.uFloorMat=t.getUniformLocation(this.program,"uFloorMat"),this.uRegionMat=t.getUniformLocation(this.program,"uRegionMat"),this.uViewMat=t.getUniformLocation(this.program,"uViewMat"),this.uProjectionMat=t.getUniformLocation(this.program,"uProjMat"),this.uNormalMat=t.getUniformLocation(this.program,"uNormalMat"),this.uLightPos=t.getUniformLocation(this.program,"uLightPos"),this.defaultNs=32,this.defaultColor=YFM.Math.Vector.pos(1,1,1),this.defaultKa=YFM.Math.Vector.pos(.3,.3,.3),this.defaultKd=YFM.Math.Vector.pos(1,1,1),this.defaultKs=YFM.Math.Vector.pos(.1,.1,.1)}function DeviceOrientationCamera(){this.dirty=!0,this.mat_base_view=YFM.Math.Matrix.mat(),this.mat_t_view=YFM.Math.Matrix.mat(),this.mat_view=YFM.Math.Matrix.mat(),this.mat_projection=YFM.Math.Matrix.mat(),this.mat_pv=YFM.Math.Matrix.mat(),this.mat_ipv=YFM.Math.Matrix.mat(),this.mat_iv=YFM.Math.Matrix.mat(),this.quaternion=new Quaternion,this.pitchEnable=!0,this.pitch=this.DEFAULT_PITCH,this.lookAt=YFM.Math.Vector.vec(0,0,0),this.lookOffset=YFM.Math.Vector.vec(0,0,-400),this.zee=YFM.Math.Vector.vec(0,0,1),this.q0=new Quaternion(Math.sqrt(.5),0,0,Math.sqrt(.5)),this.q1=new Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this.q2=new Quaternion,this.enabled=!1,this.deviceOrientation=null,this.screenOrientation=0,this.roll=0,this.alphaOffsetAngle=0;var t=this,e=function(e){t.deviceOrientation=e,t.dirty=!0},i=function(){t.screenOrientation=window.orientation||0};this.connect=function(){window.addEventListener("deviceorientation",e,!1),window.addEventListener("orientationchange",i,!1),t.enabled=!0,t.pitchEnable=!1,t.dirty=!0},this.disconnect=function(){window.removeEventListener("orientationchange",i,!1),window.removeEventListener("deviceorientation",e,!1),t.enabled=!1,t.deviceOrientation=null,t.pitchEnable=!0,t.quaternion=new Quaternion,t.dirty=!0,
t.roll=0},this.ldsN=4,this.ldsIndex=0,this.rgss=[],this.rgss.push(YFM.Math.Vector.vec(0,.25)),this.rgss.push(YFM.Math.Vector.vec(.5,0)),this.rgss.push(YFM.Math.Vector.vec(.75,.5)),this.rgss.push(YFM.Math.Vector.vec(.25,.75))}function TexturePool(t){this.gl=t,this.pool={}}function TextureWrap(t,e,i){this.name=t,this.url=e,this.img=i,this.w=0,this.h=0}var YFM={};ArrayList.prototype={constructor:ArrayList,getIter:function(){return new ArrayListIter(this.head,this.tail)},size:function(){return this.count},addHigh:function(t){var e=new ArrayListNode(t);e.prev=this.tail.prev,e.next=this.tail,this.tail.prev.next=e,this.tail.prev=e,this.count+=1},addLow:function(t){var e=new ArrayListNode(t);e.prev=this.head,e.next=this.head.next,this.head.next.prev=e,this.head.next=e,this.count+=1},clean:function(){this.count=0,this.head=new ArrayListNode(null),this.tail=new ArrayListNode(null),this.head.next=this.tail,this.tail.prev=this.head},remove:function(t){var e,i,r;if(t<-this.count||t>this.count-1)e=null;else if(t>=0){for(r=0,i=this.head.next;r<t;r++)i=i.next;e=i.value,i.prev.next=i.next,i.next.prev=i.prev,this.count-=1}else if(t<0){for(r=t,i=this.tail.prev;r<0;r++)i=i.prev;e=i.value,i.prev.next=i.next,i.next.prev=i.prev,this.count-=1}return e},removeHigh:function(){var t;return this.count>=1?(t=this.tail.prev.value,this.tail.prev.prev.next=this.tail,this.tail.prev=this.tail.prev.prev,this.count-=1):t=null,t},removeLow:function(){var t;return this.count>=1?(t=this.head.next.value,this.head.next.next.prev=this.head,this.head.next=this.head.next.next,this.count-=1):t=null,t},get:function(t){var e,i,r;if(t<-this.count||t>this.count-1)throw new Error("Access out of range");if(t>=0){for(r=0,i=this.head.next;r<t;r++)i=i.next;e=i.value}else if(t<0){for(r=t,i=this.tail.prev;r<0;r++)i=i.prev;e=i.value}return e},put:function(t,e){var i,r;if(t<-this.count||t>this.count-1)throw new Error("Access out of range");if(t>=0){for(r=0,i=this.head.next;r<t;r++)i=i.next;i.value=e}else if(t<0){for(r=t,i=this.tail.prev;r<0;r++)i=i.prev;i.value=e}}},ArrayListIter.prototype={constructor:ArrayListIter,hasNext:function(){return this.cursor.next!=this.tail},getNext:function(){var t=this.cursor.next.value;return this.cursor=this.cursor.next,t}},IndexMinPQ.prototype={constructor:IndexMinPQ,clean:function(){this.count=0;for(var t=0;t<=this.size;t++)this.qp[t]=-1,this.keys[t]=Number.MAX_VALUE},setSize:function(t){var e,i;if((e=t-this.size)<0)for(i=e;i<0;i++)this.pq.pop(),this.qp.pop(),this.keys.pop();else if(e>0)for(i=0;i<e;i++)this.pq.push(null),this.qp.push(null),this.keys.push(null);this.size=t,this.clean()},getSize:function(){return this.size},getCount:function(){return this.count},changeKey:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.changeKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.changeKey, do not contains index:"+t);this.keys[t]=e,this._swim(this.qp[t]),this._sink(this.qp[t])},decreaseKey:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.decreaseKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.decreaseKey, do not contains index:"+t);if(this.keys[t]<=e)throw new Error("IndexMinPQ.decreaseKey, key[i] <= key");this.keys[t]=e,this._swim(this.qp[t])},increaseKey:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.increaseKey, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.increaseKey, do not contains index:"+t);if(this.keys[t]>=e)throw new Error("IndexMinPQ.increaseKey, key[i] <= key");this.keys[t]=e,this._swim(this.qp[t])},deleteMin:function(){if(this.count<=0)throw new Error("IndexMinPQ.deleteMin, empty content");var t;return t=this.pq[1],this._exch(1,this.count),this.count-=1,this._sink(1),this.qp[t]=-1,this.keys[this.pq[this.count+1]]=Number.MAX_VALUE,this.pq[this.count+1]=-1,t},delete:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.delete, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.delete, do not contains index:"+t);var e=qp[t];this._exch(e,this.count),this.count-=1,this._swim(e),this._sink(e),this.keys[t]=Number.MAX_VALUE,this.qp[t]=-1},contains:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.countains, out of range index:"+t);return-1!==this.qp[t]},isEmpty:function(){return 0===this.count},keyOf:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ.keyOf, out of range index:"+t);if(!this.contains(t))throw new Error("IndexMinPQ.keyOf, do not contains index:"+t);return this.keys[t]},minIndex:function(){if(this.count<=0)throw new Error("IndexMinPQ.minIndex, empty content");return this.pq[1]},minKey:function(){if(this.count<=0)throw new Error("IndexMinPQ.minKey, empty content");return this.keys[this.pq[1]]},indexAt:function(t){if(t<0||t>this.count)throw new Error("IndexMinPQ.indexAt, out of range pos:"+t);return this.pq[t+1]},insert:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ.insert, out of range index:"+t);if(this.contains(t))throw new Error("IndexMinPQ.insert, do contains index:"+t);this.count+=1,this.qp[t]=this.count,this.pq[this.count]=t,this.keys[t]=e,this._swim(this.count)},_exch:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ._exch, out of range i:"+t);if(e<0||e>this.size)throw new Error("IndexMinPQ._exch, out of range j:"+e);var i=this.pq[t];this.pq[t]=this.pq[e],this.pq[e]=i,this.qp[this.pq[t]]=t,this.qp[this.pq[e]]=e},_greater:function(t,e){if(t<0||t>this.size)throw new Error("IndexMinPQ._greater, out of range i:"+t);if(e<0||e>this.size)throw new Error("IndexMinPQ._greater, out of range j:"+e);return this.keys[this.pq[t]]>this.keys[this.pq[e]]},_sink:function(t){var e;if(t<0||t>this.size)throw new Error("IndexMinPQ._sink, out of range k:"+t);for(;2*t<=this.count&&(e=2*t,e<this.count&&this._greater(e,e+1)&&e++,this._greater(t,e));)this._exch(t,e),t=e},_swim:function(t){if(t<0||t>this.size)throw new Error("IndexMinPQ._swin, out of range k:"+t);for(;t>1;){var e=Math.round(t/2);if(!this._greater(e,t))break;this._exch(t,e),t=e}}},YFM.Map={},YFM.Map.STATUS_TOUCH=0,YFM.Map.STATUS_SENSOR=1,YFM.Map.STATUS_NAVIGATE=2,YFM.Map.STATUS_TRACE=3,YFM.Map.Navigate={},YFM.Map.Navigate.Suggestion={NONE:"none",FRONT:"front",LEFT:"left",BACKWARD:"backward",RIGHT:"right"},YFM.Map.Navigate.NextSuggestion={NONE:"none",FRONT:"front",LEFT:"left",RIGHT:"right",ARRIVE:"arrive"},Region.prototype={constructor:Region,locateLaunch:function(){this.locMarker.locateLaunch()},setLocMarkerParam:function(t,e,i,r){this.locMarker.set2DMarkerParam(t,e,i,r)},setAlwaysDrawUnit:function(t){this.drawUnitTextAlways=t},setUIScaleRate:function(t){this.touchMgr.setUIScaleRate(t)},getId:function(){return this.id},startRender:function(){YFM.gRegion=this,YFM.gRegion._grender()},displayFloor:function(t){if(!(t>=0||t<this.floors.length))throw new Error("Rgeion.js [displayFloor] Floor index out of range:"+t);this.displayFloorIndex=t;var e=this.floors[t].getAspect();this.lookAtMapLoc(t,e.w/2,e.h/2)},displayRegion:function(){this.displayFloorIndex=-1},setFontType:function(t){this.ctx2d.font=t,this.fontHeight=this._determineFontHeight("font: "+this.ctx2d.font+";")},setFontColor:function(t){this.ctx2d.fillStyle=t},setStatus:function(t){if(t!==this.status){switch(t){case YFM.Map.STATUS_TOUCH:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t;break;case YFM.Map.STATUS_SENSOR:YFM.Map.STATUS_SENSOR!==this.status&&this.camera.connect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation();break;case YFM.Map.STATUS_TRACE:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation();break;case YFM.Map.STATUS_NAVIGATE:YFM.Map.STATUS_SENSOR===this.status&&this.camera.disconnect(),this.status=t,this.camera.resetLookOffsetTan(),this.locMarker.updateLocation(),this.locMarker.updateLocation()}this.listener&&this.listener.onStatusChange(this.status)}},getStatus:function(){return this.status},addFloorsURL:function(t){var e,i,r,s=this,o={onLoadFinish:function(t){for(var e=!0,i=0;i<s.floors.length;i++)if(!s.floors[i].isLoaded()){e=!1;break}s.listener&&(s.listener.onLoadFinish(t.id,t.index),e&&(s._restructure(),s.listener.onAllFloorLoadFinish())),e&&s.touchMgr.onRegionLoadFinish()},onLoadFailed:function(t){this.listener&&this.listener.onLoadFailed(t.id,t.index)}};for(i=t.length,r=0;r<i;r++)e=t[r],this.floors.push(new Floor(this.gl,e.id,e.url,e.deflection,this,r,o))},addFloorsSVG:function(t){var e,i,r;for(i=t.length,r=0;r<i;r++)e=t[r],this.floors.push(new Floor(this.gl,e.id,e.svg,e.deflection,this,r,null));this._restructure(),this.listener.onAllFloorLoadFinish(),this.touchMgr.onRegionLoadFinish()},addTexture:function(t,e){this.texturePool.addTexture(t,e)},getTexture:function(t){return this.texturePool.getTexture(t)},getFloorCount:function(){return this.floors.length},getFloorAspect:function(t){return this.floors[t].getAspect()},getFloorLoc:function(){return this.locMarker.getFloorLoc()},getRegionLoc:function(){return this.locMarker.getRegionLoc()},setNavigateProj:function(t){this.route.setUpdateNSFlag(t)},updateNaviStatus:function(t,e){this.route.updateNaviStatus(t,e)},cleanLocation:function(){this.locMarker.cleanLocation()},setLocation:function(t,e,i){this.locMarker.setLocation(t,e,i)},animTo:function(t,e,i){this.locMarker.animTo(t,e,i)},lookAtMapLoc:function(t,e,i){var r=this.floors[t].floorPos2Region(e,i);this.lookAtRegionLoc(r[0],r[1],r[2])},lookAtWorldLoc:function(t,e,i){this.camera.resetLookOffsetTan(),this.camera.setLookAt(t,e,i)},lookAtRegionLoc:function(t,e,i){var r=YFM.Math.Vector.pos(t,e,i),s=YFM.Math.Matrix.mulVec(this.matRegion,r);this.camera.resetLookOffsetTan(),this.camera.setLookAt(s[0],s[1],s[2])},animLookAt:function(t,e,i,r){var s=this.floors[t].floorPos2Region(e,i),o=YFM.Math.Matrix.mulVec(this.matRegion,s);this.animMgr.animLookAt(o,r)},animLookAtWorld:function(t,e){this.animMgr.animLookAt(t,e)},animLookDistance:function(t,e){this.animMgr.animLookDistance(t,e)},getLookDistance:function(){return-this.camera.getLookOffsetNormal()},animLookAzimuth:function(t,e){this.animMgr.animLookAzimuth(t,e)},animPitch:function(t,e){this.animMgr.animPitch(t,e)},overlookMap:function(t){var e=this.floors[t],i=e.floorPos2Region(e.mapWidth/2,e.mapHeight/2),r=YFM.Math.Matrix.mulVec(this.matRegion,i),s=this.camera.getAzimuth(),o=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion),h=-o+s+YFM.Math.deg2Radian(e.deflection),a=e.mapWidth>e.mapHeight?e.mapWidth:e.mapHeight;this.animMgr.animLookAt(r,"overlookMap"),this.animMgr.animLookAzimuth(YFM.Math.radian2Deg(this._clampMinorArc(h)),"overlookMap"),this.animMgr.animLookDistance(a,"overlookMap")},getFloorAngle:function(t){var e=this.floors[t],i=this.camera.getAzimuth(),r=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion),s=-r+i+YFM.Math.deg2Radian(e.deflection);return YFM.Math.radian2Deg(this._clampMinorArc(s))},setRoute:function(t){this.route.setRoute(t)},cleanRoute:function(){this.route.cleanRoute()},overlookRoute:function(){var t=this.route.getRouteCenter();if(null!==t){var e=YFM.Math.Matrix.mulVec(this.matRegion,t),i=this.route.getRouteRAxis(),r=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion),s=this.camera.getAzimuth(),o=this._makeAzimuth(i),h=-r+s+o+Math.PI/2;this.animMgr.animMerge({distance:1.8*this.route.getRouteOBBLength(),azimuth:YFM.Math.radian2Deg(this._clampMinorArc(h)),lookAt:e},null,48)}},getNaviStatus:function(){return this.route.getNaviStatus()},insertUnit:function(t,e,i,r){this.floors[e].insertUnit(t,i,r)},insertModel:function(t,e,i,r,s,o,h){return this.floors[t].insertModel(e,i,r,s,o,h)},removeModel:function(t){var e=this._calcModelFloor(t);return this.floors[e].removeModel(t)},setQuickIconTexture:function(t){for(var e=0;e<this.floors.length;e++)this.floors[e].quickIcons.setTex(t)},addQuickPolygon:function(t,e,i){this.floors[t].quickPolygon.addQuickPolygon(e,i)},buildQuickPolygonAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].quickPolygon.buildQuickPolygon()},buildQuickPolygonFloor:function(t){this.floors[t].quickPolygon.buildQuickPolygon()},cleanQuickPolygonAll:function(){for(var t=0;t<this.floors.length;t++)this.floors[t].quickPolygon.cleanQuickPolygon()},cleanQuickPolygonFloor:function(t){this.floors[t].quickPolygon.cleanQuickPolygon()},addQuickIcon:function(t,e,i){this.floors[t].quickIcons.addPoint(e,i)},buildQuickIcon:function(t){this.floors[t].quickIcons.buildPoints()},cleanQuickIcon:function(t){this.floors[t].quickIcons.clean()},insertGeometryMarker:function(t,e,i,r,s,o,h){return this.floors[r].markers.insertGeometryMarker(t,e,i,s,o,h)},insertTextureMarker:function(t,e,i,r,s,o,h){return this.floors[e].markers.insertTextureMarker(t,i,r,s,o,h)},removeMarker:function(t){var e=this._calcMarkerFloor(t);return null!==this.floors[e].markers.removeMarker(t)},updateMarkerLocation:function(t,e,i,r){var s=-1,o=this._calcMarkerFloor(t),h=this.floors[o].markers.removeMarker(t);return null!==h&&(s=this.floors[e].markers.insertMarker(h,i,r)),s},searchModel:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var r=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchModel(r,!1)}return[]},searchUnit:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var r=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchUnit(r,20,!1)}return[]},searchIcon:function(t,e){var i=this.touchMgr.getFocusFloorIndex();if(-1!=i){var r=this.touchMgr.getTouchRayPlus(t,e);return this.floors[i].searchIcon(r,80,!1)}return[]},searchMarker:function(t,e){for(var i=null,r=Number.MAX_VALUE,s=0;s<this.floors.length;s++)if(-1!==this.floors[s].BBCheck){var o=this.floors[s].markers.findMarker(t,e);console.log("searchMarker floor[%d] visible:",s),console.log(o),null!==o&&r>o.dist&&(i=o,r=o.dist)}else console.log("searchMarker floor[%d] invisible:",s);return null!==i?i.id:-1},getTouchPosMapLoc:function(t,e){return this.touchMgr._screen_to_map(t,e)},getTouchPosWorldLoc:function(t,e){return this.touchMgr._pos_in_world_space(t,e)},regionPos2Screen:function(t){var e=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion),i=YFM.Math.Matrix.mulVec(e,t);return i[0]/=i[3],i[1]/=i[3],i[2]/=i[3],i[3]/=i[3],i[0]=i[0]*this.hw+this.hw,i[1]=-i[1]*this.hh+this.hh,i},floorPos2RegionPos:function(t,e,i){if(t<0||t>=this.floors.length)throw new Error("floor index out of bounds");return this.floors[t].floorPos2Region(e,i)},_onOverlook:function(t){this.overlook=t,this.extrudeLight=t?this.extrudeLightOver:this.extrudeLightNormal},_getRegionMat:function(){return this.matRegion},_setRegionMat:function(t){this.matRegion=t},_traceLoc:function(t,e,i){var r=YFM.Math.Vector.pos(t,e,i),s=YFM.Math.Matrix.mulVec(this.matRegion,r);if(YFM.Map.STATUS_NAVIGATE===this.status){var o=0,h=this.getNaviStatus();if(h.validate){var a=YFM.Math.Matrix.eulerParamExtractZ(this.matRegion);o=h.azimuth+a}this.camera.setLookAtAzimuth(o,s[0],s[1],s[2])}else this.camera.setLookAt(s[0],s[1],s[2])},_getFloorMat:function(t){if(t<0||t>=this.floors.length)throw new Error("floor index out of bounds");return this.floors[t].getFloorMat()},_intersectionLine:function(t){var e,i,r=[];for(e=this.floors.length,i=0;i<e;i++)r.push(this.floors[i].intersectionLine(t));return r},_render:function(){var t,e;t=this.floors.length,this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.animMgr.update(),this._cleanText(),this.tqct.reset(),this.renderParam.projMat=this.camera.getProjectionMat(),this.renderParam.viewMat=this.camera.getViewMat(),this.renderParam.vrMat=YFM.Math.Matrix.mul(this.renderParam.viewMat,this.matRegion),this.renderParam.pvrMat=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.matRegion);var i=YFM.Math.Matrix.matClone(this.renderParam.vrMat);i[12]=0,i[13]=0,i[14]=0;var r=YFM.Math.Matrix.invert(i),s=YFM.Math.Matrix.scale(15,0,0,0);s=YFM.Math.Matrix.postRotate3d(s,this.camera.getRoll()-90,0,0,1),this.renderParam.bivrMat=YFM.Math.Matrix.mul(r,s),this.frustum.update(this.renderParam.pvrMat),this.panoramaShader.useProgram(),this.panoramaShader.setProjectionMatrix(this.renderParam.projMat),this.panoramaShader.setViewMatrix(this.renderParam.viewMat),this.panorama.render(this.panoramaShader,this.matRegion);var o=[];if(-1===this.displayFloorIndex){var h=this.touchMgr.getFocusFloorIndex();for(e=0;e<t;e++){var a=this.floors[e].frustumCheck(this.frustum);this.floors[e].BBCheck=a,this._renderFloor(e,a,h),o.push(a)}}else{for(e=0;e<t;e++)this.floors[e].BBCheck=-1;this.floors[this.displayFloorIndex].BBCheck=1,this._renderFloor(this.displayFloorIndex,a,this.displayFloorIndex)}this.regionPhongShader.useProgram(),this.regionPhongShader.setProjectionMatrix(this.renderParam.projMat),this.regionPhongShader.setViewMatrix(this.renderParam.viewMat),this.regionPhongShader.setRegionMatrix(this.matRegion),this.route.render(this.regionPhongShader,this.renderParam.vrMat);var n=this.frustum.containCheckPoint(this.locMarker.getRegionLoc());if(n&&(this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.color2DShader.useProgram(),this.color2DShader.setProjectionMatrix(this.orthMat)),this.locMarker.render(this.color2DShader,this.marker2DShader,n,this.renderParam.pvrMat),-1===this.displayFloorIndex){var h=this.touchMgr.getFocusFloorIndex();for(e=0;e<t;e++)-1!==o[e]&&this._renderFloor2DMarker(e)}else this._renderFloor2DMarker(this.displayFloorIndex)},_getFloorVOffset:function(t){return t*this.vPitch},_renderFloor2DMarker:function(t,e){this.marker2DShader.useProgram(),this.marker2DShader.setProjectionMatrix(this.orthMat),this.regionPhongShader.useProgram(),this.regionPhongShader.setProjectionMatrix(this.renderParam.projMat),this.regionPhongShader.setViewMatrix(this.renderParam.viewMat),this.regionPhongShader.setRegionMatrix(this.matRegion),this.floors[t].renderMarkers(this.frustum,this.marker2DShader,this.regionPhongShader,this.renderParam.vrMat,this.renderParam.pvrMat)},_renderFloor:function(t,e,i){if(-1!=e){this.baseColorShader.useProgram(),this.baseColorShader.setProjectionMatrix(this.renderParam.projMat),this.baseColorShader.setViewMatrix(this.renderParam.viewMat),this.baseColorShader.setRegionMatrix(this.matRegion),this.floors[t].renderBase(this.baseColorShader,this.touchMgr.getTouchFloor()==t);var r=this.overlook;YFM.Map.STATUS_SENSOR===this.status&&(r=!1);var s=!this.overlook;YFM.Map.STATUS_SENSOR===this.status&&(s=!0),this.basePhongShader.useProgram(),this.basePhongShader.setProjectionMatrix(this.renderParam.projMat),this.basePhongShader.setViewMatrix(this.renderParam.viewMat),this.basePhongShader.setRegionMatrix(this.matRegion),this.floors[t].renderExtrude(this.basePhongShader,this.renderParam.vrMat,this.extrudeLight,s),r&&t==i?this.floors[t].renderUnit(this.frustum,this.selectColorShader):this.drawUnitTextAlways&&this.floors[t].renderUnit(this.frustum,this.selectColorShader),this.pointSpiritShader.useProgram(),this.pointSpiritShader.setProjectionMatrix(this.renderParam.projMat),this.pointSpiritShader.setViewMatrix(this.renderParam.viewMat),this.pointSpiritShader.setRegionMatrix(this.matRegion),this.floors[t].renderQuickIcons(this.pointSpiritShader),this.billboardIconShader.useProgram(),this.billboardIconShader.setProjectionMatrix(this.renderParam.projMat),this.billboardIconShader.setViewMatrix(this.renderParam.viewMat),this.billboardIconShader.setRegionMatrix(this.matRegion),this.billboardIconShader.setIViewMatrix(this.renderParam.bivrMat),this.floors[t].renderIcons(this.frustum,this.billboardIconShader),this.modelPhongShader.useProgram(),this.modelPhongShader.setProjectionMatrix(this.renderParam.projMat),this.modelPhongShader.setViewMatrix(this.renderParam.viewMat),this.modelPhongShader.setRegionMatrix(this.matRegion),this.floors[t].renderModels(this.frustum,this.modelPhongShader,this.renderParam.vrMat,this.extrudeLight)}},_restructure:function(){var t,e,i,r;for(e=0,r=this.floors.length,i=0;i<r;i++)null!=(t=this.floors[i].getSize())&&t>e&&(e=t);for(this.maxSize=e,this.vPitch=e,i=0;i<r;i++)this.floors[i].setVOffset(this.vPitch,i);var s=r*this.vPitch,o=Math.sqrt(s*s+e*e);this.touchMgr.setZoomMax(o)},_grender:function(){YFM.gRegion._render(),requestAnimFrame(YFM.gRegion._grender)},_makeAzimuth:function(t){var e=YFM.Math.Vector.vec(0,1,0),i=YFM.Math.Vector.normalize(t),r=YFM.Math.Vector.dot3(i,e);return Math.acos(r)},_clampMinorArc:function(t){var e=2*Math.PI,i=t%e;return i>0&&i>Math.PI?i-=e:i<0&&i<-Math.PI&&(i+=e),i},_calcMarkerFloor:function(t){return t%FloorMarkers.prototype.shift},_calcModelFloor:function(t){return t%FloorQuadTree.prototype.shift},_drawText:function(t,e,i){this.ctx2d.fillText(t,e,i)},_cleanText:function(){this.ctx2d.clearRect(0,0,this.txtCanvas.width,this.txtCanvas.height)},_determineFontHeight:function(t){var e=document.getElementsByTagName("body")[0],i=document.createElement("div"),r=document.createTextNode("M");i.appendChild(r),i.setAttribute("style",t),e.appendChild(i);var s=i.offsetHeight;return e.removeChild(i),s}},RegionLocMarker.prototype={constructor:RegionLocMarker,locateLaunch:function(){this.waveRadius[0]=this.waveMax,this.waveRadius[1]=this.waveMax},set2DMarkerParam:function(t,e,i,r){var s=YFM.Math.Vector,o=YFM.WebGL.Color;this.locMarkerTexName=t,this.locMarker=null,this.waveColor=s.vec(o.hexColorRed(e),o.hexColorGreen(e),o.hexColorBlue(e),o.hexColorAlpha(e)),this.waveMax=i,this.waveMin=r,this.waveStep=(this.waveMax-this.waveMin)/56},getRegionLoc:function(){return YFM.Math.Vector.vecClone(this.regionLoc)},getFloorLoc:function(){return{floor:this.floorLoc.floor,x:this.floorLoc.x,y:this.floorLoc.y}},getSize:function(){return this.size},updateLocation:function(){-1!==this.floorLoc.floor&&(this.regionLoc=this.region.floorPos2RegionPos(this.floorLoc.floor,this.floorLoc.x,this.floorLoc.y),YFM.Map.STATUS_TOUCH!=this.region.getStatus()&&this.region._traceLoc(this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),this.region.updateNaviStatus(this.floorLoc,this.regionLoc))},cleanLocation:function(){this.floorLoc.floor=-1,this.floorLoc.x=0,this.floorLoc.y=0},setLocation:function(t,e,i){this.floorLoc.floor=t,this.floorLoc.x=e,this.floorLoc.y=i,this.regionLoc=this.region.floorPos2RegionPos(t,e,i),YFM.Map.STATUS_TOUCH!=this.region.getStatus()&&this.region._traceLoc(this.regionLoc[0],this.regionLoc[1],this.regionLoc[2]),this.region.updateNaviStatus(this.floorLoc,this.regionLoc)},animTo:function(t,e,i){t!=this.floorLoc.floor?(this.anim.flag=!1,this.setLocation(t,e,i)):(this.anim.floor=t,this.anim.flag=!0,this.anim.target=YFM.Math.Vector.pos(e,i,0),this.anim.mover.setLocation(this.floorLoc.x,this.floorLoc.y,0))},render:function(t,e,i,r){if(this._updateAnim(),i&&!(this.floorLoc.floor<0)){if(!this.locMarker&&this.locMarkerTexName){var s=this.region.getTexture(this.locMarkerTexName);null!==s&&(this.locMarker={tex:s.tex,texSize:YFM.Math.Vector.vec(s.w/2,s.h/2)})}if(this.locMarker){var o,h,a,n,u=YFM.Math.Matrix.mulVec(r,this.regionLoc);a=this.region.glCanvas.width/2,n=this.region.glCanvas.height/2,u[0]/=u[3],u[1]/=u[3],u[2]/=u[3],u[3]/=u[3],u[0]*=a,u[1]*=n,this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),o=YFM.Math.Matrix.scaleXYZ(this.waveRadius,0,0,0),h=YFM.Math.Matrix.postTranslate(o,u[0],u[1],0),t.setModelMatrix(h),t.drawTriangles(this.circleVBO,this.waveColor,0,this.circleSize),this.waveRadius[0]>this.waveMin?(this.waveRadius[0]-=this.waveStep,this.waveRadius[1]-=this.waveStep):(this.waveRadius[0]=this.waveMin,this.waveRadius[1]=this.waveMin),e.useProgram(),e.bindTexture(this.locMarker.tex),o=YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.scaleXYZ(this.locMarker.texSize,0,0,0),u[0],u[1],0),e.setModelMatrix(o),e.drawTriangles(this.quadVBO,6,0),this.gl.disable(this.gl.BLEND)}}},_updateAnim:function(){if(this.anim.flag)if(this.anim.mover.arrive(this.anim.target,this.anim.dist))this.anim.flag=!1,this.setLocation(this.anim.floor,this.anim.target[0],this.anim.target[1]);else{this.anim.mover.update();var t=this.anim.mover.getLocation();this.setLocation(this.anim.floor,t[0],t[1])}},_init:function(t,e){var i=YFM.Math.Vector,r=2.5*e,s=[];s.push(i.pos(0,0,0)),s.push(i.pos(0,e,r)),s.push(i.pos(e,0,r)),s.push(i.pos(0,-e,r)),s.push(i.pos(-e,0,r));var o=[];o.push(s[4]),o.push(s[2]),o.push(s[1]),o.push(s[2]),o.push(s[4]),o.push(s[3]),o.push(s[0]),o.push(s[4]),o.push(s[1]),o.push(s[0]),o.push(s[1]),o.push(s[2]),o.push(s[0]),o.push(s[2]),o.push(s[3]),o.push(s[0]),o.push(s[3]),o.push(s[4]),o.push(s[0]),o.push(s[1]),o.push(s[0]),o.push(s[2]),o.push(s[0]),o.push(s[3]),o.push(s[0]),o.push(s[4]),o.push(s[1]),o.push(s[2]),o.push(s[2]),o.push(s[3]),o.push(s[3]),o.push(s[4]),o.push(s[4]),o.push(s[1]),this.trianglesVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.trianglesVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(o,3),t.STATIC_DRAW);var h=[],a=2*Math.PI;h.push(i.pos(0,0,15));for(var n=0;n<a;n+=.1)h.push(i.pos(Math.cos(n),Math.sin(n),15));var u,l,c=[];for(u=1,l=h.length-1;u<l;u++)c.push(h[u]),c.push(h[0]),c.push(h[u+1]);c.push(h[u]),c.push(h[0]),c.push(h[1]),this.circleVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.circleVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(c,3),t.STATIC_DRAW),this.circleSize=c.length;var M=[],g=[],d=[];d.push(YFM.Math.Vector.vec(0,1)),d.push(YFM.Math.Vector.vec(1,1)),d.push(YFM.Math.Vector.vec(1,0)),d.push(YFM.Math.Vector.vec(0,0)),g.push(YFM.Math.Vector.pos(-1,-1,0)),g.push(YFM.Math.Vector.pos(1,-1,0)),g.push(YFM.Math.Vector.pos(1,1,0)),g.push(YFM.Math.Vector.pos(-1,1,0)),M.push(g[0]),M.push(d[0]),M.push(g[1]),M.push(d[1]),M.push(g[2]),M.push(d[2]),M.push(g[0]),M.push(d[0]),M.push(g[2]),M.push(d[2]),M.push(g[3]),M.push(d[3]),this.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.quadVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(M,3),t.STATIC_DRAW)}},RegionTouchMgr.prototype={constructor:RegionTouchMgr,setUIScaleRate:function(t){this.uiScaleRate=t},getViewOffsetMax:function(){return this.viewZoom.max},getViewOffsetMin:function(){return this.viewZoom.min},setEnable:function(t){this.enable=t},onRegionLoadFinish:function(){this.focusFloorDirty=!0},getTouchFloor:function(){return this.touchFloorIndex},getFocusFloorIndex:function(){if(!this.focusFloorDirty)return this.focusFloorIndex;var t,e,i,r,s,o,h=-1;for(t=this._floors_collision(this.canvas.width/2,this.canvas.height/2),i=-1e8,o=-1,s=-1,e=t.length,r=0;r<e;r++)t[r]<0&&t[r]>i&&(i=t[r],o=r),0==t[r]&&(s=r);return s>=0?h=s:o>=0&&(h=o),this.focusFloorIndex=h,this.focusFloorDirty=!1,this.focusFloorIndex},setZoomMax:function(t){this.viewZoom.max=t},getTouchRayPlus:function(t,e){var i,r,s,o,h,a,n,u;return i=t/this.canvas.width*2-1,r=-(e/this.canvas.height*2-1),s=YFM.Math.Vector.pos(i,r,-1),o=YFM.Math.Vector.pos(i,r,1),n=YFM.Math.Matrix.mul(this.camera.getPVMat(),this.region.matRegion),u=YFM.Math.Matrix.invert(n),h=YFM.Math.Matrix.mulVec(u,s),a=YFM.Math.Matrix.mulVec(u,o),h[0]/=h[3],h[1]/=h[3],h[2]/=h[3],h[3]/=h[3],a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],YFM.Math.Line.linePP(h,a)},_onMouseDown:function(t,e){},_onScroll:function(t,e){null!==this.listener&&this.listener.onScroll(t,e)},_onClick:function(t,e){null!==this.listener&&this.listener.onClick(t,e)},_onDClick:function(t,e){null!==this.listener&&this.listener.onDClick(t,e)},_on2FClick:function(t,e){null!==this.listener&&this.listener.on2FClick(t,e)},_onLongPressUp:function(t,e){null!==this.listener&&this.listener.onLongPressUp(t,e)},_spacingScreenSpace:function(t,e,i,r){var s=i-t,o=r-e;return Math.sqrt(s*s+o*o)},_spacingViewSpace:function(t,e,i,r){var s=this._pos_in_view_space(t,e),o=this._pos_in_view_space(i,r),h=o[0]-s[0],a=o[1]-s[1];return{z:(s[2]+o[2])/2,spacing:Math.sqrt(h*h+a*a)}},_midpoint:function(t,e,i,r){var s,o;return s=(t+i)/2,o=(e+r)/2,this.touchRec.midX=s,this.touchRec.midY=o,this.touchRec.dy0=e-o,this.touchRec.dy1=r-o,this._pos_in_world_space(s,o)},_calc_angle:function(t){var e=this._pos_in_world_space(this.touchRec.layer0x,this.touchRec.layer0y),i=this._pos_in_world_space(this.touchRec.layer1x,this.touchRec.layer1y);return Math.atan2(i[1]-e[1],i[0]-e[0])},_pitch_calc:function(t){return YFM.Math.radian2Deg(YFM.Math.Matrix.eulerParamExtractX(t))},_pitch_detect_continue:function(t){if(t.touches.length<2)return!1;var e,i;return e=this.touchRec.layer0y-this.touchRec.start0y,i=this.touchRec.layer1y-this.touchRec.start1y,e*i>0?this.touchRec.pitchCnt++:this.touchRec.pitchCnt--,this.touchRec.pitchCnt>36},_touch_plane_height:function(t,e){if(-1!==this.region.displayFloorIndex)return this.touchFloorIndex=this.region.displayFloorIndex,this.region._getFloorVOffset(this.region.displayFloorIndex);var i,r,s,o,h,a,n=-1;for(i=this._floors_collision(t,e),s=-1e8,a=-1,h=-1,r=i.length,o=0;o<r;o++)i[o]<0&&i[o]>s&&(s=i[o],a=o),0==i[o]&&(h=o);return h>=0?n=h:a>=0&&(n=a),this.touchFloorIndex=n,this.region._getFloorVOffset(n)},_floors_collision:function(t,e){var i=this.getTouchRayPlus(t,e);return this.region._intersectionLine(i)},_pitch_detect_first:function(t){if(t.touches.length<2)return!1;var e,i,r;return i=mgr.touchRec.layer0y-this.touchRec.midY-this.touchRec.dy0,r=mgr.touchRec.layer1y-this.touchRec.midY-this.touchRec.dy1,this.touchRec.pitchCnt=0,e=!1,i*r>0&&(e=!0),e},_pos_in_world_space:function(t,e){var i,r,s,o,h,a,n,u,l,c;return r=t/this.canvas.width*2-1,s=-(e/this.canvas.height*2-1),o=YFM.Math.Vector.pos(r,s,-1),h=YFM.Math.Vector.pos(r,s,1),u=this.camera.getIPVMat(),a=YFM.Math.Matrix.mulVec(u,o),n=YFM.Math.Matrix.mulVec(u,h),a[0]/=a[3],a[1]/=a[3],a[2]/=a[3],a[3]/=a[3],n[0]/=n[3],n[1]/=n[3],n[2]/=n[3],n[3]/=n[3],c=YFM.Math.Line.linePP(a,n),l=YFM.Math.Plane.plane(0,0,this.planeRec.planeHeight,0,0,1),i=YFM.Math.Plane.intersectionLine(l,c),YFM.Math.Line.getPoint(c,i)},_pos_in_view_space:function(t,e){var i=this._pos_in_world_space(t,e);return this._world_to_view(i)},_world_to_view:function(t){return YFM.Math.Matrix.mulVec(this.camera.getViewMat(),t)},_setOverlook:function(t){this.overlook=t},_screen_to_map:function(t,e){if(this.touchFloorIndex>=0){var i=this._pos_in_world_space(t,e),r=this.region._getFloorMat(this.touchFloorIndex),s=this.region._getRegionMat(),o=YFM.Math.Matrix.mul(s,r),h=YFM.Math.Matrix.invert(o),a=YFM.Math.Matrix.mulVec(h,i);return{floor:this.touchFloorIndex,x:a[0],y:this.region.getFloorAspect(this.touchFloorIndex).h-a[1]}}return null},_updateEventLayerPos:function(t){var e,i;t.layerX&&t.pageX?(e=t.layerX-t.pageX,i=t.layerY-t.pageY):(e=-t.target.offsetLeft,i=-t.target.offsetTop),t.touches&&t.touches.length>=1?(this.touchRec.layer0x=(t.touches[0].pageX+e)/this.uiScaleRate,this.touchRec.layer0y=(t.touches[0].pageY+i)/this.uiScaleRate,t.touches.length>=2?(this.touchRec.layer1x=(t.touches[1].pageX+e)/this.uiScaleRate,this.touchRec.layer1y=(t.touches[1].pageY+i)/this.uiScaleRate):(this.touchRec.layer1x=0,this.touchRec.layer1y=0)):(this.touchRec.layer0x=t.layerX/this.uiScaleRate,this.touchRec.layer0y=t.layerY/this.uiScaleRate)},_mapConstraint:function(t,e){var i,r,s,o,h,a,n,u,l=YFM.Math.Matrix,c=YFM.Math.Vector;i=c.pos(0,0,-1),r=c.pos(0,0,1),h=l.mul(t,this.region.matRegion),a=l.invert(h),s=l.mulVec(a,i),o=l.mulVec(a,r),s[0]/=s[3],s[1]/=s[3],s[2]/=s[3],s[3]/=s[3],o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],n=YFM.Math.Line.linePP(s,o),h=l.mul(this.camera.getPVMat(),e),a=l.invert(h),s=l.mulVec(a,i),o=l.mulVec(a,r),s[0]/=s[3],s[1]/=s[3],s[2]/=s[3],s[3]/=s[3],o[0]/=o[3],o[1]/=o[3],o[2]/=o[3],o[3]/=o[3],u=YFM.Math.Line.linePP(s,o);var M=this.region.floors[this.touchFloorIndex],g=M.intersectionLine(n);return M.intersectionLine(u)<g},_isMobileBrowser:function(){var t=navigator.userAgent.toLowerCase(),e="ipad"==t.match(/ipad/i),i="iphone os"==t.match(/iphone os/i),r="midp"==t.match(/midp/i),s="rv:1.2.3.4"==t.match(/rv:1.2.3.4/i),o="ucweb"==t.match(/ucweb/i),h="android"==t.match(/android/i),a="windows ce"==t.match(/windows ce/i),n="windows mobile"==t.match(/windows mobile/i);return e||i||r||s||o||h||a||n}},YFM.Map.ANIM_TYPE_PITCH=0,YFM.Map.ANIM_TYPE_LOOKAT=1,YFM.Map.ANIM_TYPE_LOOKDISTANCE=2,YFM.Map.ANIM_TYPE_LOOKAZIMUTH=3,YFM.Map.ANIM_DEFAULT_FRAME=12,AnimationMgr.prototype={constructor:AnimationMgr,
update:function(){if(null===this.current&&(this.current=this.seq.removeHigh(),null!==this.current&&(this.touchMgr.setEnable(!1),this.listener.onAnimStart(this.current))),null!==this.current){var t=this.current.step/this.current.frame,e=YFM.Math.lerp;switch(this.current.step+=1,this.current.type){case YFM.Map.ANIM_TYPE_PITCH:var i;i=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setPitch(i),this.current.overlook?0!==i&&(this.region._onOverlook(!1),this.current.overlook=!1,this.touchMgr._setOverlook(!1)):0===i&&(this.region._onOverlook(!0),this.current.overlook=!0,this.touchMgr._setOverlook(!0));break;case YFM.Map.ANIM_TYPE_LOOKDISTANCE:var r;r=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setLookOffset(0,0,r),this.camera.resetLookOffsetTan();break;case YFM.Map.ANIM_TYPE_LOOKAZIMUTH:var s;s=this.current.step==this.current.frame?this.current.to:e(this.current.from,this.current.to,t),this.camera.setAzimuth(s);break;case YFM.Map.ANIM_TYPE_LOOKAT:1==this.current.step&&(this.mover.setLocation(this.current.from[0],this.current.from[1],this.current.from[2]),this.camera.resetLookOffsetTan()),this.mover.arrive(this.current.to,2)?(this.current.step=this.current.frame,this.mover.setLocation(this.current.to[0],this.current.to[1],this.current.to[2])):this.mover.update();var o=this.mover.getLocation();this.camera.setLookAt(o[0],o[1],o[2]);break;case YFM.Map.ANIM_TYPE_MERGE:if(this.current.pitch){var i;i=this.current.step==this.current.frame?this.current.pitch.to:e(this.current.pitch.from,this.current.pitch.to,t),this.camera.setPitch(i),this.current.overlook?0!==i&&(this.region._onOverlook(!1),this.current.overlook=!1,this.touchMgr._setOverlook(!1)):0===i&&(this.region._onOverlook(!0),this.current.overlook=!0,this.touchMgr._setOverlook(!0))}if(this.current.distance){var r;r=this.current.step==this.current.frame?this.current.distance.to:e(this.current.distance.from,this.current.distance.to,t),this.camera.setLookOffset(0,0,r),this.camera.resetLookOffsetTan()}if(this.current.azimuth){var s;s=this.current.step==this.current.frame?this.current.azimuth.to:e(this.current.azimuth.from,this.current.azimuth.to,t),this.camera.setAzimuth(s)}if(this.current.lookAt){var o;if(this.current.step==this.current.frame)o=this.current.lookAt.to;else{var h=YFM.Math.Vector;o=h.add(this.current.lookAt.from,h.scale(this.current.lookAt.direction,this.current.step*this.current.lookAt.interval))}this.camera.setLookAt(o[0],o[1],o[2])}}this.current.step>=this.current.frame&&(this.listener.onAnimFinish(this.current),this.current=null,this.touchMgr.setEnable(!0))}},animPitch:function(t,e,i,r){var s=YFM.Math.clamp(t,0,45),o=e||null,h=i||YFM.Map.ANIM_DEFAULT_FRAME;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var a=new Animation(o,YFM.Map.ANIM_TYPE_PITCH,h);a.from=this.camera.getPitch(),a.to=-s,a.overlook=0===a.from,this.seq.addLow(a)},animLookDistance:function(t,e,i,r){var s=t,o=e||null,h=i||YFM.Map.ANIM_DEFAULT_FRAME;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var a=new Animation(o,YFM.Map.ANIM_TYPE_LOOKDISTANCE,h);a.from=this.camera.getLookOffsetNormal(),a.to=-s,this.seq.addLow(a)},animLookAzimuth:function(t,e,i,r,s){var o=YFM.Math.deg2Radian(t),h=e||null,a=i||!1,n=r||YFM.Map.ANIM_DEFAULT_FRAME;(s||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var u=new Animation(h,YFM.Map.ANIM_TYPE_LOOKAZIMUTH,n);u.from=this.camera.getAzimuth(),u.to=a?-o:u.from-o,this.seq.addLow(u)},animLookAt:function(t,e,i){var r=e||null;(i||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var s=new Animation(r,YFM.Map.ANIM_TYPE_LOOKAT,1024);s.from=this.camera.getLookAt(),s.to=t,this.seq.addLow(s)},animMerge:function(t,e,i,r){var s=e||null,o=i||24;(r||!1)&&(this.seq.clean(),null!==this.current&&this.listener.onAnimCancel(this.current),this.current=null);var h=new Animation(s,YFM.Map.ANIM_TYPE_MERGE,o);if(t.pitch&&(h.pitch={},h.pitch.from=this.camera.getPitch(),h.pitch.to=-YFM.Math.clamp(t.pitch,0,45),h.pitch.overlook=0===h.from),t.distance&&(h.distance={},h.distance.from=this.camera.getLookOffsetNormal(),h.distance.to=-t.distance),t.azimuth&&(h.azimuth={},h.azimuth.from=this.camera.getAzimuth(),h.abs?h.azimuth.to=-YFM.Math.deg2Radian(t.azimuth):h.azimuth.to=h.azimuth.from-YFM.Math.deg2Radian(t.azimuth)),t.lookAt){var a=YFM.Math.Vector;h.lookAt={},h.lookAt.from=this.camera.getLookAt(),h.lookAt.to=t.lookAt,h.lookAt.direction=a.normalize(a.sub(h.lookAt.to,h.lookAt.from)),h.lookAt.interval=a.distance(h.lookAt.from,h.lookAt.to)/o,this.camera.resetLookOffsetTan()}this.seq.addLow(h)}},RegionRoute.prototype={constructor:RegionRoute,getRouteCenter:function(){return null!==this.obb?YFM.Math.Vector.vecClone(this.obb.center):null},getRouteRAxis:function(){return null!==this.obb?YFM.Math.Vector.vecClone(this.obb.r):null},getRouteOBBLength:function(){if(null!==this.obb){var t=this.obb.hr,e=this.obb.hs,i=this.obb.ht;return 2*Math.sqrt(t*t+e*e+i*i)}return 0},getNaviStatus:function(){return this.naviStatus.validate?{validate:this.naviStatus.validate,projDist:this.naviStatus.projDist,goalDist:this.naviStatus.goalDist,serialDist:this.naviStatus.serialDist,nextSerialDist:this.naviStatus.nextSerialDist,azimuth:this.naviStatus.azimuth,sug:this.naviStatus.sug,nextSug:this.naviStatus.nextSug}:{validate:!1}},setUpdateNSFlag:function(t){var e=!this.updateNSFlag&&t,i=this.updateNSFlag&&!t;if(e){this.updateNSFlag=!0;var r=this.region.getFloorLoc();if(-1!=r.floor){var s=this.region.getRegionLoc();this.updateNaviStatus(r,s)}}else i&&(this.updateNSFlag=!1,this.naviStatus.validate=!1)},updateNaviStatus:function(t,e){this.updateNSFlag&&(null==this.floorRouteList?this.naviStatus.validate=!1:-1==t.floor?this.naviStatus.validate=!1:this.floorRouteList[t.floor].makeNaviStatus(this.naviStatus,e))},setRoute:function(t){this.cleanRoute();var e,i,r,s,o,h,a,n,u,l=[];for(h=this.region.getFloorCount(),this.floorRouteList=[],n=0;n<h;n++)this.floorRouteList.push(new FloorRoute(this.size,n,this.region,this));for(a=t.length,n=0;n<a;n++)s=t[n],r=this.region.floorPos2RegionPos(s.floor,s.x,s.y),r[2]+=5,l.push(r);for(this.obb=new OBB(l),u=t[0].floor,n=0;n<a-1;n++)s=t[n],o=t[n+1],o.floor==u?this.floorRouteList[u].addSeg(l[n],l[n+1]):u=o.floor;e=this.region.getFloorLoc(),-1!=e.floor&&(i=this.region.getRegionLoc(),this.updateNaviStatus(e,i)),this._makeRouteVBO()},cleanRoute:function(){this.floorRouteList=null,null!=this.routeVBO&&(this.routeVBO=null,this.gl.deleteBuffer(this.routeVBO))},render:function(t,e){this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL);var i=YFM.Math.Matrix.transpose(e),r=YFM.Math.Matrix.invert(i);t.setLightPos(this.light),t.setNormalMatrix(r),null!=this.routeVBO&&(t.setModelMatrix(YFM.Math.Matrix.mat()),t.setColor(this.routeColor),this.naviStatus.validate?(t.drawTriangles(this.routeVBO,this.routeBufferSize,60*this.naviStatus.startInstance),this._renderTail(t)):t.drawTriangles(this.routeVBO,this.routeBufferSize,0)),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)},_renderTail:function(t){var e,i,r,s,o,h,a;for(r=this.naviStatus.projection,s=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(this.region.getRegionLoc(),this.naviStatus.projection)),o=this.naviStatus.projDist,h=4*this.tailSize,a=0,e=YFM.Math.Matrix.scale(this.tailSize,0,0,0);a<=o;)i=YFM.Math.Vector.add(r,YFM.Math.Vector.scale(s,a)),t.setModelMatrix(YFM.Math.Matrix.postTranslate(e,i[0],i[1],i[2]+this.tailSize)),t.drawTriangles(this.tailMesh.getMeshVBO(),this.tailMesh.getMeshBufSize(),0),a+=h},_makeRouteVBO:function(){var t,e,i,r,s,o,h,a,n,u,l,c,M,g,d,f,p,m,v;for(g=0,f=0,d=0,h=this.region.getFloorCount(),u=0;u<h;u++)for(a=this.floorRouteList[u].getLength(),l=0;l<a;l++)for(M=this.floorRouteList[u].getSeg(l),M.startInstance=g,t=M.len,f=d,d=M.azimuth,n=Math.ceil(t/(2*this.size)),c=0==l?1:0;c<n&&(s=c/n,o=M.getPoint(s),!(c==n-1&&l<a-1&&(e=M.end[0]-o[0],i=M.end[1]-o[1],r=M.end[2]-o[2],e*e+i*i+r*r<=this.size*this.size/2)));c++)0==c&&l>0?(v=d-f,p=(d+f)/2,m=p,(v>Math.PI||v<-Math.PI)&&(m+=Math.PI)):m=d,this._makeShapeXY(this.routeVarray,o[0],o[1],o[2],this.size,m),g++;this.routeVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.routeVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.routeVarray,3),this.gl.STATIC_DRAW),this.routeBufferSize=this.routeVarray.length/2,this.routeVarray=[]},_initTail:function(){this.tailMesh=new IcosahedronMesh(this.gl,4)},_initRouteShape:function(){var t,e=[],i=[],r=[];e.push(YFM.Math.Vector.pos(0,1,0)),e.push(YFM.Math.Vector.pos(-1,0,0)),e.push(YFM.Math.Vector.pos(-1,-1,0)),e.push(YFM.Math.Vector.pos(0,0,0)),e.push(YFM.Math.Vector.pos(1,-1,0)),e.push(YFM.Math.Vector.pos(1,0,0)),e.push(YFM.Math.Vector.pos(0,1,.32)),e.push(YFM.Math.Vector.pos(-1,0,.32)),e.push(YFM.Math.Vector.pos(-1,-1,.32)),e.push(YFM.Math.Vector.pos(0,0,.32)),e.push(YFM.Math.Vector.pos(1,-1,.32)),e.push(YFM.Math.Vector.pos(1,0,.32)),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[3],e[0]),YFM.Math.Vector.sub(e[1],e[3]))),r.push(t),i.push({v0:0,v1:3,v2:1,n:0}),i.push({v0:1,v1:3,v2:2,n:0}),i.push({v0:0,v1:5,v2:3,n:0}),i.push({v0:3,v1:5,v2:4,n:0}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[6],e[9]),YFM.Math.Vector.sub(e[7],e[6]))),r.push(t),i.push({v0:9,v1:6,v2:7,n:1}),i.push({v0:7,v1:8,v2:9,n:1}),i.push({v0:9,v1:11,v2:6,n:1}),i.push({v0:9,v1:10,v2:11,n:1}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[3],e[2]),YFM.Math.Vector.sub(e[9],e[3]))),r.push(t),i.push({v0:2,v1:3,v2:9,n:2}),i.push({v0:9,v1:8,v2:2,n:2}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[4],e[3]),YFM.Math.Vector.sub(e[10],e[4]))),r.push(t),i.push({v0:3,v1:4,v2:10,n:3}),i.push({v0:10,v1:9,v2:3,n:3}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[5],e[4]),YFM.Math.Vector.sub(e[11],e[5]))),r.push(t),i.push({v0:4,v1:5,v2:11,n:4}),i.push({v0:11,v1:10,v2:4,n:4}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[6],e[0]),YFM.Math.Vector.sub(e[11],e[6]))),r.push(t),i.push({v0:0,v1:6,v2:11,n:5}),i.push({v0:11,v1:5,v2:0,n:5}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[1],e[0]),YFM.Math.Vector.sub(e[7],e[1]))),r.push(t),i.push({v0:0,v1:1,v2:7,n:6}),i.push({v0:7,v1:6,v2:0,n:6}),t=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(e[2],e[1]),YFM.Math.Vector.sub(e[8],e[2]))),r.push(t),i.push({v0:1,v1:2,v2:8,n:7}),i.push({v0:8,v1:7,v2:1,n:7}),this.routeModel={v:e,f:i,n:r}},_makeShapeXY:function(t,e,i,r,s,o){var h=YFM.Math.Matrix.rotate3d(o,0,0,1,!0);h=YFM.Math.Matrix.postScale(h,s,0,0,0),h=YFM.Math.Matrix.postTranslate(h,e,i,r);var a,n,u,l,c,M=YFM.Math.Matrix.invert(h),g=YFM.Math.Matrix.transpose(M),d=[],f=[];for(a=this.routeModel.v.length,n=this.routeModel.f.length,u=this.routeModel.n.length,l=0;l<a;l++)d.push(YFM.Math.Matrix.mulVec(h,this.routeModel.v[l]));for(l=0;l<u;l++)f.push(YFM.Math.Matrix.mulVec(g,this.routeModel.n[l]));for(l=0;l<n;l++)c=this.routeModel.f[l],t.push(d[c.v0]),t.push(f[c.n]),t.push(d[c.v1]),t.push(f[c.n]),t.push(d[c.v2]),t.push(f[c.n])}},RouteSeg.prototype={constructor:RouteSeg,updateEnd:function(t){this.end=t,this.segVec=YFM.Math.Vector.sub(this.end,this.start),this.lenSQ=YFM.Math.Vector.dot3(this.segVec,this.segVec),this.len=Math.sqrt(this.lenSQ),this.azimuth=this._makeAzimuth()},getPoint:function(t){return YFM.Math.Vector.add(this.start,YFM.Math.Vector.scale(this.segVec,t))},projection:function(t){var e=YFM.Math.Vector.sub(t,this.start),i=YFM.Math.Vector.dot3(e,this.segVec)/this.lenSQ;return i<=0?0:i>=1?1:i},_makeAzimuth:function(){var t=YFM.Math.Vector.vec(0,1,0),e=YFM.Math.Vector.normalize(this.segVec),i=YFM.Math.Vector.dot3(e,t),r=Math.acos(i);return e[0]>0&&(r=2*Math.PI-r),r}},FloorRoute.prototype={constructor:FloorRoute,addSeg:function(t,e){var i,r,s=new RouteSeg(t,e),o=YFM.Math.Vector.normalize(s.segVec);null!=this.lastSegVec?(i=YFM.Math.Vector.dot3(o,this.lastSegVec),Math.abs(i-1)<.01?(r=this.segList.pop(),r.updateEnd(e),this.segList.push(r)):this.segList.push(s)):this.segList.push(s),this.lastSegVec=o},makeNaviStatus:function(t,e){var i,r,s,o,h,a,n,u,l,c,M=this.segList.length;if(M<=0)t.validate=!1;else{for(t.validate=!0,a=Number.MAX_VALUE,n=0;n<M;n++)i=this.segList[n].projection(e),s=this.segList[n].getPoint(i),(h=YFM.Math.Vector.distanceSQ(e,s))<=a&&(a=h,o=s,u=n,r=i);for(i=u+r,i>this.implicitRec.maxT||null==this.implicitRec.maxPos||YFM.Math.Vector.distanceSQ(this.implicitRec.maxPos,o)>1e4?(this.implicitRec.maxT=i,this.implicitRec.maxPos=YFM.Math.Vector.vecClone(o),t.projection=o):t.projection=YFM.Math.Vector.vecClone(this.implicitRec.maxPos),l=YFM.Math.Vector.distance(t.projection,this.segList[u].start),t.startInstance=this.segList[u].startInstance+Math.floor(l/(2*this.size)),t.projDist=YFM.Math.Vector.distance(t.projection,e),t.serialDist=YFM.Math.Vector.distance(t.projection,this.segList[u].end),u+1<M?(t.nextSerialDist=this.segList[u+1].len,c=this.segList[u+1].azimuth-this.segList[u].azimuth,c<0&&(c+=2*Math.PI),c<=.175||c>=6.11?t.nextSug=YFM.Map.Navigate.NextSuggestion.FRONT:c<Math.PI?t.nextSug=YFM.Map.Navigate.NextSuggestion.LEFT:t.nextSug=YFM.Map.Navigate.NextSuggestion.RIGHT):(t.nextSerialDist=0,t.nextSug=YFM.Map.Navigate.NextSuggestion.ARRIVE),t.goalDist=t.serialDist,n=u+1;n<M;n++)t.goalDist+=this.segList[n].len;t.azimuth=this.segList[u].azimuth}},getLength:function(){return this.segList.length},getSeg:function(t){return this.segList[t]}},YFM.Map.DEFAULT_EXTRUDE_HEIGHT=16,YFM.Map.DEFAULT_QUICKPOLYGON_HEIGHT=YFM.Map.DEFAULT_EXTRUDE_HEIGHT+2,Floor.prototype={constructor:Floor,getSize:function(){return this.loaded?this.mapSize:null},getAspect:function(){return{w:this.mapWidth,h:this.mapHeight}},isLoaded:function(){return this.loaded},setVOffset:function(t,e){var i=t*e;YFM.Math.Matrix.setTranslateZ(this.floorMat,i),this.penddingVOffset=null;var r=[];r.push(YFM.Math.Vector.pos(0,0,i)),r.push(YFM.Math.Vector.pos(this.mapWidth,0,i)),r.push(YFM.Math.Vector.pos(this.mapWidth,this.mapHeight,i)),r.push(YFM.Math.Vector.pos(0,this.mapHeight,i)),this.planePolygon=new PlanePolygon(r),this.icons=new FloorIcons(this.gl,this.region,this),this.quadTree=new FloorQuadTree(this,100),this.models=new FloorModels(this.gl,this.region,this,t/3)},insertUnit:function(t,e,i){0===t.type?this.quadTree.insertObject(t,this.index,e,i,2):this.icons.insertIcon(t,e,i,2)},insertModel:function(t,e,i,r,s,o){return t.setFloor(this),t.setModelMatrix(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.postRotate3d(YFM.Math.Matrix.postRotate3d(YFM.Math.Matrix.scale(i,0,0,0),90,1,0,0),e,0,0,1),r,this.mapHeight-s,o)),this.models.insertModel(t)},removeModel:function(t){return this.models.removeModel(t)},searchModel:function(t,e){return null!=this.models?this.models.rayCheck(t,e):[]},searchUnit:function(t,e,i){return null!=this.quadTree?this.quadTree.rayCheck(t,e,i):[]},searchIcon:function(t,e,i){return null!=this.icons?this.icons.rayCheck(t,e,i):[]},intersectionLine:function(t){return null==this.planePolygon?1024:this.planePolygon.intersectionLine(t,this.floorMat)},floorPos2Region:function(t,e){var i;return i=YFM.Math.Vector.pos(t,this.mapHeight-e,0),YFM.Math.Matrix.mulVec(this.floorMat,i)},getFloorMat:function(){return this.floorMat},frustumCheck:function(t){return null==this.quadTree?-1:this.quadTree.frustumCheck(t)},renderBase:function(t,e){this.loaded&&(t.setMapHeight(this.mapHeight),t.setFloorMatrix(this.floorMat),t.setModelMatrix(YFM.Math.Matrix.mat()),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.ALWAYS),t.drawTriangles(this.trianglesVBO,this.trianglesSize),t.drawLines(this.borderVBO,this.borderSize),this.gl.disable(this.gl.DEPTH_TEST))},renderExtrude:function(t,e,i,r){if(this.loaded){t.setMapHeight(this.mapHeight),t.setFloorMatrix(this.floorMat),r?t.setModelMatrix(YFM.Math.Matrix.mat()):t.setModelMatrix(YFM.Math.Matrix.translate(0,0,1-YFM.Map.DEFAULT_EXTRUDE_HEIGHT)),t.setLightPos(i);var s=YFM.Math.Matrix.mul(e,this.floorMat),o=YFM.Math.Matrix.transpose(s),h=YFM.Math.Matrix.invert(o);t.setNormalMatrix(h),this.extrude.render(t,r),this.quickPolygon.render(t)}},renderModels:function(t,e,i,r){this.models.renderModels(t,e,i,r)},renderIcons:function(t,e){this.icons.renderIcons(t,e)},renderMarkers:function(t,e,i,r,s){this.markers.render(t,e,i,r,s)},renderQuickIcons:function(t){this.quickIcons.render(t)},renderUnit:function(t,e){if(this.loaded){var i=this.quadTree.getContainLevel(t);this.quadTree.render(t,this._renderUnit,this,i)}},_renderUnit:function(t,e){var i,r,s,o,h=e.region.regionPos2Screen(t.pos);if(!t.obj.block){var a=e.region.ctx2d.measureText(t.obj.text);t.obj.block={hw:(a.width+4)/2,hh:e.region.fontHeight/2}}i=h[0]-t.obj.block.hw,r=h[1]-t.obj.block.hh,s=h[0]+t.obj.block.hw,o=h[1]+t.obj.block.hh,e.region.tqct.check(i,r,s,o)||e.region._drawText(t.obj.text,h[0],h[1])},_load_svg:function(t,e){var i=t.gl,r=[],s=[],o=new DOMParser,h=o.parseFromString(e,"image/svg+xml");t._read_svg(h.documentElement,r,s),t.trianglesSize=r.length/2,t.borderSize=s.length/2,t.trianglesVBO=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,t.trianglesVBO),i.bufferData(i.ARRAY_BUFFER,YFM.Math.flatten(r,3),i.STATIC_DRAW),t.borderVBO=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,t.borderVBO),i.bufferData(i.ARRAY_BUFFER,YFM.Math.flatten(s,3),i.STATIC_DRAW),t.floorMat=YFM.Math.Matrix.translate(-t.mapWidth/2,-t.mapHeight/2,0),t.floorMat=YFM.Math.Matrix.postRotate3d(t.floorMat,-t.deflection,0,0,1);var a=[],n=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(4294935808),YFM.WebGL.Color.hexColorGreen(4294935808),YFM.WebGL.Color.hexColorBlue(4294935808));a.push(YFM.Math.Vector.pos(0,0,0)),a.push(n),a.push(YFM.Math.Vector.pos(t.mapWidth,0,0)),a.push(n),a.push(YFM.Math.Vector.pos(t.mapWidth,0,0)),a.push(n),a.push(YFM.Math.Vector.pos(t.mapWidth,t.mapHeight,0)),a.push(n),a.push(YFM.Math.Vector.pos(t.mapWidth,t.mapHeight,0)),a.push(n),a.push(YFM.Math.Vector.pos(0,t.mapHeight,0)),a.push(n),a.push(YFM.Math.Vector.pos(0,t.mapHeight,0)),a.push(n),a.push(YFM.Math.Vector.pos(0,0,0)),a.push(n),t.dummyVBO=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,t.dummyVBO),i.bufferData(i.ARRAY_BUFFER,YFM.Math.flatten(a,3),i.STATIC_DRAW),t.extrude.buildExtrude(),t.loaded=!0},_read_svg:function(t,e,i){this.mapWidth=parseInt(t.getAttribute("width")),this.mapHeight=parseInt(t.getAttribute("height")),this.mapSize=Math.sqrt(this.mapWidth*this.mapWidth,this.mapHeight*this.mapHeight),console.log("Floor<%s> read svg width:%d, height:%d",this.id,this.mapWidth,this.mapHeight);for(var r=0;r<t.childNodes.length;r++){var s=t.childNodes.item(r);"g"==s.nodeName&&this._read_group(s,e,i)}},_read_group:function(t,e,i,r){var s,o=t.getAttribute("id");if(!this.regIcon.test(o)){s=!!r||this.regUnit.test(o);for(var h=0;h<t.childNodes.length;h++){var a=t.childNodes.item(h);1==a.nodeType&&("g"==a.nodeName?this._read_group(a,e,i,s):this._read_obj(a,e,i,s))}}},_pos2:function(t,e){var i=[];return i.push(t),i.push(e),i.push(1),i},_multVec3:function(t,e){var i,r,s,o=[];return i=e[0],r=e[1],s=e[2],o.push(i*t[0]+r*t[3]+s*t[6]),o.push(i*t[1]+r*t[4]+s*t[7]),o.push(i*t[2]+r*t[5]+s*t[8]),o},_read_obj:function(t,e,i,r){if("rect"==t.nodeName){var s=t.getAttribute("fill"),o=t.getAttribute("stroke"),h=parseFloat(t.getAttribute("width")),a=parseFloat(t.getAttribute("height")),n=parseFloat(t.getAttribute("x")),u=parseFloat(t.getAttribute("y")),l=[],c=this._parseMatrix(t.getAttribute("transform"));if(null!=c){var M=this._multVec3(c,this._pos2(n,u)),g=this._multVec3(c,this._pos2(n+h,u)),d=this._multVec3(c,this._pos2(n+h,u+a)),f=this._multVec3(c,this._pos2(n,u+a));l.push(M[0]),l.push(M[1]),l.push(g[0]),l.push(g[1]),l.push(d[0]),l.push(d[1]),l.push(f[0]),l.push(f[1])}else l.push(n),l.push(u),l.push(n+h),l.push(u),l.push(n+h),l.push(u+a),l.push(n),l.push(u+a);this._add_shape(l,s,o,e,i,r)}else if("polygon"==t.nodeName){var s=t.getAttribute("fill"),o=t.getAttribute("stroke"),l=t.getAttribute("points");this._add_shape(l,s,o,e,i,r)}},_add_shape:function(t,e,i,r,s,o){var h,a,n,u,l,c,M=new ArrayList,g=[];if(h=null!=i&&"none"!=i,h&&(i=i.replace("#",""),l=parseInt(i,16),a=(l>>16&255)/255,n=(l>>8&255)/255,u=(255&l)/255,c=YFM.Math.Vector.vec(a,n,u)),!(t instanceof Array)){for(var d=[],f=t.replace(/\s+/," ").split(" "),p=0;p<f.length;p++){var m=f[p].split(","),v=parseFloat(m[0]),F=parseFloat(m[1]);isNaN(v)||isNaN(F)||(d.push(v),d.push(F))}t=d}for(var x=t.length/2,_=0,Y=0,p=0;p<x;p++){var v=t[2*p+0],F=t[2*p+1];o&&(_+=v,Y+=F);var V=YFM.Math.Vector.vec(v,F,0,1);if(g.push(V),M.addHigh(V),h){var R,y;p==x-1?(R=t[0],y=t[1]):(R=t[2*(p+1)+0],y=t[2*(p+1)+1]),o?this.extrude.addBorder(YFM.Math.Vector.pos(v,F,0),YFM.Math.Vector.pos(R,y,0),c):(s.push(YFM.Math.Vector.vec(v,F,0,1)),s.push(c),s.push(YFM.Math.Vector.vec(R,y,0,1)),s.push(c))}}if("none"!=e){e=e.replace("#","");var l=parseInt(e,16);a=(l>>16&255)/255,n=(l>>8&255)/255,u=(255&l)/255,this._triangulate_cut_ear(a,n,u,g,M,r,o)}},_parseMatrix:function(t){if(null==t)return null;var e=t.slice(7,-1).split(" ");if(e.length<6)return null;for(var i=[],r=0;r<e.length;r++)i.push(parseFloat(e[r]));var s=[];return s.push(i[0]),s.push(i[1]),s.push(0),s.push(i[2]),s.push(i[3]),s.push(0),s.push(i[4]),s.push(i[5]),s.push(1),s},_clock_wise:function(t){for(var e=0,i=t.length,r=0;r<i;r++)e+=(t[(r+1)%i][0]-t[r][0])*(t[(r+1)%i][1]+t[r][1]);return e>0},_is_left_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])>0},_is_right_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])<0},_point_inside:function(t,e,i,r){var s=this._is_left_turn(t,e,r),o=this._is_left_turn(e,i,r),h=this._is_left_turn(i,t,r);if(s&&o&&h)return!0;var a=this._is_right_turn(t,e,r),n=this._is_right_turn(e,i,r),u=this._is_right_turn(i,t,r);return!!(a&&n&&u)},_add_unit_extrude:function(t,e,i){},_triangulate_cut_ear:function(t,e,i,r,s,o,h){for(var a,n,t,u=this._clock_wise(r),l=YFM.Math.Vector.vec(t,e,i),c=[];s.size()>3;){var M,g,d=-1,f=0;do{if(f++,g=s.size(),f>=g)return console.log("bad input."),!1;if(d++,a=s.get(d%g),n=s.get((d+1)%g),t=s.get((d+2)%g),M=this._is_left_turn(a,n,t)^u)for(var p=s.getIter();p.hasNext();){var m=p.getNext();if(this._point_inside(a,n,t,m)){M=!1;break}}}while(!M);h?(c.push(a),c.push(n),c.push(t)):(o.push(a),o.push(l),o.push(n),o.push(l),o.push(t),o.push(l)),s.remove((d+1)%g)}return 3==s.size()&&(h?(c.push(s.get(0)),c.push(s.get(1)),c.push(s.get(2))):(o.push(s.get(0)),o.push(l),o.push(s.get(1)),o.push(l),o.push(s.get(2)),o.push(l))),h&&this.extrude.addExtrude(r,c,l),!0}},FloorExtrude.prototype={constructor:FloorExtrude,render:function(t,e){null!=this.extrudeTopVBO&&(this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),e&&t.drawTriangles(this.extrudeSideVBO,this.extrudeSideSize),t.drawTriangles(this.extrudeTopVBO,this.extrudeTopSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)),null!=this.borderVBO&&(t.setLighting(0),this.gl.lineWidth(2),t.drawLines(this.borderVBO,this.borderSize),this.gl.lineWidth(1))},addBorder:function(t,e,i){t[2]+=this.height,e[2]+=this.height,this.borderVarray.push(t),this.borderVarray.push(i),this.borderVarray.push(this.borderNormal),this.borderVarray.push(e),this.borderVarray.push(i),this.borderVarray.push(this.borderNormal)},addExtrude:function(t,e,i){var r,s,o,h,a=e.length/3,n=t.length,u=YFM.Math.Vector.vec(0,0,1);for(r=0;r<a;r++){var l=[];l.push(e[3*r+0]),l.push(e[3*r+1]),l.push(e[3*r+2]),this._clock_wise_tri(l)?(this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[0][0],l[0][1],l[0][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[1][0],l[1][1],l[1][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[2][0],l[2][1],l[2][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u)):(this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[0][0],l[0][1],l[0][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[2][0],l[2][1],l[2][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u),this.extrudeTopVarray.push(YFM.Math.Vector.pos(l[1][0],l[1][1],l[1][2]+this.height)),this.extrudeTopVarray.push(i),this.extrudeTopVarray.push(u))}if(this._clock_wise_pts(t)){for(s=0;s<n-1;s++)o=t[s],h=t[s+1],this._putSideQuad(h,o,i);o=t[s],h=t[0],this._putSideQuad(h,o,i)}else{for(s=0;s<n-1;s++)o=t[s],h=t[s+1],this._putSideQuad(o,h,i);o=t[s],h=t[0],this._putSideQuad(o,h,i)}},buildExtrude:function(){this.extrudeTopVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeTopVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeTopVarray,3),this.gl.STATIC_DRAW),this.extrudeTopSize=this.extrudeTopVarray.length/3,this.extrudeTopVarray=[],this.extrudeSideVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.extrudeSideVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.extrudeSideVarray,3),this.gl.STATIC_DRAW),this.extrudeSideSize=this.extrudeSideVarray.length/3,this.extrudeSideVarray=[],this.borderVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.borderVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.borderVarray,3),this.gl.STATIC_DRAW),this.borderSize=this.borderVarray.length/3,this.borderVarray=[]},_clock_wise_tri:function(t){var e=0;return e+=(t[1][0]-t[0][0])*(t[1][1]+t[0][1]),e+=(t[2][0]-t[1][0])*(t[2][1]+t[1][1]),(e+=(t[0][0]-t[2][0])*(t[0][1]+t[2][1]))>0},_clock_wise_pts:function(t){for(var e=0,i=t.length,r=0;r<i;r++)e+=(t[(r+1)%i][0]-t[r][0])*(t[(r+1)%i][1]+t[r][1]);return e>0},_putSideQuad:function(t,e,i){var r,s,o,h,a,n=[],u=[];r=YFM.Math.Vector.pos(t[0],t[1],t[2]),s=YFM.Math.Vector.pos(e[0],e[1],e[2]),o=YFM.Math.Vector.pos(e[0],e[1],e[2]+this.height),h=YFM.Math.Vector.pos(t[0],t[1],t[2]+this.height),n.push(r),n.push(o),n.push(s),u.push(r),u.push(h),u.push(o),a=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(YFM.Math.Vector.sub(s,r),YFM.Math.Vector.sub(o,s))),this.extrudeSideVarray.push(n[0]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(n[1]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(n[2]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(u[0]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(u[1]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a),this.extrudeSideVarray.push(u[2]),this.extrudeSideVarray.push(i),this.extrudeSideVarray.push(a)}},FloorIcons.prototype={constructor:FloorIcons,insertIcon:function(t,e,i,r){this.quadTree.insertObject(t,this.floor.index,e,i,r)},rayCheck:function(t,e,i){return this.quadTree.rayCheck(t,e,i)},renderIcons:function(t,e){if(this.shader=e,null===this.iconTex){var i=this.region.getTexture("pubIcons");null!=i&&(this.iconTex=i.tex)}null!==this.iconTex&&(this.shader.bindTexture(this.iconTex),this.quadTree.render(t,this._renderIcon,this,1024))},_renderIcon:function(t,e){null!==e.iconTex&&(e.shader.setModelMatrix(YFM.Math.Matrix.translate(t.pos[0],t.pos[1],t.pos[2])),e.shader.drawTriangles(e.quadVBO,6,6*t.obj.type))},_calcTexCoords:function(t,e,i){var r,s;r=Math.floor((i-1)/8),s=(i-1)%8;var o=[];o.push(YFM.Math.Vector.pos(1/8*s,1/8*r)),o.push(YFM.Math.Vector.pos(1/8*s,1/8*(r+1))),o.push(YFM.Math.Vector.pos(1/8*(s+1),1/8*(r+1))),o.push(YFM.Math.Vector.pos(1/8*(s+1),1/8*r)),t.push(e[0]),t.push(o[0]),t.push(e[1]),t.push(o[1]),t.push(e[2]),t.push(o[2]),t.push(e[0]),t.push(o[0]),t.push(e[2]),t.push(o[2]),t.push(e[3]),t.push(o[3])}},FloorQuickPolygon.prototype={constructor:FloorQuickPolygon,render:function(t){this.loaded&&(this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setLighting(1),t.drawTriangles(this.quickPolygonVBO,this.quickPolygonSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE))},addQuickPolygon:function(t,e){var i,r=t.length,s=YFM.Math.Vector.vec(0,0,1),o=new ArrayList,h=YFM.WebGL.Color.getRGBVec(e);for(i=0;i<r;i++)o.addHigh(t[i]);var a=this._triangulate_cut_ear(t,o);if(null!==a){var n=a.length/3;for(i=0;i<n;i++){var u=[];u.push(a[3*i+0]),u.push(a[3*i+1]),u.push(a[3*i+2]),this._clock_wise_tri(u)?(this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[0][0],u[0][1],u[0][2]+this.height)),this.quickPolygonVarray.push(h),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[1][0],u[1][1],u[1][2]+this.height)),this.quickPolygonVarray.push(h),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[2][0],u[2][1],u[2][2]+this.height)),this.quickPolygonVarray.push(h),this.quickPolygonVarray.push(s)):(this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[0][0],u[0][1],u[0][2]+this.height)),this.quickPolygonVarray.push(h),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[2][0],u[2][1],u[2][2]+this.height)),this.quickPolygonVarray.push(h),this.quickPolygonVarray.push(s),this.quickPolygonVarray.push(YFM.Math.Vector.pos(u[1][0],u[1][1],u[1][2]+this.height)),this.quickPolygonVarray.push(h),this.quickPolygonVarray.push(s))}}},buildQuickPolygon:function(){this.quickPolygonVarray.length<=0||(this.cleanQuickPolygon(),this.quickPolygonVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quickPolygonVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.quickPolygonVarray,3),this.gl.STATIC_DRAW),this.quickPolygonSize=this.quickPolygonVarray.length/3,this.quickPolygonVarray=[],this.loaded=!0)},cleanQuickPolygon:function(){if(null!==this.quickPolygonVBO){var t=this.quickPolygonVBO,e=this.gl;this.quickPolygonVBO=null,this.loaded=!1,setTimeout(function(){e.deleteBuffer(t)},2e3)}},_clock_wise_tri:function(t){var e=0;return e+=(t[1][0]-t[0][0])*(t[1][1]+t[0][1]),e+=(t[2][0]-t[1][0])*(t[2][1]+t[1][1]),(e+=(t[0][0]-t[2][0])*(t[0][1]+t[2][1]))>0},_clock_wise_pts:function(t){for(var e=0,i=t.length,r=0;r<i;r++)e+=(t[(r+1)%i][0]-t[r][0])*(t[(r+1)%i][1]+t[r][1]);return e>0},_is_left_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])>0},_is_right_turn:function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])<0},_point_inside:function(t,e,i,r){var s=this._is_left_turn(t,e,r),o=this._is_left_turn(e,i,r),h=this._is_left_turn(i,t,r);if(s&&o&&h)return!0;var a=this._is_right_turn(t,e,r),n=this._is_right_turn(e,i,r),u=this._is_right_turn(i,t,r);return!!(a&&n&&u)},_triangulate_cut_ear:function(t,e){for(var i,r,s,o=this._clock_wise_pts(t),h=[];e.size()>3;){var a,n,u=-1,l=0;do{if(l++,n=e.size(),l>=n)return console.log("bad input."),null;if(u++,i=e.get(u%n),r=e.get((u+1)%n),s=e.get((u+2)%n),a=this._is_left_turn(i,r,s)^o)for(var c=e.getIter();c.hasNext();){var M=c.getNext();if(this._point_inside(i,r,s,M)){a=!1;break}}}while(!a);h.push(i),h.push(r),h.push(s),e.remove((u+1)%n)}return 3==e.size()&&(h.push(e.get(0)),h.push(e.get(1)),h.push(e.get(2))),h}},FloorQuickIcons.prototype={constructor:FloorQuickIcons,render:function(t){if(null!=this.pointsVBO){if(null===this.tex){var e=this.region.getTexture(this.texName);null!==e&&(this.tex=e.tex)}null!==this.tex&&(t.bindTexture(this.tex),t.drawPoints(this.pointsVBO,this.pointsSize))}},setTex:function(t){this.tex=null,this.texName=t},addPoint:function(t,e){var i=this.floor.floorPos2Region(t,e);i[2]+=this.height,this.pointsVarray.push(i)},clean:function(){null!==this.pointsVBO&&this.gl.deleteBuffer(this.pointsVBO),this.pointsVBO=null,this.pointsSize=0,this.pointsVarray=[]},buildPoints:function(){
null!==this.pointsVBO&&this.gl.deleteBuffer(this.pointsVBO),this.pointsVBO=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.pointsVBO),this.gl.bufferData(this.gl.ARRAY_BUFFER,YFM.Math.flatten(this.pointsVarray,3),this.gl.STATIC_DRAW),this.pointsSize=this.pointsVarray.length,this.pointsVarray=[]}},FloorMarkers.prototype={constructor:FloorMarkers,quadVBO:null,cursor:0,shift:1e4,removeMarker:function(t){for(var e=null,i=!1,r=[],s=0;s<this.markerArray.length;s++)t===this.markerArray[s].id?(i=!0,e=this.markerArray[s]):r.push(this.markerArray[s]);return i&&(this.markerArray=r),e},insertMarker:function(t,e,i){var r=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,s=this.floor.floorPos2Region(e,i);return s[2]+=t.height,t.id=r,t.pos=s,this.markerArray.push(t),FloorMarkers.prototype.cursor++,r},insertTextureMarker:function(t,e,i,r,s,o){var h=this.floor.floorPos2Region(e,i);h[2]+=r;var a=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,n={type:1,id:a,texName:t,tex:null,texSize:YFM.Math.Vector.vec(10,10),envelop:YFM.Math.Vector.vec(0),pos:h,distSQ:0,height:r,offsetX:s,offsetY:o};return this.markerArray.push(n),FloorMarkers.prototype.cursor++,a},insertGeometryMarker:function(t,e,i,r,s,o){var h;if(t===YFM.Mesh.CATEGORY_TETRHEDRON)h=new TetrahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_HEXADEDRON)h=new HexahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_OCTAHEDRON)h=new OctahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_DODECAHEDRON)h=new DodecahedronMesh(this.gl,0);else if(t===YFM.Mesh.CATEGORY_ICOSAHEDRON)h=new IcosahedronMesh(this.gl,0);else{if(t!==YFM.Mesh.CATEGORY_SPHERE)return null;h=new IcosahedronMesh(this.gl,4)}var a=YFM.Math.Vector.pos(YFM.WebGL.Color.hexColorRed(e),YFM.WebGL.Color.hexColorGreen(e),YFM.WebGL.Color.hexColorBlue(e)),n=this.floor.floorPos2Region(r,s);n[2]+=o;var u=FloorMarkers.prototype.cursor*FloorMarkers.prototype.shift+this.floor.index,l={type:0,id:u,mesh:h,angle:0,bounce:0,bstep:i/20,size:i,color:a,height:o,pos:n};return this.markerArray.push(l),FloorMarkers.prototype.cursor++,u},render:function(t,e,i,r,s){var o,h,a,n;this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL);var u=YFM.Math.Matrix.transpose(r),l=YFM.Math.Matrix.invert(u);i.setLightPos(this.light),i.setNormalMatrix(l);var c=YFM.Math.Matrix.invert(r),M=YFM.Math.Matrix.mulVec(c,this.orgPos),g=this.markerIMinPQ.getSize();for(this.markerArray.length>g?this.markerIMinPQ.setSize(Math.floor(1.5*this.markerArray.length)):this.markerArray.length<g/2?this.markerIMinPQ.setSize(this.markerArray.length):this.markerIMinPQ.clean(),h=0;h<this.markerArray.length;h++)o=this.markerArray[h],t.containCheckPoint(o.pos)?0===o.type?this._renderMesh(i,o):1===o.type&&(a=YFM.Math.Vector.distanceSQ(o.pos,M),o.distSQ=a,this.markerIMinPQ.insert(h,a)):o.type;for(this.markerSorted=[],n=this.markerIMinPQ.getCount(),h=0;h<n;h++)this.markerSorted.push(this.markerIMinPQ.deleteMin());for(h=n-1;h>=0;h--)o=this.markerArray[this.markerSorted[h]],1===o.type&&this._renderTex(s,e,o);this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)},findMarker:function(t,e){for(var i,r,i=0;i<this.markerSorted.length;i++)if(r=this.markerArray[this.markerSorted[i]],this._envelopCheck(r.envelop,t,e))return{id:r.id,dist:r.distSQ};return null},_envelopCheck:function(t,e,i){return e>=t[0]&&e<=t[2]&&i>=t[1]&&i<=t[3]},_renderMesh:function(t,e){t.useProgram();var i=YFM.Math.Matrix.scale(e.size,0,0,0);i=YFM.Math.Matrix.postRotateXY(i,e.angle,0,0);var r=YFM.Math.Matrix.postTranslate(i,e.pos[0],e.pos[1],e.pos[2]+e.bounce);t.setModelMatrix(r),t.setColor(e.color);var s=e.mesh.getMeshVBO(),o=e.mesh.getMeshBufSize();t.drawTriangles(s,o,0),e.angle+=1,e.bounce+=e.bstep,(e.bounce>e.size||e.bounce<0)&&(e.bstep=-e.bstep)},_renderTex:function(t,e,i){if(null===i.tex){var r=this.region.getTexture(i.texName);null!==r&&(i.tex=r.tex,i.texSize[0]=r.w/2,i.texSize[1]=r.h/2)}if(null!==i.tex){var s,o,h=YFM.Math.Matrix.mulVec(t,i.pos);s=YFM.gRegion.glCanvas.width/2,o=YFM.gRegion.glCanvas.height/2,h[0]/=h[3],h[1]/=h[3],h[2]/=h[3],h[3]/=h[3],h[0]*=s,h[1]*=o,e.useProgram(),e.bindTexture(i.tex),i.envelop[0]=s+h[0]-i.offsetX-i.texSize[0],i.envelop[1]=o-(h[1]+i.offsetY+i.texSize[1]),i.envelop[2]=s+h[0]+i.offsetX+i.texSize[0],i.envelop[3]=o-(h[1]+i.offsetY-i.texSize[1]);var a=YFM.Math.Matrix.postRotateXY(YFM.Math.Matrix.postTranslate(YFM.Math.Matrix.scaleXYZ(i.texSize,0,0,0),h[0]-i.offsetX,h[1]+i.offsetY,0),this.region.camera.getRoll(),h[0],h[1]);e.setModelMatrix(a),this.gl.depthMask(!1),e.drawTriangles(FloorMarkers.prototype.quadVBO,6,0),this.gl.depthMask(!0)}},_initQuad:function(t){var e=[],i=[],r=[];r.push(YFM.Math.Vector.vec(0,1)),r.push(YFM.Math.Vector.vec(1,1)),r.push(YFM.Math.Vector.vec(1,0)),r.push(YFM.Math.Vector.vec(0,0)),i.push(YFM.Math.Vector.pos(-1,-1,0)),i.push(YFM.Math.Vector.pos(1,-1,0)),i.push(YFM.Math.Vector.pos(1,1,0)),i.push(YFM.Math.Vector.pos(-1,1,0)),e.push(i[0]),e.push(r[0]),e.push(i[1]),e.push(r[1]),e.push(i[2]),e.push(r[2]),e.push(i[0]),e.push(r[0]),e.push(i[2]),e.push(r[2]),e.push(i[3]),e.push(r[3]),FloorMarkers.prototype.quadVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,FloorMarkers.prototype.quadVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(e,3),t.STATIC_DRAW)}},FloorModels.prototype={constructor:FloorModels,removeModel:function(t){return this.quadTree.removeObject(t)},insertModel:function(t){return this.quadTree.insertObjectOBB(t,t.obb)},rayCheck:function(t,e){return this.quadTree.rayCheckOBB(t,e)},renderModels:function(t,e,i,r){this.shader=e,this.vrfMat=YFM.Math.Matrix.mul(i,this.floor.getFloorMat()),e.setFloorMatrix(this.floor.getFloorMat()),e.setLightPos(r),this.gl.enable(this.gl.CULL_FACE),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),this.quadTree.render(t,this._renderModel,this,1024),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.CULL_FACE)},_renderModel:function(t,e){t.obj.render(e.shader,e.vrfMat)}},YFM.Math=function(){var t=function(t,e,i){return Math.max(e,Math.min(i,t))},e=function(t,e,i,r,s){return r+(t-e)/(i-e)*(s-r)},i=function(t){return 2*t*Math.PI/360},r=function(t){return 360*t/(2*Math.PI)},s=function(t){return[].concat.apply([],Array.prototype.slice.apply(t))},o=function(t,e){return Math.abs(t-e)<=1e-5||(Math.abs(t)>Math.abs(e)?Math.abs((t-e)/t):Math.abs((t-e)/e))<=1e-8},h=function(t){return Math.abs(t)>1e-20};return{clamp:t,map:e,deg2Radian:i,radian2Deg:r,flatten:function(t,e){var i,r=t.length,s=!1;Array.isArray(t[0])&&(s=!0,null==e?(r*=t[0].length,i=t[0].length):(r*=e,i=e));var o=new Float32Array(r);if(s)for(var h=0,a=0;a<t.length;++a)for(var n=0;n<i;++n)o[h++]=t[a][n];else for(var a=0;a<t.length;++a)o[a]=t[a];return o},argumentsToArray:s,floatEquals:o,floatNotZero:h,vf2str:function(t,e){for(var i="[ ",r=t.length,s=0;s<r;s++)i+=t[s].toFixed(e),i+=", ";return i+="]"},lerp:function(t,e,i){return t+(e-t)*i}}}(),YFM.Math.Vector=function(){var t=function(){var t=YFM.Math.argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(1)}return t.splice(0,4)},e=function(){var t=YFM.Math.argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(0)}return t.splice(0,4)},i=function(t){return t.slice(0)},r=function(t,e){var i=[];return i.push(t[0]+e[0]),i.push(t[1]+e[1]),i.push(t[2]+e[2]),i.push(t[3]+e[3]),i},s=function(t,e){t[0]=t[0]+e[0],t[1]=t[1]+e[1],t[2]=t[2]+e[2],t[3]=t[3]+e[3]},o=function(t,e){var i=[];return i.push(t[0]-e[0]),i.push(t[1]-e[1]),i.push(t[2]-e[2]),i.push(t[3]-e[3]),i},h=function(t,e){t[0]=t[0]-e[0],t[1]=t[1]-e[1],t[2]=t[2]-e[2],t[3]=t[3]-e[3]},a=function(t,e){var i=[];return i.push(e*t[0]),i.push(e*t[1]),i.push(e*t[2]),i.push(e*t[3]),i},n=function(t,e){t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e},u=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},l=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},c=function(t,e){var i=[];return i.push(-e[1]*t[2]+e[2]*t[1]),i.push(e[0]*t[2]-e[2]*t[0]),i.push(-e[0]*t[1]+e[1]*t[0]),i.push(0),i},M=function(t){return Math.sqrt(u(t,t))},g=function(t){return Math.sqrt(l(t,t))},d=function(t){return u(t,t)},f=function(t){return l(t,t)},p=function(t,e){var i=o(e,t);return u(i,i)},m=function(t,e){var i=o(e,t);return Math.sqrt(u(i,i))};return{pos:t,vec:e,vecClone:i,add:r,addTo:s,sub:o,subTo:h,scale:a,scaleTo:n,dot3:u,dot4:l,cross:c,norm3:M,norm4:g,norm3SQ:d,norm4SQ:f,normalize:function(t){var e=[],i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return i>0?(e.push(t[0]/i),e.push(t[1]/i),e.push(t[2]/i),e.push(t[3])):(e.push(0),e.push(0),e.push(0),e.push(t[3])),e},limitTo:function(t,e){var i=u(t,t);if(i>e*e){var r=Math.sqrt(i);t[0]/=r,t[1]/=r,t[2]/=r,t[0]*=e,t[1]*=e,t[2]*=e}},limitToRange:function(t,e,i){var r,s=u(t,t);s>i*i?(r=Math.sqrt(s),t[0]/=r,t[1]/=r,t[2]/=r,t[0]*=i,t[1]*=i,t[2]*=i):s<e*e&&(r=Math.sqrt(s),t[0]/=r,t[1]/=r,t[2]/=r,t[0]*=i,t[1]*=i,t[2]*=i)},mix:function(t,e,i){var r=[];return r.push((1-i)*t[0]+i*e[0]),r.push((1-i)*t[1]+i*e[1]),r.push((1-i)*t[2]+i*e[2]),r.push((1-i)*t[3]+i*e[3]),r},distanceSQ:p,distance:m}}(),YFM.Math.Matrix=function(){var t=function(){var t=[];return t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t},e=function(t){return t.slice(0)},i=function(e,i,r,s,o){var h,a,n,u=t();if(h=o?e:YFM.Math.deg2Radian(e),a=Math.cos(h),n=Math.sin(h),u[3]=0,u[7]=0,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,1==i&&0==r&&0==s)u[5]=a,u[10]=a,u[6]=n,u[9]=-n,u[1]=0,u[2]=0,u[4]=0,u[8]=0,u[0]=1;else if(0==i&&1==r&&0==s)u[0]=a,u[10]=a,u[8]=n,u[2]=-n,u[1]=0,u[4]=0,u[6]=0,u[9]=0,u[5]=1;else if(0==i&&0==r&&1==s)u[0]=a,u[5]=a,u[1]=n,u[4]=-n,u[2]=0,u[6]=0,u[8]=0,u[9]=0,u[10]=1;else{var l=Math.sqrt(i*i+r*r+s*s);if(1!=l){var c=1/l;i*=c,r*=c,s*=c}var M=1-a,g=i*r,d=r*s,f=s*i,p=i*n,m=r*n,v=s*n;u[0]=i*i*M+a,u[4]=g*M-v,u[8]=f*M+m,u[1]=g*M+v,u[5]=r*r*M+a,u[9]=d*M-p,u[2]=f*M-m,u[6]=d*M+p,u[10]=s*s*M+a}return u},r=function(t,e,i,r){var s,o,h,a=[];return s=r?t:YFM.Math.deg2Radian(t),o=Math.cos(s),h=Math.sin(s),a.push(o),a.push(h),a.push(0),a.push(0),a.push(-h),a.push(o),a.push(0),a.push(0),a.push(0),a.push(0),a.push(1),a.push(0),a.push(e*(1-o)+i*h),a.push(i*(1-o)-e*h),a.push(0),a.push(1),a},s=function(t,e,i){var r,s,o,h,a,n,u,l=[];return r=i?t:YFM.Math.deg2Radian(t),s=Math.cos(r),o=Math.sin(r),h=1-s,l.push(NaN*h+s),l.push(NaN*h+u*o),l.push(NaN*h-n*o),l.push(0),l.push(NaN*h-u*o),l.push(NaN*h+s),l.push(NaN*h+a*o),l.push(0),l.push(NaN*h+n*o),l.push(NaN*h-a*o),l.push(NaN*h+s),l.push(0),l.push(0),l.push(0),l.push(0),l.push(1),l},o=function(t,e,i){var r=[];return r.push(1),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),r.push(0),r.push(t),r.push(e),r.push(i),r.push(1),r},h=function(t,e){t[14]=e},a=function(t,e,i,r){var s=[];return s.push(t),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t),s.push(0),s.push(e*(1-t)),s.push(i*(1-t)),s.push(r*(1-t)),s.push(1),s},n=function(t,e,i,r){var s=[];return s.push(t[0]),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t[1]),s.push(0),s.push(0),s.push(0),s.push(0),s.push(t[2]),s.push(0),s.push(e*(1-t[0])),s.push(i*(1-t[1])),s.push(r*(1-t[2])),s.push(1),s},u=function(t,e){var i,r,s,o,h,a,n,u=[];for(a=t.slice(0),n=e.slice(0),h=0;h<4;h++)i=n[4*h+0],r=n[4*h+1],s=n[4*h+2],o=n[4*h+3],u.push(i*a[0]+r*a[4]+s*a[8]+o*a[12]),u.push(i*a[1]+r*a[5]+s*a[9]+o*a[13]),u.push(i*a[2]+r*a[6]+s*a[10]+o*a[14]),u.push(i*a[3]+r*a[7]+s*a[11]+o*a[15]);return u},l=function(t,e,i,r){var s,o,h;for(o=0;o<t;o++)e[o]=r[t-1][o];for(s=t-1;s>0;s--){var a=0,n=0;for(h=0;h<s;h++)a+=Math.abs(e[h]);if(0==a)for(i[s]=e[s-1],o=0;o<s;o++)e[o]=r[s-1][o],r[s][o]=0,r[o][s]=0;else{for(h=0;h<s;h++)e[h]/=a,n+=e[h]*e[h];var u=e[s-1],l=Math.sqrt(n);for(u>0&&(l=-l),i[s]=a*l,n-=u*l,e[s-1]=u-l,o=0;o<s;o++)i[o]=0;for(o=0;o<s;o++){for(u=e[o],r[o][s]=u,l=i[o]+r[o][o]*u,h=o+1;h<=s-1;h++)l+=r[h][o]*e[h],i[h]+=r[h][o]*u;i[o]=l}for(u=0,o=0;o<s;o++)i[o]/=n,u+=i[o]*e[o];var c=u/(n+n);for(o=0;o<s;o++)i[o]-=c*e[o];for(o=0;o<s;o++){for(u=e[o],l=i[o],h=o;h<=s-1;h++)r[h][o]-=u*i[h]+l*e[h];e[o]=r[s-1][o],r[s][o]=0}}e[s]=n}for(s=0;s<t-1;s++){r[t-1][s]=r[s][s],r[s][s]=1;var n=e[s+1];if(0!=n){for(h=0;h<=s;h++)e[h]=r[h][s+1]/n;for(o=0;o<=s;o++){var l=0;for(h=0;h<=s;h++)l+=r[h][s+1]*r[h][o];for(h=0;h<=s;h++)r[h][o]-=l*e[h]}}for(h=0;h<=s;h++)r[h][s+1]=0}for(o=0;o<t;o++)e[o]=r[t-1][o],r[t-1][o]=0;r[t-1][t-1]=1,i[0]=0},c=function(t,e,i,r){var s,o,h,a,n,u;for(s=1;s<t;s++)i[s-1]=i[s];i[t-1]=0;var l=0,c=0,M=Math.pow(2,-52);for(a=0;a<t;a++){for(c=Math.max(c,Math.abs(e[a])+Math.abs(i[a])),n=a;n<t&&!(Math.abs(i[n])<=M*c);)n++;if(n>a){u=0;do{if((u+=1)>=7)break;var g=e[a],d=(e[a+1]-g)/(2*i[a]),f=Math.hypot(d,1);d<0&&(f=-f),e[a]=i[a]/(d+f),e[a+1]=i[a]*(d+f);var p=e[a+1],m=g-e[a];for(s=a+2;s<t;s++)e[s]-=m;l+=m,d=e[n];var v=1,F=v,x=v,_=i[a+1],Y=0,V=0;for(s=n-1;s>=a;s--)for(x=F,F=v,V=Y,g=v*i[s],m=v*d,f=Math.hypot(d,i[s]),i[s+1]=Y*f,Y=i[s]/f,v=d/f,d=v*e[s]-Y*g,e[s+1]=m+Y*(v*g+Y*e[s]),h=0;h<t;h++)m=r[h][s+1],r[h][s+1]=Y*r[h][s]+v*m,r[h][s]=v*r[h][s]-Y*m;d=-Y*V*x*_*i[a]/p,i[a]=Y*d,e[a]=v*d}while(Math.abs(i[a])>M*c)}e[a]=e[a]+l,i[a]=0}for(s=0;s<t-1;s++){h=s;var d=e[s];for(o=s+1;o<t;o++)e[o]<d&&(h=o,d=e[o]);if(h!=s)for(e[h]=e[s],e[s]=d,o=0;o<t;o++)d=r[o][s],r[o][s]=r[o][h],r[o][h]=d}};return{mat:t,matClone:e,rotate3d:i,rotateXY:r,translate:o,rotateAxis:s,scale:a,scaleXYZ:n,mul:u,mulVec:function(t,e){var i,r,s,o,h=[];return i=e[0],r=e[1],s=e[2],o=e[3],h.push(i*t[0]+r*t[4]+s*t[8]+o*t[12]),h.push(i*t[1]+r*t[5]+s*t[9]+o*t[13]),h.push(i*t[2]+r*t[6]+s*t[10]+o*t[14]),h.push(i*t[3]+r*t[7]+s*t[11]+o*t[15]),h},postTranslate:function(t,e,i,r){var s=o(e,i,r);return u(s,t)},postRotateXY:function(t,e,i,s,o){var h=r(e,i,s,o);return u(h,t)},postRotate3d:function(t,e,r,s,o,h){var a=i(e,r,s,o,h);return u(a,t)},postScale:function(t,e,i,r,s){var o=a(e,i,r,s);return u(o,t)},preTranslate:function(t,e,i,r){var s=o(e,i,r);return u(t,s)},preRotateXY:function(t,e,i,s,o){var h=r(e,i,s,o);return u(t,h)},preRotate3d:function(t,e,r,s,o,h){var a=i(e,r,s,o,h);return u(t,a)},preScale:function(t,e,i,r,s){var o=a(e,i,r,s);return u(t,o)},transpose:function(t){var e=[];return e.push(t[0]),e.push(t[4]),e.push(t[8]),e.push(t[12]),e.push(t[1]),e.push(t[5]),e.push(t[9]),e.push(t[13]),e.push(t[2]),e.push(t[6]),e.push(t[10]),e.push(t[14]),e.push(t[3]),e.push(t[7]),e.push(t[11]),e.push(t[15]),e},invert:function(t){var e=t[0],i=t[1],r=t[2],s=t[3],o=t[4],h=t[5],a=t[6],n=t[7],u=t[8],l=t[9],c=t[10],M=t[11],g=t[12],d=t[13],f=t[14],p=t[15],m=e*h-i*o,v=e*a-r*o,F=e*n-s*o,x=i*a-r*h,_=i*n-s*h,Y=r*n-s*a,V=u*d-l*g,R=u*f-c*g,y=u*p-M*g,P=l*f-c*d,T=l*p-M*d,b=c*p-M*f,A=m*b-v*T+F*P+x*y-_*R+Y*V;if(0!=A){var L=[];return L.push((h*b-a*T+n*P)/A),L.push((r*T-i*b-s*P)/A),L.push((d*Y-f*_+p*x)/A),L.push((c*_-l*Y-M*x)/A),L.push((a*y-o*b-n*R)/A),L.push((e*b-r*y+s*R)/A),L.push((f*F-g*Y-p*v)/A),L.push((u*Y-c*F+M*v)/A),L.push((o*T-h*y+n*V)/A),L.push((i*y-e*T-s*V)/A),L.push((g*_-d*F+p*m)/A),L.push((l*F-u*_-M*m)/A),L.push((h*R-o*P-a*V)/A),L.push((e*P-i*R+r*V)/A),L.push((d*v-g*x-f*m)/A),L.push((u*x-l*v+c*m)/A),L}return null},orthographic:function(e,i,r,s,o,h){var a=t(),n=1/(i-e),u=1/(s-r),l=1/(h-o),c=2*n,M=2*u,g=-2*l,d=-(i+e)*n,f=-(s+r)*u,p=-(h+o)*l;return a[0]=c,a[5]=M,a[10]=g,a[12]=d,a[13]=f,a[14]=p,a[15]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[11]=0,a},perspective:function(t,e,i,r){var s=[],o=1/Math.tan(t*(Math.PI/360)),h=1/(i-r);return s.push(o/e),s.push(0),s.push(0),s.push(0),s.push(0),s.push(o),s.push(0),s.push(0),s.push(0),s.push(0),s.push((r+i)*h),s.push(-1),s.push(0),s.push(0),s.push(2*r*i*h),s.push(0),s},setTranslateZ:h,covariance3x3:function(t){var e,i,r,s,o,h,a,n,u,l,c,M,g,d,f=[];for(n=t.length,s=0,o=0,h=0,a=0;a<n;a++)s+=t[a][0],o+=t[a][1],h+=t[a][2];for(s/=n,o/=n,h/=n,u=0,l=0,c=0,M=0,g=0,d=0,a=0;a<n;a++)e=t[a][0],i=t[a][1],r=t[a][2],u+=(e-s)*(e-s),l+=(i-o)*(i-o),c+=(r-h)*(r-h),M+=(e-s)*(i-o),g+=(e-s)*(r-h),d+=(i-o)*(r-h);return u/=n,l/=n,c/=n,M/=n,g/=n,d/=n,f.push(u),f.push(M),f.push(g),f.push(M),f.push(l),f.push(d),f.push(g),f.push(d),f.push(c),f},eig3x3:function(t){var e,i,r,s=[],o=[];if(t[3]!=t[1]||t[6]!=t[2]||t[7]!=t[5])throw new Error("matrix is not symmetric");return e=[],e.push(new Array(t[0],t[3],t[6])),e.push(new Array(t[1],t[4],t[7])),e.push(new Array(t[2],t[5],t[8])),i=new Array(0,0,0),r=new Array(0,0,0),l(3,i,r,e),c(3,i,r,e),s.push(i[0]),s.push(i[1]),s.push(i[2]),o.push(e[0][0]),o.push(e[1][0]),o.push(e[2][0]),o.push(e[0][1]),o.push(e[1][1]),o.push(e[2][1]),o.push(e[0][2]),o.push(e[1][2]),o.push(e[2][2]),{value:s,vec:o}},eulerParamExtract:function(t){var e,i,r;return e=Math.atan2(-t[2],t[10]),i=Math.asin(t[6]),r=Math.atan2(-t[4],t[5]),new Euler(i,e,r)},eulerParamExtractX:function(t){return Math.asin(t[6])},eulerParamExtractY:function(t){return Math.atan2(-t[2],t[10])},eulerParamExtractZ:function(t){return Math.atan2(-t[4],t[5])},rotationFromQuaternion:function(e){var i=t(),r=e.x,s=e.y,o=e.z,h=e.w,a=r+r,n=s+s,u=o+o,l=r*a,c=r*n,M=r*u,g=s*n,d=s*u,f=o*u,p=h*a,m=h*n,v=h*u;return i[0]=1-(g+f),i[1]=c-v,i[2]=M+m,i[3]=0,i[4]=c+v,i[5]=1-(l+f),i[6]=d-p,i[7]=0,i[8]=M-m,i[9]=d+p,i[10]=1-(l+g),i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}}}(),Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],Euler.DefaultOrder="ZXY",Euler.prototype={constructor:Euler,setFromMatrix:function(t,e,i){var r=YFM.Math.clamp,s=t[0],o=t[4],h=t[8],a=t[1],n=t[5],u=t[9],l=t[2],c=t[6],M=t[10];return e=e||this.order,"XYZ"===e?(this.y=Math.asin(r(h,-1,1)),Math.abs(h)<.99999?(this.x=Math.atan2(-u,M),this.z=Math.atan2(-o,s)):(this.x=Math.atan2(c,n),this.z=0)):"YXZ"===e?(this.x=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(this.y=Math.atan2(h,M),this.z=Math.atan2(a,n)):(this.y=Math.atan2(-l,s),this.z=0)):"ZXY"===e?(this.x=Math.asin(r(c,-1,1)),Math.abs(c)<.99999?(this.y=Math.atan2(-l,M),this.z=Math.atan2(-o,n)):(this.y=0,this.z=Math.atan2(a,s))):"ZYX"===e?(this.y=Math.asin(-r(l,-1,1)),Math.abs(l)<.99999?(this.x=Math.atan2(c,M),this.z=Math.atan2(a,s)):(this.x=0,this.z=Math.atan2(-o,n))):"YZX"===e?(this.z=Math.asin(r(a,-1,1)),Math.abs(a)<.99999?(this.x=Math.atan2(-u,n),this.y=Math.atan2(-l,s)):(this.x=0,this.y=Math.atan2(h,M))):"XZY"===e?(this.z=Math.asin(-r(o,-1,1)),Math.abs(o)<.99999?(this.x=Math.atan2(c,n),this.y=Math.atan2(h,s)):(this.x=Math.atan2(-u,M),this.y=0)):console.warn("setFromRotationMatrix() given unsupported order: "+e),this.order=e,this}},Quaternion.prototype={constructor:Quaternion,toString:function(t){var e="(";return e=e+this.x.toFixed(t)+", ",e=e+this.y.toFixed(t)+", ",e=e+this.z.toFixed(t)+", ",e=e+this.w.toFixed(t)+")"},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},setFromEuler:function(t){var e=t.x,i=t.y,r=t.z,s=t.order,o=Math.cos,h=Math.sin,a=o(e/2),n=o(i/2),u=o(r/2),l=h(e/2),c=h(i/2),M=h(r/2);return"XYZ"===s?(this.x=l*n*u+a*c*M,this.y=a*c*u-l*n*M,this.z=a*n*M+l*c*u,this.w=a*n*u-l*c*M):"YXZ"===s?(this.x=l*n*u+a*c*M,this.y=a*c*u-l*n*M,this.z=a*n*M-l*c*u,this.w=a*n*u+l*c*M):"ZXY"===s?(this.x=l*n*u-a*c*M,this.y=a*c*u+l*n*M,this.z=a*n*M+l*c*u,this.w=a*n*u-l*c*M):"ZYX"===s?(this.x=l*n*u-a*c*M,this.y=a*c*u+l*n*M,this.z=a*n*M-l*c*u,this.w=a*n*u+l*c*M):"YZX"===s?(this.x=l*n*u+a*c*M,this.y=a*c*u+l*n*M,this.z=a*n*M-l*c*u,this.w=a*n*u-l*c*M):"XZY"===s&&(this.x=l*n*u-a*c*M,this.y=a*c*u-l*n*M,this.z=a*n*M+l*c*u,this.w=a*n*u+l*c*M),this},setFromAxisAngle:function(t,e){var i=e/2,r=Math.sin(i);return this.x=t[0]*r,this.y=t[1]*r,this.z=t[2]*r,this.w=Math.cos(i),this},setFromRotationMatrix:function(t){var e,i=t[0],r=t[4],s=t[8],o=t[1],h=t[5],a=t[9],n=t[2],u=t[6],l=t[10],c=i+h+l;return c>0?(e=.5/Math.sqrt(c+1),this.w=.25/e,this.x=(u-a)*e,this.y=(s-n)*e,this.z=(o-r)*e):i>h&&i>l?(e=2*Math.sqrt(1+i-h-l),this.w=(u-a)/e,this.x=.25*e,this.y=(r+o)/e,this.z=(s+n)/e):h>l?(e=2*Math.sqrt(1+h-i-l),this.w=(s-n)/e,this.x=(r+o)/e,this.y=.25*e,this.z=(a+u)/e):(e=2*Math.sqrt(1+l-i-h),this.w=(o-r)/e,this.x=(s+n)/e,this.y=(a+u)/e,this.z=.25*e),this},inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var t=this.length();return 0===t?(this.x=0,this.y=0,this.z=0,this.w=1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this},multiply:function(t){return this.multiplyQuaternions(this,t)},premultiply:function(t){return this.multiplyQuaternions(t,this)},multiplyQuaternions:function(t,e){var i=t.x,r=t.y,s=t.z,o=t.w,h=e.x,a=e.y,n=e.z,u=e.w;return this.x=i*u+o*h+r*n-s*a,this.y=r*u+o*a+s*h-i*n,this.z=s*u+o*n+i*a-r*h,this.w=o*u-i*h-r*a-s*n,this},slerp:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this.x,r=this.y,s=this.z,o=this.w,h=o*t.w+i*t.x+r*t.y+s*t.z;if(h<0?(this.w=-t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,h=-h):this.copy(t),h>=1)return this.w=o,this.x=i,this.y=r,this.z=s,this;var a=Math.sqrt(1-h*h);if(Math.abs(a)<.001)return this.w=.5*(o+this.w),this.x=.5*(i+this.x),this.y=.5*(r+this.y),this.z=.5*(s+this.z),this;var n=Math.atan2(a,h),u=Math.sin((1-e)*n)/a,l=Math.sin(e*n)/a;return this.w=o*u+this.w*l,this.x=i*u+this.x*l,this.y=r*u+this.y*l,this.z=s*u+this.z*l,this}},YFM.Math.Line=function(){var t=function(t,e,i,r,s,o){var h=[];return h.push(t),h.push(e),h.push(i),h.push(1),h.push(r),h.push(s),h.push(o),h.push(0),h},e=function(t,e){var i=[];return i.push(t[0]),i.push(t[1]),i.push(t[2]),i.push(1),i.push(e[0]),i.push(e[1]),i.push(e[2]),i.push(0),i},i=function(t,e){var i=[];return i.push(t[0]),i.push(t[1]),i.push(t[2]),i.push(1),i.push(e[0]-t[0]),i.push(e[1]-t[1]),i.push(e[2]-t[2]),i.push(0),i},r=function(t,e){return YFM.Math.Vector.pos(t[0]+t[4]*e,t[1]+t[5]*e,t[2]+t[6]*e)},s=function(t,e){var i=YFM.Math.Vector.pos(t[0],t[1],t[2]),r=YFM.Math.Vector.vec(t[4],t[5],t[6]),s=YFM.Math.Vector.sub(e,i),o=YFM.Math.Vector.dot3(s,r)/YFM.Math.Vector.dot3(r,r);return o<=0?i:o>=1?YFM.Math.Vector.add(i,r):YFM.Math.Vector.pos(t[0]+t[4]*o,t[1]+t[5]*o,t[2]+t[6]*o)},o=function(t,e,i,r){var s,o,h,a,n,u;return o=YFM.Math.Vector.pos(e,i,r),h=YFM.Math.Vector.sub(o,t),s=YFM.Math.Vector.vec(t[4],t[5],t[6]),n=YFM.Math.Vector.dot3(h,s),n*=n,a=YFM.Math.Vector.norm3SQ(h),u=YFM.Math.Vector.norm3SQ(s),a-n/u},h=function(t,e,i,r){return Math.sqrt(o(t,e,i,r))},a=function(t,e){var i,r,s,o,h,a,n,u,l,c,M=[],g=[],d=[];return l=YFM.Math.Vector.vec(t[4],t[5],t[6]),c=YFM.Math.Vector.vec(e[4],e[5],e[6]),s=YFM.Math.Vector.dot3(l,c),a=YFM.Math.Vector.norm3SQ(l),n=YFM.Math.Vector.norm3SQ(c),r=s*s-a*n,i=YFM.Math.floatEquals(r,0),0==i&&(u=YFM.Math.Vector.sub(e,t),o=YFM.Math.Vector.dot3(u,l),h=YFM.Math.Vector.dot3(u,c),g.push(o),g.push(h),M.push(-YFM.Math.Vector.norm3SQ(c)),M.push(-s),M.push(s),M.push(YFM.Math.Vector.norm3SQ(l)),d.push(g[0]*M[0]+g[1]*M[2]),d.push(g[0]*M[1]+g[1]*M[3]),d[0]/=r,d[1]/=r),{parallel:i,t:d}};return{line:t,lineSV:e,linePP:i,getPoint:r,projection:s,distancePointSQ:o,distancePoint:h,distanceLinesRaw:a,distanceLines:function(t,e){var i,s,o,n;return s=a(t,e),s.parallel?i=h(t,e[0],e[1],e[2]):(o=r(t,s.t[0]),n=r(e,s.t[1]),i=YFM.Math.Vector.distance(o,n)),{parallel:void 0,distance:i}}}}(),YFM.Math.Plane=function(){var t=function(t,e,i,r,s,o){var h=YFM.Math.Vector.pos(t,e,i),a=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(r,s,o)),n=-YFM.Math.Vector.dot3(a,h);return a[3]=n,a};return{plane:t,planePN:function(e,i){return t(e[0],e[1],e[2],i[0],i[1],i[2])},planeRaw:function(t,e,i,r){return YFM.Math.Vector.vec(t,e,i,r)},transform:function(t,e){var i,r=YFM.Math.Matrix.invert(e);if(null==r)throw new Error("transform a plane with a singular matrix");return i=YFM.Math.Matrix.transpose(r),YFM.Math.Matrix.mulVec(i,t)},distance:function(t,e,i,r){var s=YFM.Math.Vector.pos(e,i,r);return YFM.Math.Vector.dot4(t,s)},intersectionLine:function(t,e){var i,r,s=YFM.Math.Vector.pos(e[0],e[1],e[2]),o=YFM.Math.Vector.vec(e[4],e[5],e[6]);if(i=YFM.Math.Vector.dot4(t,s),r=YFM.Math.Vector.dot4(t,o),YFM.Math.floatEquals(r,0))throw new Error("Calc intersection of a line parallel to a plane");return-i/r},intersectionPlane:function(t,e){var i,r,s,o,h;if(o=YFM.Math.Vector.cross(t,e),i=Math.floatEquals(0,YFM.Math.Vector.norm3(o)))return{parallel:i};if(r=[],r.push(t[0]),r.push(e[0]),r.push(o[0]),r.push(0),r.push(t[1]),r.push(e[1]),r.push(o[1]),r.push(0),r.push(t[2]),r.push(e[2]),r.push(o[2]),r.push(0),r.push(0),r.push(0),r.push(0),r.push(1),null==(s=YFM.Math.Matrix.invert(r)))throw new Error("nv matrix is singular");return h=YFM.Math.Matrix.mulVec(s,YFM.Math.Vector.pos(-t[3],-e[3],0)),{parallel:i,line:YFM.Math.Line.lineSV(h,o)}},intersectionTriplePlane:function(t,e,i){var r,s,o,h;return s=[],s.push(t[0]),s.push(e[0]),s.push(i[0]),s.push(0),s.push(t[1]),s.push(e[1]),s.push(i[1]),s.push(0),s.push(t[2]),s.push(e[2]),s.push(i[2]),s.push(0),s.push(0),s.push(0),s.push(0),s.push(1),o=YFM.Math.Matrix.invert(s),r=null==o,r?{atAPoint:!1}:(h=YFM.Math.Matrix.mulVec(o,YFM.Math.Vector.pos(-t[3],-e[3],-i[3])),{atAPoint:!0,point:h})}}}(),LDS=function(){var t=function(t,e){var i,r,s;for(i=r=1/t,s=0;e>0;)s+=i*(e%t),i*=r,e=Math.floor(e/t);return s},e=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,57],i=function(t){if(t<0||t>e.length)throw new Error("nthPrimeNumber index out of range");return e[t]};return{halton:function(e,r){return t(i(e),r)}}}(),FrustumWorldSpace.prototype={constructor:FrustumWorldSpace,update:function(t){this.left[0]=t[3]+t[0],this.left[1]=t[7]+t[4],this.left[2]=t[11]+t[8],this.left[3]=t[15]+t[12],this.right[0]=t[3]-t[0],this.right[1]=t[7]-t[4],this.right[2]=t[11]-t[8],this.right[3]=t[15]-t[12],this.bottom[0]=t[3]+t[1],this.bottom[1]=t[7]+t[5],this.bottom[2]=t[11]+t[9],this.bottom[3]=t[15]+t[13],this.top[0]=t[3]-t[1],this.top[1]=t[7]-t[5],this.top[2]=t[11]-t[9],this.top[3]=t[15]-t[13],this.near[0]=t[3]+t[2],this.near[1]=t[7]+t[6],this.near[2]=t[11]+t[10],this.near[3]=t[15]+t[14],this.far[0]=t[3]-t[2],this.far[1]=t[7]-t[6],this.far[2]=t[11]-t[10],this.far[3]=t[15]-t[14]},containCheckPoint:function(t){if(t.isOBB)return-1!==t.frustumCheck(this);var e=!1;do{if(YFM.Math.Vector.dot4(this.near,t)<0)break;if(YFM.Math.Vector.dot4(this.far,t)<0)break;if(YFM.Math.Vector.dot4(this.left,t)<0)break;if(YFM.Math.Vector.dot4(this.right,t)<0)break;if(YFM.Math.Vector.dot4(this.bottom,t)<0)break;if(YFM.Math.Vector.dot4(this.top,t)<0)break;e=!0}while(!1);return e}},OBB.prototype={constructor:OBB,transform:function(t){var e=YFM.Math.Matrix,i=YFM.Math.Vector,r=YFM.Math.Matrix.invert(t),s=YFM.Math.Matrix.transpose(r);this.center=e.mulVec(t,this.center),this.r=this._reserse3(e.mulVec(t,this.r)),this.s=this._reserse3(e.mulVec(t,this.s)),this.t=this._reserse3(e.mulVec(t,this.t)),this.R=this._reserse3(e.mulVec(t,this.R)),this.S=this._reserse3(e.mulVec(t,this.S)),this.T=this._reserse3(e.mulVec(t,this.T)),this.r_max=e.mulVec(s,this.r_min),this.r_min=e.mulVec(s,this.r_max),this.s_max=e.mulVec(s,this.s_min),this.s_min=e.mulVec(s,this.s_max),this.t_max=e.mulVec(s,this.t_min),this.t_min=e.mulVec(s,this.t_max),this.r_half=this._reserse4(e.mulVec(s,this.r_half)),this.s_half=this._reserse4(e.mulVec(s,this.s_half)),this.t_half=this._reserse4(e.mulVec(s,this.t_half)),this.hr=i.norm3(this.R)/2,this.hs=i.norm3(this.S)/2,this.ht=i.norm3(this.T)/2},pointCheck:function(t){if(t.isOBB)return this.obbCheck(t);var e,i,r,s;e=0,i=0,r=0;do{if((s=YFM.Math.Plane.distance(this.r_min,t))<0){e++;break}if(s>0?i++:r++,(s=YFM.Math.Plane.distance(this.r_max,t))<0){e++;break}if(s>0?i++:r++,(s=YFM.Math.Plane.distance(this.s_min,t))<0){e++;break}if(s>0?i++:r++,(s=YFM.Math.Plane.distance(this.s_max,t))<0){e++;break}if(s>0?i++:r++,(s=YFM.Math.Plane.distance(this.t_min,t))<0){e++;break}if(s>0?i++:r++,(s=YFM.Math.Plane.distance(this.t_max,t))<0){e++;break}s>0?i++:r++,ret=!0}while(!1);return 6==i?1:e>0?-1:0},lineCheck:function(t){var e,i,r,s,o,h,a,n,u,l;if(s=Number.MAX_VALUE,o=-Number.MAX_VALUE,e=YFM.Math.Vector.pos(t[0],t[1],t[2]),i=YFM.Math.Vector.normalize(YFM.Math.Vector.vec(t[4],t[5],t[6])),r=YFM.Math.Vector.sub(this.center,e),n=YFM.Math.Vector.dot3(this.r,r),u=YFM.Math.Vector.dot3(this.r,i),YFM.Math.floatNotZero(u)){if(h=(n+this.hr)/u,a=(n-this.hr)/u,h>a&&(l=a,a=h,h=l),h>o&&(o=h),a<s&&(s=a),o>s)return!1;if(s<0)return!1}else if(-n-this.hr>0||-n+this.hr<0)return!1;if(n=YFM.Math.Vector.dot3(this.s,r),u=YFM.Math.Vector.dot3(this.s,i),YFM.Math.floatNotZero(u)){if(h=(n+this.hs)/u,a=(n-this.hs)/u,h>a&&(l=a,a=h,h=l),h>o&&(o=h),a<s&&(s=a),o>s)return!1;if(s<0)return!1}else if(-n-this.hs>0||-n+this.hs<0)return!1;if(n=YFM.Math.Vector.dot3(this.t,r),u=YFM.Math.Vector.dot3(this.t,i),YFM.Math.floatNotZero(u)){if(h=(n+this.ht)/u,a=(n-this.ht)/u,h>a&&(l=a,a=h,h=l),h>o&&(o=h),a<s&&(s=a),o>s)return!1;if(s<0)return!1}else if(-n-this.ht>0||-n+this.ht<0)return!1;return!0},obbCheck:function(t){var e,i,r,s,o;e=0,i=0,r=0;do{if(s=t.effectiveRadius(this.r_min),(o=YFM.Math.Plane.distance(this.r_min,t.center))<-s){e++;break}if(o>s?i++:r++,s=t.effectiveRadius(this.r_max),(o=YFM.Math.Plane.distance(this.r_max,t.center))<-s){e++;break}if(o>s?i++:r++,s=t.effectiveRadius(this.s_min),(o=YFM.Math.Plane.distance(this.s_min,t.center))<-s){e++;break}if(o>s?i++:r++,s=t.effectiveRadius(this.s_max),o=YFM.Math.Plane.distance(this.s_max,t.center),o<-s?e++:o>s?i++:r++,s=t.effectiveRadius(this.t_min),(o=YFM.Math.Plane.distance(this.t_min,t.center))<-s){e++;break}if(o>s?i++:r++,s=t.effectiveRadius(this.t_max),(o=YFM.Math.Plane.distance(this.t_max,t.center))<-s){e++;break}o>s?i++:r++}while(!1);return 6==i?1:e>0?-1:0},frustumCheck:function(t){var e,i,r,s,o;e=0,i=0,r=0;do{if(s=this.effectiveRadius(t.near),(o=YFM.Math.Plane.distance(t.near,this.center))<-s){e++;break}if(o>s?i++:r++,s=this.effectiveRadius(t.far),(o=YFM.Math.Plane.distance(t.far,this.center))<-s){e++;break}if(o>s?i++:r++,s=this.effectiveRadius(t.left),(o=YFM.Math.Plane.distance(t.left,this.center))<-s){e++;break}if(o>s?i++:r++,s=this.effectiveRadius(t.right),o=YFM.Math.Plane.distance(t.right,this.center),o<-s?e++:o>s?i++:r++,s=this.effectiveRadius(t.bottom),(o=YFM.Math.Plane.distance(t.bottom,this.center))<-s){e++;break}if(o>s?i++:r++,s=this.effectiveRadius(t.top),(o=YFM.Math.Plane.distance(t.top,this.center))<-s){e++;break}o>s?i++:r++}while(!1);return 6==i?1:e>0?-1:0},effectiveRadius:function(t){return(Math.abs(YFM.Math.Vector.dot3(this.R,t))+Math.abs(YFM.Math.Vector.dot3(this.S,t))+Math.abs(YFM.Math.Vector.dot3(this.T,t)))/2},_reserse3:function(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t},_reserse4:function(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t[3]=-t[3],t},_calc_bounding:function(t){var e,i,r,s,o,h,a,n,u,l,c,M,g,d,f,p;for(h=Number.MAX_VALUE,a=-Number.MAX_VALUE,n=Number.MAX_VALUE,u=-Number.MAX_VALUE,l=Number.MAX_VALUE,c=-Number.MAX_VALUE,i=t.length,e=0;e<i;e++)f=t[e],r=YFM.Math.Vector.dot3(f,this.r),s=YFM.Math.Vector.dot3(f,this.s),o=YFM.Math.Vector.dot3(f,this.t),r>a&&(a=r),r<h&&(h=r),s>u&&(u=s),s<n&&(n=s),o>c&&(c=o),o<l&&(l=o);if(this.r_min=YFM.Math.Plane.planeRaw(this.r[0],this.r[1],this.r[2],-h),this.r_max=YFM.Math.Plane.planeRaw(-this.r[0],-this.r[1],-this.r[2],a),this.s_min=YFM.Math.Plane.planeRaw(this.s[0],this.s[1],this.s[2],-n),this.s_max=YFM.Math.Plane.planeRaw(-this.s[0],-this.s[1],-this.s[2],u),this.t_min=YFM.Math.Plane.planeRaw(this.t[0],this.t[1],this.t[2],-l),this.t_max=YFM.Math.Plane.planeRaw(-this.t[0],-this.t[1],-this.t[2],c),M=(h+a)/2,g=(n+u)/2,d=(l+c)/2,this.r_half=YFM.Math.Plane.planeRaw(this.r[0],this.r[1],this.r[2],-M),this.s_half=YFM.Math.Plane.planeRaw(this.s[0],this.s[1],this.s[2],-g),this.t_half=YFM.Math.Plane.planeRaw(this.t[0],this.t[1],this.t[2],-d),this.hr=(a-h)/2,this.hs=(u-n)/2,this.ht=(c-l)/2,this.R=YFM.Math.Vector.scale(this.r,a-h),this.S=YFM.Math.Vector.scale(this.s,u-n),
this.T=YFM.Math.Vector.scale(this.t,c-l),p=YFM.Math.Plane.intersectionTriplePlane(this.r_half,this.s_half,this.t_half),!p.atAPoint)throw new Error("obb calc center failed");this.center=p.point}},TextBlockQuickCheckTree.prototype={constructor:TextBlockQuickCheckTree,reset:function(){this.blockPool=this.blockList,this.blockList=[],this.root.reset()},check:function(t,e,i,r){var s=this.root.check(t,e,i,r);return s||this.root.insert(t,e,i,r),s}},AABBNode.prototype={constructor:AABBNode,reset:function(){this.objList=[],this.children&&(this.children[0].reset(),this.children[1].reset(),this.children[2].reset(),this.children[3].reset())},insert:function(t,e,i,r){if(this._containBox(this.rect,t,e,i,r)){if(this.children){var s=!1;do{if(this.children[0].insert(t,e,i,r))break;if(this.children[1].insert(t,e,i,r))break;if(this.children[2].insert(t,e,i,r))break;if(this.children[3].insert(t,e,i,r))break;s=!0}while(!1);s&&this._insertBlock(t,e,i,r)}else this._insertBlock(t,e,i,r);return!0}return!1},check:function(t,e,i,r){if(!this._intersectBox(this.rect,t,e,i,r))return!1;for(var s=0,o=this.objList.length;s<o;s++)if(this._intersectBox(this.objList[s],t,e,i,r))return!0;if(this.children){if(this.children[0].check(t,e,i,r))return!0;if(this.children[1].check(t,e,i,r))return!0;if(this.children[2].check(t,e,i,r))return!0;if(this.children[3].check(t,e,i,r))return!0}return!1},_insertBlock:function(t,e,i,r){var s;this.tree.blockPool.length>0?(s=this.tree.blockPool.pop(),s[0]=t,s[1]=e,s[2]=i,s[3]=r):s=new Array(t,e,i,r),this.objList.push(s),this.tree.blockList.push(s)},_intersectBox:function(t,e,i,r,s){return!(e>t[2]||r<t[0]||i>t[3]||s<t[1])},_containBox:function(t,e,i,r,s){return e>=t[0]&&i>=t[1]&&r<=t[2]&&s<=t[3]},_splite:function(){this.children=new Array(4);var t=(this.rect[0]+this.rect[2])/2,e=(this.rect[1]+this.rect[3])/2;this.children[0]=new AABBNode(this.tree,this.mask+"0",this.rect[0],this.rect[1],t,e),this.children[1]=new AABBNode(this.tree,this.mask+"1",t,this.rect[1],this.rect[2],e),this.children[2]=new AABBNode(this.tree,this.mask+"2",t,e,this.rect[2],this.rect[3]),this.children[3]=new AABBNode(this.tree,this.mask+"3",this.rect[0],e,t,this.rect[3])}},FloorQuadTree.prototype={constructor:FloorQuadTree,cursor:0,shift:1e4,removeObject:function(t){var e=this.objMap[t.toString()];if(e){for(var i,r=e.node,s=[],o=0,h=r.objectList.length;o<h;o++)i=r.objectList[o],e!==i&&s.push(i);r.objectList=s,r.objectList.length<=0&&r.shrink()}return e},insertObject:function(t,e,i,r,s){var o=FloorQuadTree.prototype.cursor*FloorQuadTree.prototype.shift+this.floor.index;FloorQuadTree.prototype.cursor+=1;var h=this.floor.floorPos2Region(i,r);h[2]+=s;var a={id:o,obj:t,pos:h,floor:e,x:i,y:r,z:s};return this.objMap[o.toString()]=a,this.root.insertObject(a),o},insertObjectOBB:function(t,e){var i=FloorQuadTree.prototype.cursor*FloorQuadTree.prototype.shift+this.floor.index;FloorQuadTree.prototype.cursor+=1;var r={id:i,obj:t,pos:e};return this.objMap[i.toString()]=r,this.root.insertObject(r),i},frustumCheck:function(t){return this.root.frustumCheck(t)},rayCheck:function(t,e,i){var r=[];return this.root.rayCheck(t,e*e,r,i),r},rayCheckOBB:function(t,e,i){var e=[];return this.root.rayCheckOBB(t,e,i),e},render:function(t,e,i,r){this.root.renderCheck(t,e,i,r)},getContainLevel:function(t){var e;return e=this.root.containCheck(t),null!=e?e.level:1024}},FloorQuadNode.prototype={constructor:FloorQuadNode,shrink:function(){this.isNodeEmpty()&&(this.children[0]=null,this.children[1]=null,this.children[2]=null,this.children[3]=null,this.splited=!1,null!==this.parentNode&&this.parentNode.shrink())},isNodeEmpty:function(){return!(this.objectList.length>0)&&(!(null!==this.children[0]&&!this.children[0].isNodeEmpty())&&(!(null!==this.children[1]&&!this.children[1].isNodeEmpty())&&(!(null!==this.children[2]&&!this.children[2].isNodeEmpty())&&!(null!==this.children[3]&&!this.children[3].isNodeEmpty()))))},rayCheckOBB:function(t,e,r){if(this.obb.lineCheck(t)){var s,o=this.objectList.length;for(i=0;i<o;i++)if(s=this.objectList[i].pos,s.isOBB&&s.lineCheck(t)&&(e.push(this.objectList[i]),r))return!0;if(null!==this.children[0]&&this.children[0].rayCheckOBB(t,e,r))return!0;if(null!==this.children[1]&&this.children[1].rayCheckOBB(t,e,r))return!0;if(null!==this.children[2]&&this.children[2].rayCheckOBB(t,e,r))return!0;if(null!==this.children[3]&&this.children[3].rayCheckOBB(t,e,r))return!0}return!1},rayCheck:function(t,e,r,s){if(this.obb.lineCheck(t)){var o,h=this.objectList.length;for(i=0;i<h;i++)if(o=this.objectList[i].pos,YFM.Math.Line.distancePointSQ(t,o[0],o[1],o[2])<=e&&(r.push(this.objectList[i]),s))return!0;if(null!==this.children[0]&&this.children[0].rayCheck(t,e,r,s))return!0;if(null!==this.children[1]&&this.children[1].rayCheck(t,e,r,s))return!0;if(null!==this.children[2]&&this.children[2].rayCheck(t,e,r,s))return!0;if(null!==this.children[3]&&this.children[3].rayCheck(t,e,r,s))return!0}return!1},containCheck:function(t){var e=this.obb.frustumCheck(t);if(-1==e)return null;if(1==e)return this;if(0==e&&null!==this.children[0]){var r=[];r.push(this.children[0].containCheck(t)),r.push(this.children[1].containCheck(t)),r.push(this.children[2].containCheck(t)),r.push(this.children[3].containCheck(t));var s=1024,o=null;for(i=0;i<4;i++)null!==r[i]&&r[i].level<s&&(o=r[i],s=r[i].level);return o}return null},renderEver:function(t,e,i){var r,s;if(0!=(s=this.level>i+1?0:this.level>i?1:1024)){for(r=0;r<4;r++)null!==this.children[r]&&this.children[r].renderEver(t,e,i);for(s>this.objectList.length&&(s=this.objectList.length),r=0;r<s;r++)t(this.objectList[r],e)}},renderCheck:function(t,e,i,r){var s,o;if(0!=(o=this.level>r+1?0:this.level>r?1:1024)){var h=this.obb.frustumCheck(t);if(-1!=h){if(1==h)for(s=0;s<4;s++)null!==this.children[s]&&this.children[s].renderEver(e,i,r);else if(0==h&&this.level<=r)for(s=0;s<4;s++)null!==this.children[s]&&this.children[s].renderCheck(t,e,i,r);for(o>this.objectList.length&&(o=this.objectList.length),s=0;s<o;s++)t.containCheckPoint(this.objectList[s].pos)&&e(this.objectList[s],i)}}},insertObject:function(t){!this.splited&&this.objectList.length<this.THRESHOLD?this._insert2ObjList(t):(this.splited||this._spliteSpace(),this._insertToSubSpace(t))},frustumCheck:function(t){return this.obb.frustumCheck(t)},_insert2ObjList:function(t){t.node=this,this.objectList.push(t)},_spliteSpace:function(){var t,e,i;if(this.splited=!0,!(this.level>=6)){for(this.children[this.NODE_0]=new FloorQuadNode(this,this.floor,this.xmin,(this.xmin+this.xmax)/2,this.ymin,(this.ymin+this.ymax)/2,this.height,this.mask+"0",this.level+1),this.children[this.NODE_1]=new FloorQuadNode(this,this.floor,(this.xmin+this.xmax)/2,this.xmax,this.ymin,(this.ymin+this.ymax)/2,this.height,this.mask+"1",this.level+1),this.children[this.NODE_2]=new FloorQuadNode(this,this.floor,(this.xmin+this.xmax)/2,this.xmax,(this.ymin+this.ymax)/2,this.ymax,this.height,this.mask+"2",this.level+1),this.children[this.NODE_3]=new FloorQuadNode(this,this.floor,this.xmin,(this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2,this.ymax,this.height,this.mask+"3",this.level+1),i=[];this.objectList.length>0;){t=this.objectList.pop();var r=[];for(r.push(this.children[0].obb.pointCheck(t.pos)),r.push(this.children[1].obb.pointCheck(t.pos)),r.push(this.children[2].obb.pointCheck(t.pos)),r.push(this.children[3].obb.pointCheck(t.pos)),e=0;e<4;e++)if(1==r[e]){this.children[e].insertObject(t);break}4==e&&i.push(t)}this.objectList=i}},_insertToSubSpace:function(t){var e=[];if(null!==this.children[0]){e.push(this.children[0].obb.pointCheck(t.pos)),e.push(this.children[1].obb.pointCheck(t.pos)),e.push(this.children[2].obb.pointCheck(t.pos)),e.push(this.children[3].obb.pointCheck(t.pos));for(var i=0;i<4;i++)if(1==e[i])return void this.children[i].insertObject(t)}this._insert2ObjList(t)},THRESHOLD:4,NODE_0:0,NODE_1:1,NODE_2:2,NODE_3:3,LEVEL_COLOR:new Array(YFM.Math.Vector.pos(1,0,0),YFM.Math.Vector.pos(1,.5,0),YFM.Math.Vector.pos(1,1,0),YFM.Math.Vector.pos(0,1,0),YFM.Math.Vector.pos(0,1,1),YFM.Math.Vector.pos(0,0,1),YFM.Math.Vector.pos(.5,0,1),YFM.Math.Vector.pos(0,0,0))},TextBlockQuickCheckTree.prototype={constructor:TextBlockQuickCheckTree,reset:function(){this.blockPool=this.blockList,this.blockList=[],this.root.reset()},check:function(t,e,i,r){var s=this.root.check(t,e,i,r);return s||this.root.insert(t,e,i,r),s}},AABBNode.prototype={constructor:AABBNode,reset:function(){this.objList=[],this.children&&(this.children[0].reset(),this.children[1].reset(),this.children[2].reset(),this.children[3].reset())},insert:function(t,e,i,r){if(this._containBox(this.rect,t,e,i,r)){if(this.children){var s=!1;do{if(this.children[0].insert(t,e,i,r))break;if(this.children[1].insert(t,e,i,r))break;if(this.children[2].insert(t,e,i,r))break;if(this.children[3].insert(t,e,i,r))break;s=!0}while(!1);s&&this._insertBlock(t,e,i,r)}else this._insertBlock(t,e,i,r);return!0}return!1},check:function(t,e,i,r){if(!this._intersectBox(this.rect,t,e,i,r))return!1;for(var s=0,o=this.objList.length;s<o;s++)if(this._intersectBox(this.objList[s],t,e,i,r))return!0;if(this.children){if(this.children[0].check(t,e,i,r))return!0;if(this.children[1].check(t,e,i,r))return!0;if(this.children[2].check(t,e,i,r))return!0;if(this.children[3].check(t,e,i,r))return!0}return!1},_insertBlock:function(t,e,i,r){var s;this.tree.blockPool.length>0?(s=this.tree.blockPool.pop(),s[0]=t,s[1]=e,s[2]=i,s[3]=r):s=new Array(t,e,i,r),this.objList.push(s),this.tree.blockList.push(s)},_intersectBox:function(t,e,i,r,s){return!(e>t[2]||r<t[0]||i>t[3]||s<t[1])},_containBox:function(t,e,i,r,s){return e>=t[0]&&i>=t[1]&&r<=t[2]&&s<=t[3]},_splite:function(){this.children=new Array(4);var t=(this.rect[0]+this.rect[2])/2,e=(this.rect[1]+this.rect[3])/2;this.children[0]=new AABBNode(this.tree,this.mask+"0",this.rect[0],this.rect[1],t,e),this.children[1]=new AABBNode(this.tree,this.mask+"1",t,this.rect[1],this.rect[2],e),this.children[2]=new AABBNode(this.tree,this.mask+"2",t,e,this.rect[2],this.rect[3]),this.children[3]=new AABBNode(this.tree,this.mask+"3",this.rect[0],e,t,this.rect[3])}},PlanePolygon.prototype={constructor:PlanePolygon,intersectionLine:function(t,e){var i,r,s,o,h,a,n;do{if(o=0,(h=YFM.Math.Plane.intersectionLine(this.plane,t))<0){o=1024;break}for(a=YFM.Math.Line.getPoint(t,h),n=YFM.Math.Matrix.invert(e),a=YFM.Math.Matrix.mulVec(n,a),i=this.barrier.length,r=0;r<i;r++)(s=YFM.Math.Plane.distance(this.barrier[r],a[0],a[1],a[2]))<o&&(o=s)}while(!1);return o},_makePlanePts:function(t){var e,i,r,s,o,h;if((h=t.length)<3)throw new Error("polygon pts count < 3");o=0;do{if(i=YFM.Math.Vector.sub(t[(o+1)%h],t[o%h]),s=YFM.Math.Vector.sub(t[(o+2)%h],t[(o+1)%h]),e=YFM.Math.Vector.cross(i,s),!YFM.Math.floatEquals(YFM.Math.Vector.norm3SQ(e),0))break;o++}while(o<h);if(YFM.Math.floatEquals(YFM.Math.Vector.norm3SQ(e),0))throw new Error("polygon degenerate");e=YFM.Math.Vector.normalize(e),o=0;do{i=YFM.Math.Vector.sub(t[(o+1)%h],t[o%h]),r=YFM.Math.Vector.cross(e,i),r=YFM.Math.Vector.normalize(r),this.barrier.push(YFM.Math.Plane.planePN(t[o],r)),o++}while(o<h);return YFM.Math.Plane.planePN(t[0],e)}},Mover.prototype={constructor:Mover,DEFAULT_MASS:1,DEFAULT_MAX_FORCE:4,DEFAULT_MAX_SPEED:4,setMass:function(t){this.mass=t},setMaxForce:function(t){this.maxForce=t},setMaxSpeed:function(t){this.maxSpeed=t},setLocation:function(t,e,i){this.location[0]=t,this.location[1]=e,this.location[2]=i},getLocation:function(){return this.location},update:function(){YFM.Math.Vector.addTo(this.velocity,this.acceleration),YFM.Math.Vector.limitTo(this.velocity,this.maxSpeed),YFM.Math.Vector.addTo(this.location,this.velocity),this.acceleration[0]=0,this.acceleration[1]=0,this.acceleration[2]=0},applyForce:function(t){var e=YFM.Math.Vector.scale(t,1/this.mass);YFM.Math.Vector.addTo(this.acceleration,e)},seek:function(t){var e,i;e=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(t,this.location)),YFM.Math.Vector.scaleTo(this.maxSpeed),i=YFM.Math.Vector.limitTo(YFM.Math.Vector.sub(e,this.velocity),this.maxForce),this.applyForce(i)},flee:function(t){var e,i;e=YFM.Math.Vector.normalize(YFM.Math.Vector.sub(t,this.location)),YFM.Math.Vector.scaleTo(-this.maxSpeed),i=YFM.Math.Vector.limitTo(YFM.Math.Vector.sub(e,this.velocity),this.maxForce),this.applyForce(i)},arrive:function(t,e){var i,r,s,o;return i=YFM.Math.Vector.sub(t,this.location),(s=YFM.Math.Vector.norm3(i))<=e||(i=YFM.Math.Vector.normalize(i),s<100?(o=YFM.Math.map(s,0,100,0,this.maxSpeed),YFM.Math.Vector.scaleTo(i,o)):YFM.Math.Vector.scaleTo(i,this.maxSpeed),r=YFM.Math.Vector.sub(i,this.velocity),YFM.Math.Vector.limitTo(r,this.maxForce),this.applyForce(r),!1)}},YFM.Mesh={},YFM.Mesh.CATEGORY_TETRHEDRON="tetrahedron",YFM.Mesh.CATEGORY_HEXADEDRON="hexahedron",YFM.Mesh.CATEGORY_OCTAHEDRON="octahedron",YFM.Mesh.CATEGORY_DODECAHEDRON="dodecahedron",YFM.Mesh.CATEGORY_ICOSAHEDRON="icosahedron",YFM.Mesh.CATEGORY_SPHERE="SPHERE",MeshBuffer.prototype={constructor:MeshBuffer,addAttribute:function(t,e,i,r){var s=this.gl,o=new Float32Array(e),h=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,h),s.bufferData(s.ARRAY_BUFFER,o,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),this.attributes[t]={vbo:h,size:i,length:e.length/i}},getAttribute:function(t){return this.attributes[t]}},TetrahedronMesh.prototype={constructor:TetrahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._tetrahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_tetrahedron:function(t){var e=[];e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,-1))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,-1))),this._divideTriangle(e[2],e[1],e[0],t),this._divideTriangle(e[0],e[3],e[2],t),this._divideTriangle(e[1],e[3],e[0],t),this._divideTriangle(e[2],e[3],e[1],t)},_divideTriangle:function(t,e,i,r){if(r>0){var s=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),h=YFM.Math.Vector.mix(e,i,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),h=YFM.Math.Vector.normalize(h),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,e,h,r-1),this._divideTriangle(h,i,o,r-1),this._divideTriangle(s,h,o,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},HexahedronMesh.prototype={constructor:HexahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._hexahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_hexahedron:function(t){var e=[],i=Math.sqrt(2)/2;e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,0,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,0,-i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,0,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,i))),e.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,0,i))),this._divideTriangle(e[0],e[1],e[3],t),this._divideTriangle(e[3],e[1],e[2],t),this._divideTriangle(e[4],e[7],e[5],t),this._divideTriangle(e[5],e[7],e[6],t),this._divideTriangle(e[7],e[3],e[6],t),this._divideTriangle(e[6],e[3],e[2],t),this._divideTriangle(e[6],e[2],e[5],t),this._divideTriangle(e[5],e[2],e[1],t),this._divideTriangle(e[4],e[5],e[0],t),this._divideTriangle(e[0],e[5],e[1],t),this._divideTriangle(e[7],e[4],e[0],t),this._divideTriangle(e[0],e[3],e[7],t)},_divideTriangle:function(t,e,i,r){if(r>0){var s=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),h=YFM.Math.Vector.mix(e,i,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),h=YFM.Math.Vector.normalize(h),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,e,h,r-1),this._divideTriangle(h,i,o,r-1),this._divideTriangle(s,h,o,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},OctahedronMesh.prototype={constructor:OctahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._octahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_octahedron:function(t){var e=[];e.push(YFM.Math.Vector.pos(1,0,0)),e.push(YFM.Math.Vector.pos(-1,0,0)),e.push(YFM.Math.Vector.pos(0,1,0)),e.push(YFM.Math.Vector.pos(0,-1,0)),e.push(YFM.Math.Vector.pos(0,0,1)),e.push(YFM.Math.Vector.pos(0,0,-1)),this._divideTriangle(e[0],e[2],e[4],t),this._divideTriangle(e[0],e[4],e[3],t),this._divideTriangle(e[0],e[3],e[5],t),this._divideTriangle(e[0],e[5],e[2],t),this._divideTriangle(e[1],e[2],e[5],t),this._divideTriangle(e[1],e[5],e[3],t),this._divideTriangle(e[1],e[3],e[4],t),this._divideTriangle(e[1],e[4],e[2],t)},_divideTriangle:function(t,e,i,r){if(r>0){var s=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),h=YFM.Math.Vector.mix(e,i,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),h=YFM.Math.Vector.normalize(h),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,e,h,r-1),this._divideTriangle(h,i,o,r-1),this._divideTriangle(s,h,o,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},DodecahedronMesh.prototype={constructor:DodecahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._dodecahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_dodecahedron:function(t){var e=(1+Math.sqrt(5))/2,i=1/e,r=[];r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,-1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,1,1))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-i,-e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-i,e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,i,-e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,i,e))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,-e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-i,e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,-e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(i,e,0))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,-i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,-i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,i))),r.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,i))),this._divideTriangle(r[3],r[11],r[7],t),this._divideTriangle(r[3],r[7],r[15],t),this._divideTriangle(r[3],r[15],r[13],t),this._divideTriangle(r[7],r[19],r[17],t),this._divideTriangle(r[7],r[17],r[6],t),this._divideTriangle(r[7],r[6],r[15],t),this._divideTriangle(r[17],r[4],r[8],t),this._divideTriangle(r[17],r[8],r[10],t),this._divideTriangle(r[17],r[10],r[6],t),this._divideTriangle(r[8],r[0],r[16],t),this._divideTriangle(r[8],r[16],r[2],t),this._divideTriangle(r[8],r[2],r[10],t),this._divideTriangle(r[0],r[12],r[1],t),this._divideTriangle(r[0],r[1],r[18],t),this._divideTriangle(r[0],r[18],r[16],t),this._divideTriangle(r[6],r[10],r[2],t),this._divideTriangle(r[6],r[2],r[13],t),this._divideTriangle(r[6],r[13],r[15],t),this._divideTriangle(r[2],r[16],r[18],t),this._divideTriangle(r[2],r[18],r[3],t),this._divideTriangle(r[2],r[3],r[13],t),this._divideTriangle(r[18],r[1],r[9],t),this._divideTriangle(r[18],r[9],r[11],t),this._divideTriangle(r[18],r[11],r[3],t),this._divideTriangle(r[4],r[14],r[12],t),this._divideTriangle(r[4],r[12],r[0],t),this._divideTriangle(r[4],r[0],r[8],t),this._divideTriangle(r[11],r[9],r[5],t),this._divideTriangle(r[11],r[5],r[19],t),this._divideTriangle(r[11],r[19],r[7],t),this._divideTriangle(r[19],r[5],r[14],t),this._divideTriangle(r[19],r[14],r[4],t),this._divideTriangle(r[19],r[4],r[17],t),this._divideTriangle(r[1],r[12],r[14],t),this._divideTriangle(r[1],r[14],r[5],t),this._divideTriangle(r[1],r[5],r[9],t)},_divideTriangle:function(t,e,i,r){if(r>0){var s=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),h=YFM.Math.Vector.mix(e,i,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),h=YFM.Math.Vector.normalize(h),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,e,h,r-1),this._divideTriangle(h,i,o,r-1),this._divideTriangle(s,h,o,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},IcosahedronMesh.prototype={constructor:IcosahedronMesh,getMeshVBO:function(){return this.meshVBO},getMeshBufSize:function(){return this.meshBufSize},_init:function(t,e){this.mesh=[],this._icosahedron(e),this.meshVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.meshVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(this.mesh,3),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.meshBufSize=this.mesh.length/2,this.mesh=null},_icosahedron:function(t){var e=(1+Math.sqrt(5))/2,i=[];i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-1,-e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(1,-e,0))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,-1,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(0,1,-e))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,-1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(e,0,1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,-1))),i.push(YFM.Math.Vector.normalize(YFM.Math.Vector.pos(-e,0,1))),this._divideTriangle(i[0],i[11],i[5],t),this._divideTriangle(i[0],i[5],i[1],t),this._divideTriangle(i[0],i[1],i[7],t),this._divideTriangle(i[0],i[7],i[10],t),this._divideTriangle(i[0],i[10],i[11],t),this._divideTriangle(i[1],i[5],i[9],t),this._divideTriangle(i[5],i[11],i[4],t),this._divideTriangle(i[11],i[10],i[2],t),this._divideTriangle(i[10],i[7],i[6],t),this._divideTriangle(i[7],i[1],i[8],t),this._divideTriangle(i[3],i[9],i[4],t),this._divideTriangle(i[3],i[4],i[2],t),this._divideTriangle(i[3],i[2],i[6],t),this._divideTriangle(i[3],i[6],i[8],t),this._divideTriangle(i[3],i[8],i[9],t),this._divideTriangle(i[4],i[9],i[5],t),this._divideTriangle(i[2],i[4],i[11],t),this._divideTriangle(i[6],i[2],i[10],t),this._divideTriangle(i[8],i[6],i[7],t),this._divideTriangle(i[9],i[8],i[1],t)},_divideTriangle:function(t,e,i,r){if(r>0){var s=YFM.Math.Vector.mix(t,e,.5),o=YFM.Math.Vector.mix(t,i,.5),h=YFM.Math.Vector.mix(e,i,.5);s=YFM.Math.Vector.normalize(s),o=YFM.Math.Vector.normalize(o),h=YFM.Math.Vector.normalize(h),this._divideTriangle(t,s,o,r-1),this._divideTriangle(s,e,h,r-1),this._divideTriangle(h,i,o,r-1),this._divideTriangle(s,h,o,r-1)}else this._triangle(t,e,i)},_triangle:function(t,e,i){var r=YFM.Math.Vector.sub(e,t),s=YFM.Math.Vector.sub(i,e),o=YFM.Math.Vector.normalize(YFM.Math.Vector.cross(r,s));this.mesh.push(t),this.mesh.push(o),this.mesh.push(e),this.mesh.push(o),this.mesh.push(i),this.mesh.push(o)}},YFM.Mesh.ObjModel={},YFM.Mesh.ObjModel.VPattern=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.NPattern=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.UVPattern=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.FacePattern1=/f( +-?\d+)( +-?\d+)( +-?\d+)( +-?\d+)?/,YFM.Mesh.ObjModel.FacePattern2=/f( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+))?/,YFM.Mesh.ObjModel.FacePattern3=/f( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))( +(-?\d+)\/(-?\d+)\/(-?\d+))?/,YFM.Mesh.ObjModel.FacePattern4=/f( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))( +(-?\d+)\/\/(-?\d+))?/,YFM.Mesh.ObjModel.NsPattern=/Ns( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KaPattern=/Ka( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KdPattern=/Kd( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,YFM.Mesh.ObjModel.KsPattern=/Ks( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,ObjModel.prototype={constructor:ObjModel,setFloor:function(t){this.floor=t},setModelMatrix:function(t){this.modelMatrix=t;var e=YFM.Math.Matrix.mul(this.floor.getFloorMat(),this.modelMatrix);this.obb.transform(e)},render:function(t,e){var i=YFM.Math.Matrix.mul(e,this.modelMatrix),r=YFM.Math.Matrix.transpose(i),s=YFM.Math.Matrix.invert(r);t.setNormalMatrix(s),t.setModelMatrix(this.modelMatrix);for(var o=0,h=this.objects.length;o<h;o++)this.hasMaterials&&this.objects[o].material.mtl?t.setMTL(this.objects[o].material.mtl,this.texturePool):t.setDefaultMTL(),t.drawTriangles(this.objects[o].mesh)},loadURLDir:function(t,e,i,r){this.baseUrl=t;var s,o,h=this;s=t+"/"+e+".mtl",o=t+"/"+e+".obj";var a=new XMLHttpRequest;a.open("GET",s,!0),a.responseType="text",a.onload=function(t){if(200==this.status){h._parseMtl(this.response);var e=new XMLHttpRequest;e.open("GET",o,!0),e.responseType="text",e.onload=function(t){200==this.status?(h._parseObj(this.response),i&&i(h),h.hasMaterials=!0):r&&r(this.status)},e.send()}else r&&r(this.status)},a.send()},loadURLWithMtl:function(t,e,i,r){this.baseUrl=e.substr(0,e.lastIndexOf("/")+1);var s=this,o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="text",o.onload=function(e){if(200==this.status){s._parseMtl(this.response);var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="text",o.onload=function(t){200==this.status?(s._parseObj(this.response),i&&i(s),s.hasMaterials=!0):r&&r(this.status)},o.send()}else r&&r(this.status)},o.send()},loadURL:function(t,e,i){this.baseUrl=t.substr(0,t.lastIndexOf("/")+1);var r=this,s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="text",s.onload=function(t){200==this.status?(r._parseObj(this.response),e&&e(r)):i&&i(this.status)},s.send()},_parseMtl:function(t){for(var e,i=t.split("\n"),r=0;r<i.length;r++){var s,o=i[r];if(o=o.trim(),0!==o.length&&"#"!==o.charAt(0))if(/^newmtl /.test(o)){var h=o.substring(7).trim();e=new MtlItem,this.materials[h]=e}else if(/^map_Kd /.test(o)){var a=o.substring(7).trim();e.setMapKd(a),this.texturePool.addTexture(a,this.baseUrl+"/"+a)}else null!==(s=YFM.Mesh.ObjModel.NsPattern.exec(o))?e.setNs(parseFloat(s[1])):null!==(s=YFM.Mesh.ObjModel.KaPattern.exec(o))?e.setKa(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])):null!==(s=YFM.Mesh.ObjModel.KdPattern.exec(o))?e.setKd(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])):null!==(s=YFM.Mesh.ObjModel.KsPattern.exec(o))&&e.setKs(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]))}},_parseObj:function(t){function e(t){var e=parseInt(t);return 3*(e>=0?e-1:e+c.length/3)}function i(t){var e=parseInt(t);return 3*(e>=0?e-1:e+M.length/3)}function r(t){var e=parseInt(t);return 2*(e>=0?e-1:e+g.length/2)}function s(t,e,i){u.vertices.push(c[t],c[t+1],c[t+2],c[e],c[e+1],c[e+2],c[i],c[i+1],c[i+2])}function o(t,e,i){u.normals.push(M[t],M[t+1],M[t+2],M[e],M[e+1],M[e+2],M[i],M[i+1],M[i+2])}function h(t,e,i){u.uvs.push(g[t],g[t+1],g[e],g[e+1],g[i],g[i+1])}function a(t,a,n,u,l,c,M,g,d,f,p,m){var v=e(t),F=e(a),x=e(n);if(void 0===u)s(v,F,x);else{var _=e(u);s(v,F,_),s(F,x,_)}if(void 0!==l){var v=r(l),F=r(c),x=r(M);if(void 0===u)h(v,F,x);else{var _=r(g);h(v,F,_),h(F,x,_)}}if(void 0!==d){var v=i(d),F=i(f),x=i(p);if(void 0===u)o(v,F,x);else{var _=i(m);o(v,F,_),o(F,x,_)}}}var n,u,l,c=[],M=[],g=[];!1===/^o /gm.test(t)&&(u={vertices:[],normals:[],uvs:[]},l={name:""},n={name:"",geometry:u,material:l},this.objects.push(n));for(var d=t.split("\n"),f=0;f<d.length;f++){var p,m=d[f];m=m.trim(),0!==m.length&&"#"!==m.charAt(0)&&(null!==(p=YFM.Mesh.ObjModel.VPattern.exec(m))?c.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3])):null!==(p=YFM.Mesh.ObjModel.NPattern.exec(m))?M.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3])):null!==(p=YFM.Mesh.ObjModel.UVPattern.exec(m))?g.push(parseFloat(p[1]),parseFloat(p[2])):null!==(p=YFM.Mesh.ObjModel.FacePattern1.exec(m))?a(p[1],p[2],p[3],p[4]):null!==(p=YFM.Mesh.ObjModel.FacePattern2.exec(m))?a(p[2],p[5],p[8],p[11],p[3],p[6],p[9],p[12]):null!==(p=YFM.Mesh.ObjModel.FacePattern3.exec(m))?a(p[2],p[6],p[10],p[14],p[3],p[7],p[11],p[15],p[4],p[8],p[12],p[16]):null!==(p=YFM.Mesh.ObjModel.FacePattern4.exec(m))?a(p[2],p[5],p[8],p[11],void 0,void 0,void 0,void 0,p[3],p[6],p[9],p[12]):/^o /.test(m)?(u={vertices:[],normals:[],uvs:[]},l={name:""},n={name:m.substring(2).trim(),geometry:u,material:l},this.objects.push(n)):/^g /.test(m)||(/^usemtl /.test(m)?(l.name=m.substring(7).trim(),l.mtl=this.materials[l.name]):/^mtllib /.test(m)||/^s /.test(m)))}for(var f=0,v=this.objects.length;f<v;f++){var F=this.objects[f],x=F.geometry,_=new MeshBuffer(this.gl);_.addAttribute("position",x.vertices,3),x.normals.length>0&&_.addAttribute("normal",x.normals,3),x.uvs.length>0&&_.addAttribute("uv",x.uvs,2),F.mesh=_}for(var Y=[],f=0,v=this.objects.length;f<v;f++){for(var c=this.objects[f].geometry.vertices,V=0,R=c.length/3;V<R;V++)Y.push(YFM.Math.Vector.pos(c[3*V+0],c[3*V+1],c[3*V+2]));delete this.objects[f].geometry}this.obb=new OBB(Y)}},MtlItem.prototype={constructor:MtlItem,setNs:function(t){this.Ns=t},setKa:function(t,e,i){this.Ka[0]=t,this.Ka[1]=e,this.Ka[2]=i},setKd:function(t,e,i){this.Kd[0]=t,this.Kd[1]=e,this.Kd[2]=i},setKs:function(t,e,i){this.Ks[0]=t,this.Ks[1]=e,this.Ks[2]=i},setMapKd:function(t){this.mapKd=t},getNs:function(){return this.Ns},getKa:function(){return this.Ka},getKd:function(){return this.Kd},getKs:function(){return this.Ks},getMapKd:function(){return this.mapKd}},RawPanorama.prototype={constructor:RawPanorama,render:function(t,e){null!==this.cubeMap&&(this.gl.enable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.DEPTH_TEST),this.gl.depthFunc(this.gl.LEQUAL),t.setModelMatrix(YFM.Math.Matrix.mul(e,this.modelMat)),t.bindTexture(this.cubeMap),t.drawTriangles(this.cubeVBO,this.cubeSize),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CCW),this.gl.disable(this.gl.CULL_FACE))},setCubeTex:function(t,e,i,r,s,o){var h={
imgList:new Array(6),imgCount:0},a=this;h.imgList[0]=new Image,h.imgList[0].onload=function(){a._handleTextureLoaded(0,h)},h.imgList[0].src=t,h.imgList[1]=new Image,h.imgList[1].onload=function(){a._handleTextureLoaded(1,h)},h.imgList[1].src=e,h.imgList[2]=new Image,h.imgList[2].onload=function(){a._handleTextureLoaded(2,h)},h.imgList[2].src=i,h.imgList[3]=new Image,h.imgList[3].onload=function(){a._handleTextureLoaded(3,h)},h.imgList[3].src=r,h.imgList[4]=new Image,h.imgList[4].onload=function(){a._handleTextureLoaded(4,h)},h.imgList[4].src=s,h.imgList[5]=new Image,h.imgList[5].onload=function(){a._handleTextureLoaded(5,h)},h.imgList[5].src=o},_initCube:function(){var t=this.gl,e=[],i=[YFM.Math.Vector.pos(-5e3,-5e3,5e3),YFM.Math.Vector.pos(-5e3,5e3,5e3),YFM.Math.Vector.pos(5e3,5e3,5e3),YFM.Math.Vector.pos(5e3,-5e3,5e3),YFM.Math.Vector.pos(-5e3,-5e3,-5e3),YFM.Math.Vector.pos(-5e3,5e3,-5e3),YFM.Math.Vector.pos(5e3,5e3,-5e3),YFM.Math.Vector.pos(5e3,-5e3,-5e3)];this._quad(i,e,1,0,3,2),this._quad(i,e,2,3,7,6),this._quad(i,e,3,0,4,7),this._quad(i,e,6,5,1,2),this._quad(i,e,4,5,6,7),this._quad(i,e,5,4,0,1),this.cubeVBO=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.cubeVBO),t.bufferData(t.ARRAY_BUFFER,YFM.Math.flatten(e,3),t.STATIC_DRAW),this.cubeSize=e.length},_quad:function(t,e,i,r,s,o){e.push(t[i]),e.push(t[r]),e.push(t[s]),e.push(t[i]),e.push(t[s]),e.push(t[o])},_makeCubeTex:function(t,e,i,r,s,o){var h=this.gl;null!==this.cubeMap&&h.deleteTexture(this.cubeMap),this.cubeMap=h.createTexture(),h.bindTexture(h.TEXTURE_CUBE_MAP,this.cubeMap),h.texImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,t),h.texImage2D(h.TEXTURE_CUBE_MAP_NEGATIVE_X,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,r),h.texImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_Y,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,e),h.texImage2D(h.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,s),h.texImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_Z,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,i),h.texImage2D(h.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,o),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MAG_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_MIN_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_CUBE_MAP,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE)},_handleTextureLoaded:function(t,e){e.imgCount+=1,6==e.imgCount&&this._makeCubeTex(e.imgList[0],e.imgList[1],e.imgList[2],e.imgList[3],e.imgList[4],e.imgList[5])}},YFM.WebGL=function(){var t=function(t){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+t+"</div></div></td></tr></table>"},e=function(e,r){function s(i){var r=e.parentNode;r&&(r.innerHTML=t(i))}if(!window.WebGLRenderingContext)return s('This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>'),null;var o=i(e,r);return o||s('It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>'),o},i=function(t,e){for(var i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],r=null,s=0;s<i.length;++s){try{r=t.getContext(i[s],e)}catch(t){}if(r)break}return r};return{create3DContext:i,setupWebGL:e,makeShader:function(t,e,i){var r,s;if(r=t.createShader(t.VERTEX_SHADER),t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){var o="Vertex shader failed to compile.  The error log is:<pre>"+t.getShaderInfoLog(r)+"</pre>";return alert(o),-1}if(s=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(s,i),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS)){var o="Fragment shader failed to compile.  The error log is:<pre>"+t.getShaderInfoLog(s)+"</pre>";return alert(o),-1}var h=t.createProgram();if(t.attachShader(h,r),t.attachShader(h,s),t.linkProgram(h),!t.getProgramParameter(h,t.LINK_STATUS)){var o="Shader program failed to link.  The error log is:<pre>"+t.getProgramInfoLog(h)+"</pre>";return alert(o),-1}return h}}}(),window.requestAnimFrame=function(t,e){window.setTimeout(t,1e3/30)},YFM.WebGL.Color=function(){var t=function(t){return((16711680&t)>>16)/255},e=function(t){return((65280&t)>>8)/255},i=function(t){return(255&t)/255},r=function(t){return((4278190080&t)>>>24)/255},s=function(r){return YFM.Math.Vector.pos(t(r),e(r),i(r))};return{hexColorRed:t,hexColorGreen:e,hexColorBlue:i,hexColorAlpha:r,randomHexRGB:function(){return 4278190080|Math.floor(255*Math.random())<<16|Math.floor(255*Math.random())<<8|Math.floor(255*Math.random())},getRGBVec:s}}(),BaseColorProgram.prototype={constructor:BaseColorProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.TRIANGLES,0,e)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},getProgram:function(){return this.program},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nattribute  vec4 aColor;\nuniform mat4 uModelMat;\nuniform mat4 uFloorMat;\nuniform mat4 uRegionMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nuniform float uMapHeight;\nvarying vec4 vColor;\nvoid main()\n{\n\tvec4 pos = vec4(aPosition.x, uMapHeight-aPosition.y, aPosition.z, 1.0);\n\tgl_Position = uProjectionMat*uViewMat*uRegionMat*uFloorMat*uModelMat*pos;\n\tvColor = aColor;\n}\n",fshader:"precision mediump float;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_FragColor = vColor;\n}\n"},BasePhongProgram.prototype={constructor:BasePhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,36,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,36,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,36,24),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,0,e)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,36,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aColor,3,this.gl.FLOAT,!1,36,12),this.gl.enableVertexAttribArray(this.aColor),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,36,24),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},getProgram:function(){return this.program},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setLighting:function(t){this.gl.uniform1i(this.uLighting,t)},setMapHeight:function(t){this.gl.uniform1f(this.uMapHeight,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nattribute vec4 aColor;     \nuniform int    uLighting;  \nuniform float  uMapHeight; \nuniform mat4   uModelMat;  \nuniform mat4   uFloorMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec4   vColor;     \n                           \nvoid main(){               \n   vec4 tPos = vec4(aPosition.x, uMapHeight-aPosition.y, aPosition.z, 1.0);\n   mat4 modelViewMatrix = uViewMat*uRegionMat*uFloorMat*uModelMat;\n   if(1 == uLighting){\n       float shininess = 320.0;                                 \n       vec4 ambient, diffuse, specular;                        \n       vec4 ambientProduct = vec4(0.3, 0.3, 0.3, 1.0 );        \n       vec4 diffuseProduct = vec4(1.0, 1.0, 1.0, 1.0 );        \n       vec4 specularProduct= vec4(0.1, 0.1, 0.1, 1.0 );        \n                                                               \n       vec3 pos = (modelViewMatrix * tPos).xyz;                \n       vec3 L = normalize((uViewMat*uLightPos).xyz);           \n       vec3 E = -normalize(pos );                              \n       vec3 H = normalize(L + E );                             \n       vec3 N = normalize((uNormalMat*aNormal).xyz);           \n       ambient = ambientProduct;                               \n       float Kd = max( dot(L, N), 0.0 );                       \n       diffuse = Kd*diffuseProduct;                            \n       float Ks = pow(max(dot(N, H), 0.0), shininess);         \n       specular = Ks * specularProduct;                        \n       if(dot(L, N) < 0.0) {                                   \n           specular = vec4(0.0, 0.0, 0.0, 1.0);                \n       }                                                       \n       vColor = aColor*ambient+aColor*diffuse + aColor*specular;\n   }else{                                                  \n       vColor = aColor;                                    \n   }                                                       \n   gl_Position = uProjMat * modelViewMatrix * tPos;        \n}\n",fshader:"precision mediump float;                                   \nvarying vec4                   vColor;                     \nvoid main() {                                              \n       gl_FragColor = vColor;                              \n}\n"},RegionPhongProgram.prototype={constructor:RegionPhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.TRIANGLES,i,e-i)},drawLines:function(t,e,i){null!=i&&this.gl.lineWidth(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aNormal),this.gl.drawArrays(this.gl.LINES,0,e),null!=i&&this.gl.lineWidth(1)},setColor:function(t){this.gl.uniform4fv(this.uColor,t)},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nuniform vec4   uColor;     \nuniform mat4   uModelMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec4   vColor;     \n                           \nvoid main(){               \n   float shininess = 320.0;                                \n   vec4 ambient, diffuse, specular;                        \n   vec4 ambientProduct = vec4(0.5, 0.5, 0.5, 1.0 );        \n   vec4 diffuseProduct = vec4(1.0, 1.0, 1.0, 1.0 );        \n   vec4 specularProduct= vec4(0.2, 0.2, 0.2, 1.0 );        \n                                                           \n   mat4 modelViewMatrix = uViewMat*uRegionMat*uModelMat;   \n   vec3 pos = (modelViewMatrix * aPosition).xyz;           \n   vec3 L = normalize((uViewMat*uLightPos).xyz);           \n   vec3 E = -normalize(pos );                              \n   vec3 H = normalize(L + E );                             \n   vec3 N = normalize((uNormalMat*aNormal).xyz);           \n   ambient = ambientProduct;                               \n   float Kd = max( dot(L, N), 0.0 );                       \n   diffuse = Kd*diffuseProduct;                            \n   float Ks = pow(max(dot(N, H), 0.0), shininess);         \n   specular = Ks * specularProduct;                        \n   if(dot(L, N) < 0.0) {                                   \n       specular = vec4(0.0, 0.0, 0.0, 1.0);                \n   }                                                       \n   gl_Position = uProjMat * modelViewMatrix * aPosition;   \n   vColor = uColor*ambient+uColor*diffuse+uColor*specular; \n}\n",fshader:"precision mediump float;                                   \nvarying vec4                   vColor;                     \nvoid main() {                                              \n       gl_FragColor = vColor;                              \n}\n"},SelectColorProgram.prototype={constructor:SelectColorProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,r)},drawLines:function(t,e,i,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.LINES,0,r)},getProgram:function(){return this.program},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nuniform vec4 uColor;\nuniform mat4 uModelMat;\nuniform mat4 uRegionMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_Position = uProjectionMat*uViewMat*uRegionMat*uModelMat*aPosition;\n\tvColor = uColor;\n}\n",fshader:"precision mediump float;\nvarying vec4 vColor;\nvoid main()\n{\n\tgl_FragColor = vColor;\n}\n"},BillboardIconProgram.prototype={constructor:BillboardIconProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aTexCoord,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,i,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setIViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uiViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nattribute vec3  aTexCoord; \nvarying vec3 vTexCoord;    \nuniform mat4   uModelMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uiViewMat;  \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nvoid main( void ) {                            \n    vTexCoord = aTexCoord;                     \n    gl_Position = uProjMat*uViewMat*uRegionMat*uModelMat*uiViewMat*aPosition;\n}\n",fshader:"precision mediump float;                       \nvarying vec3 vTexCoord;                        \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);  \n}\n"},Marker2DProgram.prototype={constructor:Marker2DProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawTriangles:function(t,e,i){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,24,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.vertexAttribPointer(this.aTexCoord,3,this.gl.FLOAT,!1,24,12),this.gl.enableVertexAttribArray(this.aTexCoord),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.TRIANGLES,i,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nattribute vec3  aTexCoord; \nuniform mat4   uModelMat;  \nuniform mat4   uProjMat;   \nvarying vec3   vTexCoord;  \nvoid main( void ) {                            \n    vTexCoord = aTexCoord;                     \n    gl_Position = uProjMat*uModelMat*aPosition;\n}\n",fshader:"precision mediump float;                       \nvarying vec3 vTexCoord;                        \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, vTexCoord.xy);  \n}\n"},Color2DProgram.prototype={constructor:Color2DProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e,i,r){this.gl.uniform4fv(this.uColor,YFM.Math.flatten(e)),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,r)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;\nuniform mat4   uModelMat;\nuniform mat4   uProjMat;\nuniform vec4   uColor;\nvarying vec4   vColor;\nvoid main( void ) {                            \n    gl_Position = uProjMat*uModelMat*aPosition;\n    vColor = uColor;                           \n}\n",fshader:"precision mediump float;                       \nvarying vec4   vColor;                         \nvoid main() {                                  \n   gl_FragColor = vColor;                      \n}\n"},PointSpiritProgram.prototype={constructor:PointSpiritProgram,useProgram:function(){this.gl.useProgram(this.program)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},drawPoints:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.drawArrays(this.gl.POINTS,0,e),this.gl.disable(this.gl.BLEND)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4  aPosition; \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nvoid main( void ) {                            \n    gl_Position = uProjMat*uViewMat*uRegionMat*aPosition;\n    gl_PointSize = 24.0;                        \n}\n",fshader:"precision mediump float;                       \nuniform sampler2D uTex;                        \nvoid main() {                                  \n   gl_FragColor = texture2D(uTex, gl_PointCoord);\n}\n"},RawPanoramaProgram.prototype={constructor:RawPanoramaProgram,useProgram:function(){this.gl.useProgram(this.program)},drawTriangles:function(t,e){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.TRIANGLES,0,e)},getProgram:function(){return this.program},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTexMap,0),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,t)},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute  vec4 aPosition;\nuniform mat4 uModelMat;\nuniform mat4 uViewMat;\nuniform mat4 uProjectionMat;\nvarying vec3 V;\nvoid main()\n{\n\tgl_Position = uProjectionMat*uViewMat*uModelMat*aPosition;\n   V = normalize(vec3(aPosition.x, aPosition.y, aPosition.z));\n}\n",fshader:"precision mediump float;\nuniform samplerCube uTexMap;\nvarying vec3 V;\nvoid main()\n{\n\tgl_FragColor = textureCube(uTexMap, V);\n}\n"},ModelPhongProgram.prototype={constructor:ModelPhongProgram,useProgram:function(){this.gl.useProgram(this.program)},drawLines:function(t,e,i,r){this.gl.uniform1f(this.uNs,this.defaultNs),this.gl.uniform4fv(this.uKa,this.defaultKa),this.gl.uniform4fv(this.uKd,this.defaultKd),this.gl.uniform4fv(this.uKs,this.defaultKs),this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,e),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!0,12,i),this.gl.enableVertexAttribArray(this.aPosition),this.gl.drawArrays(this.gl.LINES,0,r)},drawTriangles:function(t){var e,i,r;e=t.getAttribute("position"),i=t.getAttribute("normal"),r=t.getAttribute("uv"),null!==e?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e.vbo),this.gl.vertexAttribPointer(this.aPosition,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aPosition)):this.gl.disableVertexAttribArray(this.aPosition),null!=i?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,i.vbo),this.gl.vertexAttribPointer(this.aNormal,3,this.gl.FLOAT,!1,12,0),this.gl.enableVertexAttribArray(this.aNormal)):this.gl.disableVertexAttribArray(this.aNormal),null!=r?(this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.vbo),this.gl.vertexAttribPointer(this.aTexCoord,2,this.gl.FLOAT,!1,8,0),this.gl.enableVertexAttribArray(this.aTexCoord)):this.gl.disableVertexAttribArray(this.aTexCoord),this.gl.drawArrays(this.gl.TRIANGLES,0,e.length)},setTexFlag:function(t){this.gl.uniform1i(this.uTexFlag,t)},bindTexture:function(t){this.gl.activeTexture(this.gl.TEXTURE0),this.gl.uniform1i(this.uTex,0),this.gl.bindTexture(this.gl.TEXTURE_2D,t)},setMTL:function(t,e){if(this.gl.uniform1f(this.uNs,t.getNs()),this.gl.uniform4fv(this.uKa,YFM.Math.flatten(t.getKa())),this.gl.uniform4fv(this.uKd,YFM.Math.flatten(t.getKd())),this.gl.uniform4fv(this.uKs,YFM.Math.flatten(t.getKs())),null!==t.getMapKd()){var i=e.getTexture(t.getMapKd());if(null!=i)return this.gl.uniform1i(this.uTexFlag,1),this.gl.uniform1i(this.uColorFlag,0),void this.bindTexture(i.tex)}this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,this.defaultColor)},setDefaultMTL:function(){this.gl.uniform1f(this.uNs,this.defaultNs),this.gl.uniform4fv(this.uKa,this.defaultKa),this.gl.uniform4fv(this.uKd,this.defaultKd),this.gl.uniform4fv(this.uKs,this.defaultKs),this.gl.uniform1i(this.uTexFlag,0),this.gl.uniform1i(this.uColorFlag,1),this.gl.uniform4fv(this.uColor,this.defaultColor)},setColorFlag:function(t){this.gl.uniform1i(this.uColorFlag,t)},setColor:function(t){this.gl.uniform4fv(this.uColor,t)},setLightPos:function(t){this.gl.uniform4fv(this.uLightPos,t)},setNormalMatrix:function(t){this.gl.uniformMatrix4fv(this.uNormalMat,!1,YFM.Math.flatten(t))},setProjectionMatrix:function(t){this.gl.uniformMatrix4fv(this.uProjectionMat,!1,YFM.Math.flatten(t))},setViewMatrix:function(t){this.gl.uniformMatrix4fv(this.uViewMat,!1,YFM.Math.flatten(t))},setRegionMatrix:function(t){this.gl.uniformMatrix4fv(this.uRegionMat,!1,YFM.Math.flatten(t))},setFloorMatrix:function(t){this.gl.uniformMatrix4fv(this.uFloorMat,!1,YFM.Math.flatten(t))},setModelMatrix:function(t){this.gl.uniformMatrix4fv(this.uModelMat,!1,YFM.Math.flatten(t))},vshader:"attribute vec4 aPosition;  \nattribute vec4 aNormal;    \nattribute vec3 aTexCoord;  \nuniform int    uTexFlag;   \nuniform float  uNs;        \nuniform vec4   uKa;        \nuniform vec4   uKd;        \nuniform vec4   uKs;        \nuniform mat4   uModelMat;  \nuniform mat4   uFloorMat;  \nuniform mat4   uRegionMat; \nuniform mat4   uViewMat;   \nuniform mat4   uProjMat;   \nuniform mat4   uNormalMat; \nuniform vec4   uLightPos;  \nvarying vec3   vTexCoord;  \nvarying vec4   vAmbient;   \nvarying vec4   vDiffuse;   \nvarying vec4   vSpecular;  \n                           \nvoid main(){               \n   mat4 modelViewMatrix = uViewMat*uRegionMat*uFloorMat*uModelMat;\n   vec3 pos = (modelViewMatrix * aPosition).xyz;           \n   vec3 L = normalize((uViewMat*uLightPos).xyz);           \n   vec3 E = -normalize(pos );                              \n   vec3 H = normalize(L + E );                             \n   vec3 N = normalize((uNormalMat*aNormal).xyz);           \n   vAmbient = uKa;                                         \n   vDiffuse = max(dot(L,N), 0.0)*uKd;                      \n   vec4 specular = pow(max(dot(N, H), 0.0), uNs)*uKs;      \n   if(dot(L, N) < 0.0) {                                   \n       specular = vec4(0.0, 0.0, 0.0, 1.0);                \n   }                                                       \n   vSpecular = specular;                                   \n   if(1 == uTexFlag)                                       \n       vTexCoord = aTexCoord;                              \n   else                                                    \n       vTexCoord = vec3(0.0, 0.0, 0.0);                    \n   gl_Position = uProjMat * modelViewMatrix * aPosition;   \n}\n",fshader:"precision mediump float;       \nuniform int        uColorFlag; \nuniform vec4       uColor;     \nuniform sampler2D  uTex;       \nvarying vec3       vTexCoord;  \nvarying vec4       vAmbient;   \nvarying vec4       vDiffuse;   \nvarying vec4       vSpecular;  \nvoid main() {                  \n       vec4 color;                                                     \n       if(1 == uColorFlag)                                             \n           color = uColor;                                             \n       else                                                            \n           color = texture2D(uTex, vTexCoord.xy);                      \n       gl_FragColor = color*vAmbient+color*vDiffuse+color*vSpecular;   \n}\n"},DeviceOrientationCamera.prototype={constructor:DeviceOrientationCamera,DEFAULT_PITCH:-30,setPerspective:function(t,e,i,r){this.mat_projection=YFM.Math.Matrix.perspective(t,e,i,r),this.dirty=!0},setOrthographic:function(t,e,i,r,s,o){this.mat_projection=YFM.Math.Matrix.orthographic(t,e,i,r,s,o),this.dirty=!0},getProjectionMat:function(){return this.mat_projection},getProjectionMatWithLDS:function(t,e){var i=YFM.Math.Matrix.matClone(this.mat_projection),r=LDS.halton(2,this.ldsIndex),s=LDS.halton(3,this.ldsIndex);return i[8]+=(r-.5)/t,i[9]+=(s-.5)/e,this.ldsIndex+=1,this.ldsIndex>this.ldsN&&(this.ldsIndex=0),i},getProjectionMatWithRGSS:function(t,e,i){var r=YFM.Math.Matrix.matClone(this.mat_projection),s=this.rgss[t][0],o=this.rgss[t][1];return r[8]+=(2*s-1)/e,r[9]+=(2*o-1)/i,r},getPVMat:function(){return this.dirty&&this._updateViewMat(),this.mat_pv},getIPVMat:function(){return this.dirty&&this._updateViewMat(),this.mat_ipv},getViewMat:function(){return this.dirty&&this._updateViewMat(),this.mat_view},getRoll:function(){return this.roll},getPitch:function(){return this.pitch},setPitch:function(t){this.pitch=t,this.dirty=!0},getEyePos:function(){return this.eyePos},getLookAt:function(){return YFM.Math.Vector.vecClone(this.lookAt)},getAzimuth:function(){var t=YFM.Math.Matrix.rotationFromQuaternion(this.quaternion);return-YFM.Math.Matrix.eulerParamExtractZ(t)},setAzimuth:function(t){this.quaternion.setFromAxisAngle(this.zee,t),this.dirty=!0},setLookAtAzimuth:function(t,e,i,r){this.quaternion.setFromAxisAngle(this.zee,t),this.lookAt[0]=e,this.lookAt[1]=i,this.lookAt[2]=r,this.dirty=!0},setLookAt:function(t,e,i){this.lookAt[0]=t,this.lookAt[1]=e,this.lookAt[2]=i,this.dirty=!0},getLookAt:function(){return YFM.Math.Vector.vecClone(this.lookAt)},getLookOffset:function(){return YFM.Math.Vector.vecClone(this.lookOffset)},getLookOffsetNormal:function(){return this.lookOffset[2]},setLookOffset:function(t,e,i){this.lookOffset[0]=t,this.lookOffset[1]=e,this.lookOffset[2]=i,this.dirty=!0},resetLookOffsetTan:function(){this.lookOffset[0]=0,this.lookOffset[1]=0,this.dirty=!0},_updaeQuaternion:function(){if(!1!==this.enabled&&null!=this.deviceOrientation){var t=YFM.Math.deg2Radian,e=this.deviceOrientation.alpha?t(this.deviceOrientation.alpha)+this.alphaOffsetAngle:0,i=this.deviceOrientation.beta?t(this.deviceOrientation.beta):0,r=this.deviceOrientation.gamma?t(this.deviceOrientation.gamma):0,s=this.screenOrientation?t(this.screenOrientation):0,o=new Euler(i,e,-r,"YXZ");this.q2.setFromAxisAngle(this.zee,-s),this.quaternion.setFromEuler(o),this.quaternion.premultiply(this.q0),this.quaternion.multiply(this.q1),this.quaternion.multiply(this.q2),this.roll=this.deviceOrientation.gamma?this.deviceOrientation.gamma:0}},_updateViewMat:function(){this._updaeQuaternion();var t=YFM.Math.Matrix.rotationFromQuaternion(this.quaternion),e=YFM.Math.Matrix.mulVec(t,this.lookAt);t=YFM.Math.Matrix.postTranslate(t,-e[0],-e[1],-e[2]);var i=YFM.Math.Matrix.translate(this.lookOffset[0],this.lookOffset[1],this.lookOffset[2]);if(this.pitchEnable){var r=YFM.Math.Matrix.rotate3d(this.pitch,1,0,0);this.mat_view=YFM.Math.Matrix.mul(i,YFM.Math.Matrix.mul(r,t))}else this.mat_view=YFM.Math.Matrix.mul(i,t);this.mat_pv=YFM.Math.Matrix.mul(this.mat_projection,this.mat_view),this.mat_ipv=YFM.Math.Matrix.invert(this.mat_pv),this.dirty=!1}},TexturePool.prototype={
constructor:TexturePool,addTexture:function(t,e){if(null!=this.pool[t])return!1;var i=new Image,r=new TextureWrap(t,e,i),s=this;i.onload=function(){s._handleTextureLoaded(r)},i.src=e},getTexture:function(t){var e=this.pool[t];return null!=e?{tex:e.tex,w:e.w,h:e.h}:null},_handleTextureLoaded:function(t){this.pool[t.name]=t;var e=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.img),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null),t.tex=e,t.w=t.img.width,t.h=t.img.height,delete t.img}};